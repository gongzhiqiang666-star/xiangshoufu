# 恒信通 - API推送接口文档

> 文档来源：恒信通-20251222-API推送接口文档.docx
> 最后更新：2025-12-22

---

## 1. 协议规则

| 项目 | 说明 |
|------|------|
| 传输方式 | 采用HTTP传输 |
| 提交方式 | 采用POST方法提交 |
| 数据格式 | 提交和返回数据都为JSON |
| 字符编码 | 统一采用UTF-8字符编码 |
| 签名算法 | RSA |
| 签名/加密要求 | 详见签名说明 |
| 异步通知返回参数 | `success` |

---

## 2. 对接说明

### 2.1 签名

使用RSA签名算法进行签名验证。

### 2.2 接入说明

1. 咨询商务人员获取**验签公钥**
2. 报备**回调地址**
3. 配置**IP白名单**
4. 接口返回 `{"code":0}` 为接收成功

---

## 3. 消息通知

### 3.1 商户入网通知 (merc_income)

**action**: `merc_income`

商户入网成功后推送商户信息。

#### 通知参数

| 字段名称 | 字段类型 | 格式 | 备注 |
|---------|---------|------|------|
| action | String | | 固定值 `merc_income` |
| sign | String | | 签名 |
| brandCode | String | | 品牌编号 |
| tusn | String | | 机具号 |
| merchantNo | String | | 商户号 |
| approveStatus | String | | 商户入网审核状态：1-审核中 2-审核通过 3-审核失败 4-商户停用 |
| bindStatus | String | | 机具绑定状态：0-未绑定 1-已绑定 |
| posBusinessActive | String | | POS业务开通状态：1-成功 2-失败 |
| legalName | String | | 法人姓名 |
| legalNo | String | | 法人身份证 |
| idCardStartDate | String | | 法人身份证有效期开始时间 |
| idCardEndDate | String | | 法人身份证有效期结束时间 |
| idCardFrontUrl | String | | 法人身份证正面 |
| idCardBackUrl | String | | 法人身份证反面 |
| settleCardNo | String | | 结算卡号 |
| settleBankName | String | | 结算卡开户行 |
| settleCardUrl | String | | 结算卡照片 |
| districtCode | String | | 经营地区 |
| address | String | | 详细地址 |
| mcc | String | | MCC码 |
| creditCardFeeRate | String | | 贷记卡费率 |
| debitCardFeeRate | String | | 借记卡费率 |
| debitCardFeeMax | String | | 借记卡封顶 |
| alipayFeeRate | String | | 支付宝费率 |
| cloudCreditFeeRate | String | | 云闪付贷记卡费率 |
| wxPayFeeRate | String | | 微信费率 |
| jdPayFeeRate | String | | 京东白条费率 |

---

### 3.2 商户终端绑定/解绑通知 (sn_bind)

**action**: `sn_bind`

商户终端绑定或解绑时推送通知。

#### 通知参数

| 字段名称 | 字段类型 | 格式 | 备注 |
|---------|---------|------|------|
| action | String | | 固定值 `sn_bind` |
| sign | String | | 签名 |
| brandCode | String | | 品牌编号 |
| tusn | String | | 机具号 |
| agentId | String | | 代理商ID |
| status | String | | 绑定状态：1-绑定成功 2-解绑成功 |
| merchantNo | String | | 商户号 |

---

### 3.3 流量费/服务费扣费成功通知 (sn_device_fee)

**action**: `sn_device_fee`

流量费或服务费扣费成功时推送通知。

#### 通知参数

| 字段名称 | 字段类型 | 格式 | 备注 |
|---------|---------|------|------|
| action | String | | 固定值 `sn_device_fee` |
| sign | String | | 签名 |
| brandCode | String | | 品牌编号 |
| tusn | String | | 机具号 |
| merchantNo | String | | 商户号 |
| agentId | String | | 代理商ID |
| chargingAmount | String | | 扣费金额（分） |
| type | String | | 1-服务费 2-通讯费 |
| orderNo | String | | 外部订单号 |
| chargingTime | String | yyyy-MM-dd HH:mm:ss | 扣款时间 |

---

### 3.4 交易回调 (pos_order)

**action**: `pos_order`

交易成功后推送交易信息。

#### 通知参数

| 字段名称 | 字段类型 | 格式 | 备注 |
|---------|---------|------|------|
| action | String | | 固定值 `pos_order` |
| sign | String | | 签名 |
| brandCode | String | | 品牌编号 |
| tusn | String | | 机具号 |
| transTime | String | yyyy-MM-dd HH:mm:ss | 交易时间 |
| orderNo | String | | 订单号 |
| transCardType | String | | 交易卡类型（见下表） |
| cardNo | String | | 卡号 |
| amount | String | | 交易金额（**分**） |
| transactionFee | String | | 交易费率（%） |
| feeExt | String | | D0手续费（分） |
| merchantNo | String | | 商户号 |
| agentId | String | | 代理商ID |
| highRate | String | | 调价费率（%） |

#### 交易卡类型 (transCardType)

| 值 | 说明 |
|----|------|
| 00 | 借记卡 |
| 01 | 贷记卡 |
| 061 | 微信支付 |
| 062 | 支付宝支付 |
| 063 | 银联支付 |
| 065 | 苹果支付 |

---

### 3.5 商户费率修改回调 (merc_rate_update)

**action**: `merc_rate_update`

商户费率修改后推送通知。

#### 通知参数

| 字段名称 | 字段类型 | 格式 | 备注 |
|---------|---------|------|------|
| action | String | | 固定值 `merc_rate_update` |
| sign | String | | 签名 |
| brandCode | String | | 品牌编号 |
| tusn | String | | 机具号 |
| merchantNo | String | | 商户号 |
| creditCardFeeRate | String | | 贷记卡费率（%） |
| creditCardExtraRate | String | | 贷记卡额外费率（%） |
| debitCardFeeRate | String | | 借记卡费率（%） |
| alipayFeeRate | String | | 支付宝费率（%） |
| unionpayPayFeeRate | String | | 银联费率（%） |
| wxPayFeeRate | String | | 微信费率（%） |
| creditAdditionFeeRate | String | | 贷记卡调价费率（%） |
| unionpayAdditionFeeRate | String | | 银联调价费率（%） |
| alipayAdditionFeeRate | String | | 支付宝调价费率（%） |
| wxAdditionFeeRate | String | | 微信调价费率（%） |
| agentId | String | | 代理商ID |

---

## 4. 回调类型汇总

| action | 回调类型 | 说明 |
|--------|---------|------|
| `merc_income` | 商户入网通知 | 商户入网审核状态变更 |
| `sn_bind` | 终端绑定/解绑通知 | 机具绑定或解绑商户 |
| `sn_device_fee` | 流量费/服务费通知 | 扣费成功通知 |
| `pos_order` | 交易回调 | 交易成功通知 |
| `merc_rate_update` | 费率修改回调 | 商户费率变更通知 |

---

## 5. 与联动支付对比

| 对比项 | 恒信通 | 联动支付 |
|--------|--------|---------|
| 通道编码 | HENGXINTONG | LIANDONG |
| 加密方式 | RSA签名验证 | RSA+AES混合加密 |
| 签名算法 | RSA | SHA256WithRSA |
| 通知响应 | 返回 `{"code":0}` | 返回 `OK` |
| 回调区分字段 | `action` | `serviceType` |
| 金额单位 | **分** | **元** |
| 交易通知 | pos_order | PAY_ORDER_NOTIFY |
| 终端绑定通知 | sn_bind | MATERIAL_BIND_STATUS_NOTIFY |
| 商户入网通知 | merc_income | CUSTOMER_INFO_REGISTER_NOTIFY |
| 费率变更通知 | merc_rate_update | CUSTOMER_LAST_RATE_NOTIFY |
| 流量费通知 | sn_device_fee | 止付类型字段(stopPayType=SIM) |

---

## 6. 适配器实现要点

### 6.1 关键字段映射（交易回调）

| 恒信通字段 | 统一字段 | 说明 |
|-----------|---------|------|
| orderNo | order_no | 订单号 |
| tusn | terminal_no | 终端号 |
| merchantNo | merchant_no | 商户号 |
| agentId | agent_id | 代理商ID |
| transTime | trans_time | 交易时间 |
| amount | amount | 金额（已是分） |
| transCardType | card_type | 卡类型 |
| transactionFee | fee_rate | 费率 |
| action | - | 回调类型标识 |

### 6.2 签名验证

```go
func (a *HengxintongAdapter) VerifySign(rawBody []byte) (bool, error) {
    // 1. 解析JSON获取sign字段
    // 2. 移除sign字段，按字典序排列其他字段
    // 3. 使用平台公钥 + RSA 验签
    return verified, nil
}
```

### 6.3 响应格式

```go
func (a *HengxintongAdapter) BuildResponse(success bool) string {
    if success {
        return `{"code":0}`  // 恒信通要求返回JSON
    }
    return `{"code":1}`
}
```
