# 整体操作流程：
        开代理-设置政策（结算价） - 下发机具 - 装机（流量卡-押金-费率） - 产生交易- 分润、押金奖励、流量费奖励、活动奖励等


# 分润概念
    → 支持多种分润模式，核心规则是第一级代理会给一个利率，例如万分之51，一级代理要发展他的子代理或者代理团队，会给他的子
    代理万分之55，以此类推，整个机构类似于一个多叉树结构，大家都在上一级的基础上增加利率，上限是最终给到商户的利润，例如
    是万分之60。代理商可以自己开发商户，也可以继续发展子代理团队，代理商开发商户后，会给商户一个POS机，这里叫机具，机具和
    商户绑定，商户通过机具消费后，产生流水，流水会通过WEBAPI推送回我们数据库中，我们通过对流水的实时计算，算出该消费机具
    对应代理商该得的分润，以及他的上一级代理商该得的分润，上上级代理商该得的分润，直至没有利润，理解商就是从当前代理商这
    一级一直往上溯源，将这一条树叶一直追溯到主干，每一级别该得的分润计算出来，显示到APP上。
    ● 分润的结算周期是怎样的？
    → 交易完成后，收到POS机厂商传过来的交易流水，立即计算出各个代理商该得的分润，这部分钱先到钱包里
    ● 分润最多向上追溯几级代理？
    → 不限层级，直至没有利润为止
    
    是要按照代理的层及结构、利差计算各级代理商该得的利润。
    所有分润都不考虑退费部分，退费部分如果有单独计算分润。

# 通道概念
    我们作为第四方支付公司， 需要对接第三方支付公司，例如拉卡拉公司，机具和交易流水、消息通知、商户维护等都需要和这种第三方公司做接口。
    我们预计会对接8家支付公司，也叫通道或者支付通道，APP很多功能也要基于通道去做维护。


# 返现概念
    达到一定条件返回给直属代理商固定金额的钱，例如流量费分首次、二次、二加N次约定返现金额，押金约定返现金额等。

# 政策模板概念
    指的分润、奖励、押金、服务费的计算规则，每个代理商注册后，启用前都要设置政策模版，否则无法下发机具。

# 结算价概念
    给代理商的最终价格，内容和政策模板相同，但可以基于政策模板的内容进行调整，确定该代理商的最终结算价。

# 功能模块
## 代理拓展
    作为APP端的独立模块，主要用来拓展服务商使用，包括主动注册和被动注册
        主动注册就是使用拓展码（二维码）展示、可保存相册、可复制链接给下级代理商，推介码用手机号？ 
        被动注册就是手动填写下级代理商信息验证通过后成为代理商，下级代理商根据二维码下载应用后登录使用。
    
    注册后使用默认政策模板，具体参考政策模板
    机构树说明：
        总部
        机构（字母加手机号）一级代理商叫
        他的下面叫直属代理商（B端）、直营客户（C端）
        再往下下级代理商

    背景说明：这块操作会产生代理商的上下级关系，后期分润就是按这个关系进行分润的，当然上级代理商的政策模版自动带入下级代理商中，或者叫继承政策模版，当然上下级的费率是不同的，这个在代理管理中有体现。

### 代理拓展功能实现（代码实现）

1. **邀请码注册流程**
   - 公开注册接口：`POST /api/v1/auth/register`（无需认证）
   - 注册参数：邀请码、代理商名称、联系人、手机号、密码
   - 注册后状态：待审核（status=3），需上级审核通过后才能使用
   - 邀请链接格式：`https://m.xiangshoufu.com/register?code={invite_code}`（H5注册页面，包含APP下载地址）

2. **二维码生成**
   - 基于邀请链接自动生成二维码图片
   - 使用go-qrcode库生成PNG格式
   - 存储到静态文件目录，返回可访问URL
   - API接口：`GET /api/v1/agents/invite-code` 返回邀请码和二维码URL

3. **政策继承逻辑**
   - 新代理商注册/创建时，自动继承上级的政策模板
   - 复制上级的AgentPolicy记录到新代理商
   - 政策状态设为"待调整"，上级需调整费率后审核通过
   - 上级可以在下级政策基础上调整利差

4. **APP端功能**
   - 代理拓展主页面：展示二维码、邀请码、分享操作
   - 团队管理Tab：显示团队统计、直属代理商列表
   - 代理商详情页：展示基本信息、团队数据、结算信息
   - 保存二维码：下载二维码图片并保存到手机相册
   - 分享功能：支持微信、朋友圈、复制链接等多种分享方式

5. **PC端功能**
   - 代理商列表：查看所有代理商及其状态
   - 政策分配：为代理商选择通道和政策模板，设置费率
   - 代理商详情：查看完整信息、邀请码、团队统计

6. **API接口**
   | 接口 | 说明 |
   |------|------|
   | POST /api/v1/auth/register | 公开注册（通过邀请码） |
   | GET /api/v1/agents/invite-code | 获取邀请码和二维码 |
   | PUT /api/v1/agents/invite-code | 自定义邀请码/靓号 |
   | GET /api/v1/agents/subordinates | 获取下级代理商列表 |
   | GET /api/v1/agents/:id | 获取代理商详情 |
   | GET /api/v1/agents/:id/team-stats | 获取团队统计 |
   | POST /api/v1/agents/:id/policies | 为代理商分配政策 |
   | GET /api/v1/channels | 获取所有可用通道列表 |

## 营销海报
    营销海报作为APP的独立模块，主要是用来发微信朋友圈、发抖音使用；数据由后台导入，导入后APP端可以保存到本地，以供发朋友圈使用。
    可以增加分类，不同分类下维护不同的海报信息，APP和这个海报信息同步
    要注意控制大小，否则影响服务器。

### 营销海报功能实现（代码实现）

1. **数据模型**
   - `poster_categories` 表：海报分类，包含名称、排序、状态
   - `posters` 表：海报信息，包含标题、分类ID、原图URL、缩略图URL、描述、尺寸、下载/分享次数

2. **PC端管理功能**
   - 分类管理：新增/编辑/删除分类，排序调整
   - 海报管理：新增/编辑/删除海报，支持批量导入
   - 图片上传：自动压缩（质量85%），自动生成缩略图（宽300px）
   - 文件限制：最大5MB，支持JPG/PNG/WebP格式

3. **APP端展示功能**
   - 分类Tab切换：显示各分类及海报数量
   - 网格展示：2列布局，显示缩略图和标题
   - 详情页：双指缩放预览原图
   - 保存到相册：使用image_gallery_saver包
   - 分享功能：使用share_plus包分享到微信/抖音

4. **API接口**
   | 接口 | 说明 |
   |------|------|
   | GET /api/v1/posters/categories | APP获取分类列表（含数量） |
   | GET /api/v1/posters | APP获取海报列表（支持分类筛选、分页） |
   | GET /api/v1/posters/:id | APP获取海报详情 |
   | POST /api/v1/posters/:id/download | 记录下载次数 |
   | POST /api/v1/posters/:id/share | 记录分享次数 |

## 滚动图
    滚动图用来在APP端首页做宣传使用，需要在PC端维护。

### 滚动图功能实现（代码实现）

1. **数据模型**
   - `banners` 表：滚动图信息
   - 字段：标题、图片URL、链接类型（0无链接/1内部页面/2外部链接）、跳转链接、排序、状态、展示时间范围、点击次数

2. **PC端管理功能**
   - Banner列表：状态筛选、分页展示
   - 新增/编辑：上传图片、设置链接、设置展示时间范围
   - 状态切换：启用/禁用开关
   - 批量排序：拖拽调整顺序
   - 图片限制：最大2MB，建议尺寸750x400px

3. **APP端展示功能**
   - 首页集成：BannerCarousel组件已集成到首页（home_page.dart）
   - 轮播组件：使用carousel_slider包，高度140px
   - 自动播放：5秒间隔，多于1张时自动轮播
   - 指示器：底部圆点指示当前位置，当前项宽度20px
   - 图片加载：使用cached_network_image缓存网络图片
   - 点击跳转：内部页面使用go_router跳转，外部链接使用url_launcher打开浏览器
   - 点击统计：异步记录点击次数
   - 占位显示：加载中或无数据时显示灰色占位图

4. **有效性判断**
   - 状态为启用（status=1）
   - 当前时间在展示时间范围内（start_time和end_time）
   - 未设置时间范围则长期有效

5. **API接口**
   | 接口 | 说明 |
   |------|------|
   | GET /api/v1/banners | APP获取有效Banner列表 |
   | POST /api/v1/banners/:id/click | 记录点击次数 |


	
## 政策模版
     
    政策模版按照通道区分，每个通道都有很多政策模版，给代理商启用时设置好。
    代理商可以用那些通道也要启用时设置好，APP端只显示已开通的通道。
    模板分4块，PC端和手机端维护都按这个维护。

    1.成本 - 按通道设定当前代理商的利率，通道方会给我们贷记卡的结算、借记卡（包括封顶结算）的结算、银联云闪付结算、微信扫码结算、支付宝扫码结算； 这部分钱进入分润钱包
    2.押金返现     钱进入服务费钱包
    3.流量卡返现（首次、二次、二加N次)  交易记录里会提现是首次还是二次，不需要单独计算。 钱进入服务费钱包； 举例子：流量卡79、商户扣取流量卡成功（通过交易数据返回），返代理商69，我自己留10块。设置上分首次、2次、2+N次返给代理商多少钱。不同通道不同配置。
    4.奖励返现(按入网时间、按时间段设置交易量，满足就奖励多少)  钱进入奖励钱包
    注意前提：
        a.充值钱包在PC端开通后。
        b.奖励返现这个政策一旦维护设置生效时间，一旦生效，和充值钱包有没有钱没关系，奖励达到条件就要计算，钱进入奖励钱包。
        例如商户入网交易量超过10000，例如0到30天奖励600，30到60天奖励200；这部分钱到了奖励的接点就划入奖励钱包。

    注意：激活奖励的两种形式：
        a. 自动激活奖励：系统根据商户达成条件自动发放，按级差分润，资金由系统产生，入奖励钱包。
        b. 手动奖励发放：上级从充值钱包给直属下级发放，资金从充值钱包扣除，入下级奖励钱包。

    以上4个合计叫政策模版，都要按级差分润，具体参考分润的逻辑。

    给代理商启用政策模版后，代理商可以自己给下级修改政策，修改后就形成最终的结算价。

    要求政策模版PC端维护、给代理商分配政策模板也在PC端、分配后代理商可以在APP端可以给下级调整政策模版（成本、押金返现、流量卡放心啊、奖励活动）。

    分润的逻辑上面讲了，这里举个例子：例如我们给代理商的利率是51，最终代理商拓展出的商户给到的是60，那代理商每消费10000块，代理商就会有9个点的利润，也就是9块的利润；而他的上级利率是49，那他的上级也能拿2块，如果上级还有上级，并且有级差和利差，那还要继续分润，直至没有利润。
    换个角度：每个级别的代理商都有一个固定利率，这个利率是在政策模板中维护好的，每增加一级代理商，利率会递增，这叫利差，大家都有钱赚才是王道。
    最终的分润也是按照约定的利差拿到自己应该获得的利润，当然子代理也可以和上级利率一样，那后期这部分利润是要给到下级代理商的，上级是没有分润的，钱留在了离客户最近的一级（取下原则）。

    所以一笔交易过来，要分4部分计算，每个代理商对应每个通道的政策模板都分这四部分：
        1.分润	和各通道交易数据联动做结算，依照各代理商的政策模版（结算价）进行分润
        2.奖励	按照奖励的政策模版进行奖励。奖励金额进行分润。
        3.押金	涉及返现， 通道告诉我们手机299，我们设置部分返现给代理商：0到299 的一个范围，具体多少要按照通道的要求走，每个通道不一样；例如机具49一台，交易流水中收到该卡机的押金后，要给该代理上返现。返现后各级相关代理商分润
        4.流量费 涉及返现，具体多少要按照通道的要求走，每个通道不一样。交易流水中收到该卡机的流量费后并且告知时第几次收取流量费，按照政策模版算出返现金额，然后正常各级代理商进行分润。

    PC和APP端都要按此逻辑调整设置，后端要按照模版设置准确计算分润、钱包等功能。

## 代理管理
    
    1.代理商分配政策模版
        PC端给代理设置模版。
        代理商可以在APP上看到默认的政策模版，也可以分别调整成本、押金、流量卡和奖励的设置。
        成本、押金、流量卡分别按照通道维护，一个通道一套，直接放到一起维护就好。
        成本：费率可以实时修改，调用通道接口，实时生效，可以随时调整（个别通道不开放、结合接口文档）。
    2.代理商调价：
        分两种情况：
        ①以商户入网时间为条件：入网0-180天，费率涨多少；入网181-360天，费率涨多少；入网361-540天，费率涨多大；入网541天以上，费率涨多少 
        ②以代理商开后台时间为条件：代理商入网0-360天，结算价多少；代理商入网361-540天，结算价多少；代理商入网541天以上，结算价多少(天数自定义)

    代理商就可以找商家推广
    机具下发前设置押金、流量费、利率。
    我们设置好后直接通过推给商户，商户交易时实时结算。
    机具切换时，流量卡和押金必须设置好，通过通道提供的接口推送到机具上，或者直接使用政策模板，下发默认的政策。
    
    所有分润暂时不考虑退费部分，退费部分如果有单独计算分润。

    手动调账功能，PC后台管理功能，可以自定义对代理商的分润进行调整。

    3.服务商偷数据权限（是否下放权限）：根据金额区间、根据时间段生效（暂时不做）
    4.显示代理设备数量（已激活，未激活），代理注册时间，
    5.支付通道可隐藏
    整体：我们给代理商制定游戏规则，规则是根据通道方给我们推回来的数据，我们根据交易流水、根据我们和代理商制定的政策（涉及返现、分润、奖金），计算分润喉存入代理商钱包中。


## 终端管理
    操作 机具下发、机具回拨、机具政策设置、操作记录（显示通道、押金、状态）

    机具下发 - 领走机具（绑定代理商），到时候绑定商户、设置费率、押金奖励、流量费奖励等，必须一级一级下发。
    机具回拨（未激活的才能回拨） - 退货，谁领的退给谁，不可跨级，也是一级一级回收

    机具下发绑定代代理商，代理商最终绑定商户，此时代理商在我们系统叫直营，往上推就是上级。
    APP 不能跨级回拨，PC后台可以跨级下发和回拨操作，不能跨级回拨是因为机具是代理商领走的，代理商还要给下级，这里面设置利润、关系、人情，不能轻易跨级回拨。


    1.APP显示 终端总数、已激活台数、未激活台数、昨日激活数、今日激活数、本月激活数：库存里显示终端号，区分：未绑定、已绑定、未激活、已激活
    2.终端划拨（不可跨级）、终端回拨（不可跨级）、划拨记录、回拨记录查看

    3.批量设置费率:0.53%，0.54%，0.55%，0.56%，0.57%，0.58%，0.59%，0.6%
    4.批量设置SIM卡（根据接口）:首次扣费金额：48，60,69,79,89，99
                    非首次扣费金额：48，60,69,79,89，99
                    非首次间隔天数：180，210,240,270,300,330,360
    5.批量设置押金：无押金，99押金，199押金，299押金

### 终端下发业务规则

1. **下发方式**
   - APP端：仅支持下发给直属下级，不可跨级
   - PC端：支持跨级下发，系统自动保留整个层级关系

2. **代扣类型**
   - 一次性付款：下级直接付清货款
   - 分期代扣：按期数从钱包扣款
   - 货款代扣：从钱包实时扣款，直到扣完为止

3. **跨级下发处理**
   - 跨级下发时，系统自动生成代扣链
   - 例如A→C跨级下发，自动生成A→B→C的代扣链
   - 每级都有对应的代扣计划

4. **下发状态流转**
   - 创建 → 待确认 → 已确认/已拒绝/已取消

5. **货款代扣触发**
   - 下发确认后，根据代扣类型自动创建对应的代扣计划

### APP端终端管理业务流程

1. **终端划拨流程**
   - 选择终端 → 选择直属下级代理商 → 设置货款代扣（可选）→ 确认划拨
   - 可设置货款代扣单价和扣款来源（分润/服务费/奖励钱包）
   - 支持按名称/编号/手机号搜索代理商

2. **终端回拨流程**
   - 选择未激活终端 → 确认回拨 → 自动回拨给上级代理商
   - 已激活终端不可回拨
   - 顶级代理商无法回拨

3. **终端详情查看**
   - 长按终端卡片 → 查看详情 → 展示终端基本信息、状态信息、商户信息

4. **划拨记录查看**
   - 入口：终端管理页面右上角更多菜单 → 划拨记录
   - 双Tab切换：我下发的 / 下发给我的
   - 卡片展示：单号、终端SN、对方代理商、货款、扣款方式、状态、时间
   - 支持下拉刷新和上拉加载更多
   - **操作按钮**（仅待确认状态显示）：
     - 我下发的：显示【取消】按钮，可取消划拨
     - 下发给我的：显示【确认】【拒绝】按钮，可确认或拒绝接收

5. **回拨记录查看**
   - 入口：终端管理页面右上角更多菜单 → 回拨记录
   - 双Tab切换：我回拨的 / 回拨给我的
   - 卡片展示：单号、终端SN、对方代理商、状态、创建时间、确认时间
   - 支持下拉刷新和上拉加载更多
   - **操作按钮**（仅待确认状态显示）：
     - 我回拨的：显示【取消】按钮，可取消回拨
     - 回拨给我的：显示【确认】【拒绝】按钮，可确认或拒绝接收

6. **批量设置功能**
   - 入口：选择终端后，点击底部设置按钮，弹出设置菜单
   - 支持的批量设置项：
     - **设置费率**：选择预设费率（0.53%~0.60%），应用到所有选中终端
     - **设置流量费**：选择首次流量费、非首次流量费、收费间隔天数
     - **设置押金**：选择押金档位（无押金/¥99/¥199/¥299）
   - 设置成功后自动刷新终端列表并清空选择状态



## 商户管理

    参考恒信通
    按通道筛选，显筛选显示			
    支持押金设定、增加费率修改、流量卡设定

## 客户登记	
        就是商户登记
        作为APP和PC端的独立功能		
       
        备注说明：
        支付版块基本分为两类产品，一类是小微，是不需要进件的，另一类是真商是需要进件的，可以接，目前重心先都放到小微，打通后再接真商，此功能预留。
        商户登记的目的是因为支付公司给我们回传商户信息的时候，是没有商户的完整的手机号得。
        我们用这个功能主要登记商户的手机号。推过来的进行匹配，目的是为了方便之后联系那个咱们的那个直属的代理商，再去联系这个商户，是为了方便这个，然后在这个功能上我们可以在数据分析的时候，帮助代理行商分析一些流失的商户，让他有联系的方式，主要是达到这个目的。
        所以这个功能就是将通道推回来的商户信息中的手机号二次维护，当然数据库里要加密存储，而且只有对应代理商才能看到。
        当然后续我们也要做真商，做真商时该功能肯定就实时维护商户信息了，然后将信息给到通道方，目前此功能不做，能够维护商户的一些信息和备注信息即可。

    
    商户管理和客户登记都要增加商户类型，包括
        APP和PC端显示商户类型，计算方法：忠诚商户（月均大于5万），优质商户（月均大于等于3万小于5万），潜力商户（月均大于等于两万小于3万），一般商户（月均大于等于一万小于两万），低活跃商户（月均大于0小于1万），30天无交易。
    这部分一天计算一次就好

    商户端通道会给到十足的权限，我们可以在上面的政策模板里设置不收押金，收99，收199，我们设置好后直接推给商户，商户交易时实时结算。
    机具切换时：流量卡和押金必须设置好，通过通道提供的接口推送到机具上，或者直接使用政策模板，下发默认的政策。
    费率可以实时修改，调用通道接口，实时生效，可以随时调整（个别通道不开放、结合接口文档）。
    
    这部分涉及和机具通信，下发政策。

    分直营商户和团队商户：商户姓名、商户编号、费率变更、交易查询（显示各月交易量）、商户手机号（加*号）， 是否活跃、是否直属这两属性待定）
    详情（根据接口）：脱敏手机号、机具编号、激活时间、首次流量费时间、首次流量费金额、刷卡费率、扫码费率、交易额统计（累计、本月总额、本月贷记卡、本月借记卡、本月微信、本月支付宝）
    要求：商户姓名、商户编号、机具编号可以互查
    注意：商户信息除了姓名，其他涉及个人信息部分全部脱敏存储，如果是代理商新增商户，那该手机号只向该代理商展示。

## 货款代扣：
    货款代扣作为APP的独立模块展现
    划拨终端时，可给下级设置货款代扣，需要下级接收一下。
    考虑到是终端划拨时用此交易，那在APP端需要绑定该代理商，已被后续自动从其钱包自动扣款

    举例:
        一台pos机货款50元，
        代理A从公司拿了100台
        货款50*100=5000元
        代理A没有给公司货款
        公司可以给代理设置5000元的货款代扣（设置时，可以选择从分润钱包扣，还是从返现钱包扣，还是两个钱包都扣）
        代理A接收后
        选择的钱包有了钱就会被扣走，直到扣够5000元停止

    说明：代理A的下级B从他那里拿货，代理A也可以给代理B设置代扣货款，每级都有这个权限

### 货款代扣业务规则明确（2026-01-22确认）

    1. 扣款规则
        - 多钱包扣款顺序：分润优先 - 先扣分润钱包，扣完再扣服务费钱包
        - 扣款时机：实时扣款 - 钱包入账时立即触发扣款
        - 部分扣款：有多少扣多少 - 余额不足时部分扣除，剩余下次继续扣
        - 扣款上限：无上限 - 每次入账时全部扣除，直到扣完为止

    2. 多代扣优先级
        - 扣款优先级：货款代扣优先 > 上级代扣 > 伙伴代扣
        - 与提现关系：影响可提现金额 - 待扣金额占用钱包余额

    3. 模块关系
        - 与代扣管理：两个独立模块 - 货款代扣专用于终端划拨场景

    4. 业务流程
        - 接收确认：下级拒绝接收则终端划拨失败
        - 修改/取消：设置后不可修改，只能扣完或线下协商
        - 分期规则：每次入账全部扣除，无期数限制
        - 法律协议：类似代扣管理需签署代扣协议

    5. 通知与展示
        - 扣款通知：每次扣款后APP推送通知
        - APP展示：代扣进度（待扣/已扣/剩余）、扣款明细列表、代扣状态

### APP端功能说明

1. **主页面（Tab切换）**
   - 我发起的：显示我作为发起方的货款代扣列表
   - 我接收的：显示我作为接收方的货款代扣列表

2. **列表卡片展示**
   - 对方代理商名称
   - 总金额 / 已扣金额 / 剩余金额
   - 终端数量
   - 扣款进度条
   - 状态标签

3. **详情页**
   - 基本信息区：双方代理商、总金额、扣款来源
   - 进度展示：环形进度图（已扣比例）
   - 终端列表：关联的终端SN和单价
   - 扣款明细：时间线形式展示每次扣款记录

4. **接收/拒绝流程**
   - 点击接收 → 弹出代扣服务协议
   - 需滚动阅读协议至底部
   - 点击同意 → 完成签署，开始扣款
   - 点击拒绝 → 填写拒绝原因 → 终端划拨失败

5. **状态说明**
   | 状态值 | 状态名 | 说明 |
   |--------|--------|------|
   | 1 | 待接收 | 等待接收方确认 |
   | 2 | 进行中 | 已接收，正在扣款 |
   | 3 | 已完成 | 扣款完成 |
   | 4 | 已拒绝 | 接收方拒绝 |


## 数据分析	
    （确认口径）交易查询：全部、直营、团队（代理商）三部分，最近6个月数据，参考恒信通功能要核对。
    
    （确认口径）商户交易量分析：忠诚商户（月均大于5万），优质商户（月均大于等于3万小于5万），潜力商户（月均大于等于两万小
    于3万），一般商户（月均大于等于一万小于两万），低活跃商户（月均大于0小于1万），30天无交易
    关于APP数据展示部分，目前只能显示自己和子代理汇总的数据，子代理再往下的数据APP端代理商自己看不到，可以到后台查看，APP不做深入展示。


    代理数据分析：各代理交易量排名、各代理交易笔数排名、各代理终端总数、各代理已激活终端数
    客户数据分析（直营、下级）：客户总交易量：刷卡占比、支付宝占比、微信占比
    直营商户：（按本月交易排名）姓名、脱敏手机号、累积交易、本月交易；点进去，显示机具号，刷卡交易金额，扫码交易金额，近七天交易金额，近半年交易金额
  
    
    后续完善，王康康提供。
    

## 收益统计
    今日收益总额，今日收益明细（交易收益，押金返现，流量返现）；收益趋势：近7天，近30天；查看月收益：近六个月，近一年，近两年
    后续完善，王康康提供。

## 分润计算（代码实现）

分润计算是系统核心功能，基于交易流水实时计算各级代理商的分润。

### 1. 分润计算流程
```
交易流水入库 → 触发分润消息 → ProfitService.CalculateProfit
                                    ↓
                            获取直属代理商
                                    ↓
                            获取代理商链（向上遍历）
                                    ↓
                            逐级计算费率差
                                    ↓
                            计算分润金额
                                    ↓
                            入分润钱包（wallet_type=1）
                                    ↓
                            触发货款代扣
                                    ↓
                            发送分润通知
```

### 2. 分润计算规则
- **费率差计算**：每级分润 = 交易金额 × (下级费率 - 自身费率) / 100
- **直属代理商**：下级费率 = 商户交易费率
- **非直属代理商**：下级费率 = 下级代理商的结算价
- **无级差时跳过**：费率差 ≤ 0 时不产生分润

### 3. 费率阶梯调整
- 支持商户入网时间阶梯：根据商户入网天数调整费率
- 支持代理商入网时间阶梯：根据代理商入网天数调整结算价
- 由RateStagingService提供费率调整

### 4. 分润撤销（退款场景）
- 交易退款时调用RevokeProfit
- 扣减各级代理商钱包余额
- 标记分润记录为已撤销
- 发送撤销通知

### 5. 货款代扣联动
- 分润入账时，自动触发货款代扣检查
- 调用GoodsDeductionService.TriggerRealtimeDeduction
- 有待扣货款时自动扣除

## 押金返现（代码实现）

商户缴纳押金后，返现给各级代理商。

### 1. 返现流程
```
收到押金缴纳通知 → DepositCashbackService.ProcessDepositCashback
                           ↓
                   获取终端和直属代理商
                           ↓
                   获取代理商链（向上遍历）
                           ↓
                   逐级计算级差返现
                           ↓
                   入服务费钱包（wallet_type=2）
                           ↓
                   发送返现通知
```

### 2. 返现计算规则
- **级差计算**：每级返现 = 自身配置的返现 - 下级配置的返现
- **直属代理商**：下级返现为0（商户没有返现）
- **返现金额由政策模板配置**：不同押金档位配置不同返现金额

### 3. 押金档位示例
| 押金金额 | 返现配置 |
|---------|---------|
| 99元 | 根据政策模板配置 |
| 199元 | 根据政策模板配置 |
| 299元 | 根据政策模板配置 |

## 流量费返现（代码实现）

商户缴纳流量费后，返现给各级代理商。

### 1. 返现档次（三档制）
| 档次 | tier值 | 说明 |
|-----|--------|------|
| 首次 | 1 | 第1次缴纳流量费 |
| 第2次 | 2 | 第2次缴纳流量费 |
| 第3次及以后 | 3 | 第3次及之后的缴费 |

### 2. 返现流程
```
收到流量费缴纳通知 → SimCashbackService.ProcessSimFee
                           ↓
                   更新终端流量费缴费次数
                           ↓
                   确定返现档次（首次/2次/2+N次）
                           ↓
                   获取代理商链（向上遍历）
                           ↓
                   逐级计算级差返现
                           ↓
                   入服务费钱包（wallet_type=2）
                           ↓
                   更新流量费记录状态
                           ↓
                   发送返现通知
```

### 3. 返现计算规则
- **级差计算**：每级返现 = 自身配置的返现 - 下级配置的返现
- **档次对应配置**：首次/第2次/第3次及以后分别配置不同返现金额
- **终端缴费次数维护**：每次缴费后自动累加

## 激活奖励（代码实现）

商户终端激活并达成交易量条件后，发放激活奖励。

### 1. 奖励触发条件
- **入网天数**：商户入网后的天数区间（如0-30天、31-60天）
- **交易量**：累计交易金额达到目标值

### 2. 奖励流程
```
定时任务 → BatchCheckTerminalRewards
                  ↓
          获取所有激活终端
                  ↓
          计算入网天数和累计交易量
                  ↓
          匹配奖励政策
                  ↓
          CheckAndProcessReward
                  ↓
          逐级计算级差奖励
                  ↓
          创建奖励记录（wallet_status=0）
                  ↓
定时任务 → ProcessPendingRewards
                  ↓
          入奖励钱包（wallet_type=3）
                  ↓
          发送奖励通知
```

### 3. 奖励计算规则
- **级差计算**：每级奖励 = 自身配置的奖励 - 下级配置的奖励
- **直属代理商**：下级奖励为0
- **避免重复发放**：同一政策+终端+日期只发放一次

### 4. 两阶段入账机制
- **第一阶段**：CheckAndProcessReward只创建记录（wallet_status=0）
- **第二阶段**：ProcessPendingRewards定时任务统一入账
- **设计目的**：避免并发场景下的重复入账风险

## 代扣管理

代扣管理作为APP和PC端的独立模块，用于代理商之间的资金代扣。

### 1. 代扣类型
| 类型 | 说明 | 发起方 | 接收方 |
|------|------|--------|--------|
| 伙伴代扣 | 同级代理商之间的代扣 | 代理商A | 代理商B（同级） |
| 上级代扣 | 上级向下级发起的代扣 | 上级代理商 | 直属下级代理商 |

### 2. 代扣属性
- **代扣金额**：总扣款金额（分）
- **代扣期数**：分多少期扣完（1-36期）
- **每期金额**：总金额 ÷ 期数（最后一期补差额）
- **扣款来源**：
  - 1 = 分润钱包
  - 2 = 服务费钱包
  - 3 = 两者都扣（先分润后服务费）
- **代扣协议**：需在线签署代扣服务协议

### 3. 状态流转
```
[发起] → [待确认] → [进行中] ←→ [已暂停]
                  ↓           ↓
              [已完成]    [已取消]
```
| 状态值 | 状态名 | 说明 |
|--------|--------|------|
| 1 | 进行中 | 正常扣款中 |
| 2 | 已完成 | 全部期数扣款完成 |
| 3 | 已暂停 | 暂停扣款，可恢复 |
| 4 | 已取消 | 取消代扣，不可恢复 |

### 4. 扣款规则
- **扣款时机**：定时任务每日执行，检查钱包余额后扣款
- **扣款顺序**：按期数顺序扣款
- **余额不足**：记录失败原因，下次定时任务重试
- **扣款记录**：每期扣款生成独立记录，包含扣款时间、金额、状态

### 5. 操作权限
| 操作 | 发起方 | 接收方 |
|------|--------|--------|
| 发起代扣 | ✓ | - |
| 接收/拒绝 | - | ✓ |
| 暂停 | ✓ | - |
| 恢复 | ✓ | - |
| 取消 | ✓ | - |

### 6. APP端功能
- **列表页**：筛选（状态、类型）、下拉刷新、上拉加载
- **详情页**：基本信息、金额统计、扣款记录列表
- **操作**：暂停/恢复/取消（需二次确认）

### 7. PC端功能
- **列表页**：筛选、分页、批量操作
- **详情页**：完整信息展示、操作日志
- **发起代扣**：选择代理商、设置金额期数、在线签署协议


## 钱包
    1.正常钱包
    钱包按分润、服务费（流量费+机具押金）、奖励 以及提现通道分类，显示钱包金额，并且每个钱包都有提现门槛，达到提现门槛就能提现
    钱包提现是通过税筹通道兑付的，我们在税筹通道有账户，通过这个账户赚钱给代理商，同时扣除对应的费用（税+单笔固定金额费用），例如9%+3 每笔。

    税筹通道需要对接对应厂商，参考对应接口文档。
    这个钱包的数字是代理商该得的利润，但钱是在通道厂商那边，我们可以选择通过公户领回，也可以直接接通代付通道，支付给代理商。

    税筹上我们会保留一定的利润，例如9%的手续费 + 3元/笔，扣除这个钱后就是代理商实际该得的费用，这个要算好后，通过代付公司给代理商付款。
    通道不一样，扣法不一样，分付款扣和出款扣，根据不同通道算出给代理商多少钱，但最终给代理商的钱不会变。

    提现门槛：不同通道 - 不同钱包（分润钱包、服务费钱包（流量+押金）、奖励钱包），提现门槛不同，要设置。

    2.充值钱包：是奖励钱包的资金来源之一。代理商充值后可给直属下级发放奖励，同时开通充值钱包是设置激活奖励政策的前提。未开通充值钱包的代理商无法设置奖励政策。
        充值钱包也可以提供贷款，收一份利息，走线下协议。
        充值钱包要显示 奖励总金额（包含手动发放+系统自动发放），当前钱包余额以及充值按钮
        充值钱包和沉淀钱包在PC端开通权限，APP不做入口，开通后APP端显示

        无论充值钱包有没有钱，只要在政策模版中设置了奖励规则，那么奖励就是生效的，下级代理商触发规则后，钱就会进到下级代理商的奖励钱包，而上级代理商的充值钱包里会显示余额和奖励总金额，上级代理商充值后，下级才能提现。

### 钱包类型定义（代码实现）

| wallet_type | 钱包类型 | 资金来源 | 用途 |
|-------------|---------|---------|------|
| 1 | 分润钱包 | 交易分润 | 提现 |
| 2 | 服务费钱包 | 押金返现、流量费返现 | 提现 |
| 3 | 奖励钱包 | 激活奖励、手动发放奖励 | 提现（需上级充值钱包有余额） |
| 4 | 充值钱包 | 代理商充值 | 给下级发放奖励 |
| 5 | 沉淀钱包 | 下级未提现资金 | 提前使用下级资金 |

### 钱包流水类型（代码实现）

| log_type | 流水类型 | 说明 |
|----------|---------|------|
| 1 | 交易分润 | 分润入账 |
| 2 | 返现入账 | 押金/流量费返现 |
| 3 | 提现 | 钱包提现 |
| 4 | 冻结 | 资金冻结 |
| 5 | 解冻 | 资金解冻 |
| 6 | 激活奖励 | 激活奖励入账 |
| 7 | 手动奖励 | 上级手动发放奖励 |
| 8 | 货款代扣 | 货款代扣扣款 |
| 9 | 代扣扣款 | 代扣管理扣款 |

### 钱包余额计算

```
可提现余额 = 钱包余额 - 冻结金额 - 待扣货款金额
```

### 充值钱包与奖励钱包业务关系（重要）

    核心规则：**奖励钱包的资金来源于上级代理商的充值钱包，开通充值钱包后才会有奖励一说。**

    1. 资金流向
        ┌──────────────────────────────────────────────────────────────┐
        │                    手动奖励发放流程                            │
        │   上级代理商                         下级代理商               │
        │   ┌───────────────┐  IssueReward   ┌───────────────┐        │
        │   │  充值钱包      │ ============> │  奖励钱包      │        │
        │   │ (WalletType=4)│   -Amount      │ (WalletType=3)│        │
        │   │ Balance -= X  │               │ Balance += X  │        │
        │   └───────────────┘               └───────────────┘        │
        └──────────────────────────────────────────────────────────────┘

        ┌──────────────────────────────────────────────────────────────┐
        │                    自动激活奖励流程                            │
        │  终端激活达标 → CheckAndProcessReward → 计算级差奖励           │
        │                         │                                    │
        │                         ▼                                    │
        │  代理商链中每一级的奖励钱包 (WalletType=3) 余额增加            │
        │                                                              │
        │  ⚠️ 注意: 自动激活奖励是系统直接发放，不从充值钱包扣除          │
        │  但前提是：上级必须已开通充值钱包才能设置奖励政策               │
        └──────────────────────────────────────────────────────────────┘

    2. 奖励入账与提现规则
        - 奖励入账（无条件）：政策模板设置奖励规则 → 下级触发条件 → 奖励入账到奖励钱包
          与充值钱包余额无关，只要设置了规则就生效

        - 奖励提现（有条件）：下级申请提现 → 检查上级充值钱包余额 → 余额充足才能提现
          上级充值钱包余额 ≥ 下级申请提现金额，否则提现失败

    3. 业务含义
        - 奖励钱包的钱是"账面资产"，需要上级充值后才能变现
        - 上级代理商有义务为下级的奖励买单（充值到充值钱包）
        - 这确保了奖励资金有真实来源，避免空头奖励

    4. 充值钱包显示内容
        - 当前余额：代理商自己充值的金额
        - 奖励总金额：累计发放给下级的奖励（系统自动+手动发放）
        - 手动发放奖励总额
        - 系统自动奖励总额

    3.沉淀钱包：可以提现下级未提现钱包的钱，允许使用一定比例，例如30%。相当于用了下级代理商的钱，但下级不知道，而且下级超出部分无法提现。
        正常如果下级代理商提现失败，那该代理商应该将沉淀钱包里的钱充回。如果出现无法充回的情况，我们可以帮助该代理商预付，但需要收取利息（相当于贷款，走自有资金，线下签协议），是未来的一个盈利的点。
        充值钱包和沉淀钱包在PC端开通权限，APP不做入口，开通后APP端显示

    4.奖励钱包
    激活奖励资金来源：当前代码中自动激活奖励是系统直接发放到奖励钱包，从充值钱包扣除。
    无论充值钱包有没有钱，只要在政策模版中设置了奖励规则，那么奖励就是生效的，下级代理商触发规则后，钱就会进到下级代理商的奖励钱包，而上级代理商的充值钱包里会显示余额和奖励总金额，上级代理商充值后，下级才能提现。


    充值钱包和沉淀钱包如果发生借贷，也叫前置分润，我们要收取一定的费用，后续还款暂时走线下。
    充值钱包和沉淀钱包要求可隐藏、可设置比例。

## 我的信息
    姓名，手机号，服务商编号，入网时间，脱敏身份证号，结算卡，更改结算卡按钮，费率成本，代理有唯一邀请码，代理邀请码可自定义靓号

### 业务规则说明

1. **个人信息展示**
   - 显示代理商基本信息：姓名、手机号（脱敏）、服务商编号、入网时间
   - 身份证号脱敏显示，仅展示前3后4位

2. **结算卡管理**
   - 显示当前绑定的结算卡信息：开户银行、开户名、银行卡号（脱敏）
   - 代理商可自行修改结算卡信息，修改后下次结算生效
   - 仅支持储蓄卡，不支持信用卡

3. **邀请码**
   - 每个代理商拥有唯一邀请码，用于发展下级代理
   - 支持自定义靓号：4-12位字母数字，系统自动转大写
   - 邀请码唯一，不可与其他代理商重复
   - 提供邀请二维码，可保存分享

4. **团队统计**
   - 直属代理/商户：直接发展的下级数量
   - 团队代理/商户：所有层级下级总数（递归统计）

## 消息通知
    APP端提醒  用来提醒分润、注册、消费的消息提醒，这些叫业务提醒，还有例如节假日提醒都要通过APP能够及时的提醒出去，点进来是对应的消息管理界面，可以看历史消息。
    消息有效期3天，3天内未查看一直活跃，直到过期。

    PC端登录后要弹窗，提醒最近更新重要内容。

### 1. 消息类型定义
| 类型编号 | 类型名称 | 触发时机 | 示例 |
|---------|---------|---------|------|
| 1 | 交易分润 | 交易分润到账时 | "恭喜！您获得交易分润¥12.50" |
| 2 | 激活奖励 | 商户激活奖励达成时 | "商户激活奖励¥100已到账" |
| 3 | 押金返现 | 收取商户押金后返现 | "押金返现¥69已到账" |
| 4 | 流量返现 | 收取流量费后返现 | "流量卡返现¥49已到账" |
| 5 | 退款撤销 | 交易退款影响分润时 | "交易退款，分润扣减¥5.00" |
| 6 | 系统公告 | 管理员发送公告 | "系统维护通知..." |
| 7 | 新代理注册 | 有新下级代理注册 | "新代理商张三已注册成功" |
| 8 | 交易通知 | 重要交易提醒 | "商户[***]今日交易超1万" |

### 2. 消息有效期规则
- 默认有效期：3天（72小时）
- 管理员发送时可设置：1-30天
- 过期处理：定时任务每6小时清理过期消息
- 过期后消息从列表中移除，不可恢复

### 3. 消息发送规则
- **业务消息**（类型1-5、7-8）：系统自动触发，代理商无法手动发送
- **系统公告**（类型6）：仅管理员可发送，发送范围支持：
  - 全部代理商
  - 指定代理商（搜索+多选）
  - 指定层级（1-5级）

### 4. 消息已读规则
- 点击消息详情 → 自动标记已读
- 支持"全部已读"一键操作
- 未读消息显示红点标记

### 5. APP端消息分类
| 分类 | 包含的消息类型 |
|-----|--------------|
| 全部 | 所有类型 |
| 分润 | 交易分润、激活奖励、押金返现、流量返现 |
| 注册 | 新代理注册 |
| 消费 | 交易通知 |
| 系统 | 系统公告、退款撤销 |

### 6. PC端消息管理权限
| 角色 | 查看列表 | 发送消息 | 删除消息 |
|-----|---------|---------|---------|
| 超级管理员 | ✓ | ✓ | ✓ |
| 运营管理员 | ✓ | ✓ | ✓ |
| 客服人员 | ✓ | ✓ | ✗ |
| 财务人员 | ✗ | ✗ | ✗ |
| 代理商 | ✗ | ✗ | ✗ |

# 测试方法
本程序对金额的计算要严谨，尤其是基于成功交易流水，各级代理商的分润、押金、流量费返现的计算、货款代扣、代扣管理（上级和伙伴）、沉淀钱包、充值钱包变动，或者说所有钱包的变动必须要前后一致，留痕、有记录可查。
金额不能凭空产生，都需要基于业务数据来源，都需要有记录表记录。
功能测试用例也要完整，考虑到刚刚说的这些场景，必须做自动测试，验证涉及金额的准确性、流程都要测试到位，应该产生什么数据，实际产生什么数据都要做自动测试，每次打包都要测试通过才能发布。ß

# 安全与三级等保

全部项目要满足三级等保，例如登录时的账号密码不能是明文、SQL注入风险，这块自己搜下相关政策要求，必须满足，防止安全事故。

## 安全防护措施（代码实现）

### 1. 密码安全

#### 1.1 密码加密存储
- **算法**：使用bcrypt进行密码哈希（cost=10）
- **兼容性**：支持旧SHA256格式密码的验证和自动升级
- **盐值**：bcrypt内部自动生成随机盐值

```
用户注册/修改密码 → bcrypt.GenerateFromPassword → 存储哈希值
用户登录 → bcrypt.CompareHashAndPassword → 验证密码
```

#### 1.2 密码强度校验
| 要求项 | 规则 |
|--------|------|
| 最小长度 | 8位 |
| 最大长度 | 32位 |
| 大写字母 | 必须包含 |
| 小写字母 | 必须包含 |
| 数字 | 必须包含 |
| 特殊字符 | 可选 |

#### 1.3 密码传输安全
- 前端使用HTTPS传输
- 密码不在日志中记录
- 响应中不返回密码信息

### 2. 登录安全

#### 2.1 登录失败锁定
| 配置项 | 默认值 |
|--------|--------|
| 最大失败次数 | 5次 |
| 锁定时间 | 30分钟 |
| IP封禁阈值 | 10次失败 |
| IP封禁时间 | 1小时 |

```
登录失败 → 记录失败次数 → 达到阈值 → 锁定账户
            ↓
        失败过多 → 加入IP黑名单
```

#### 2.2 登录日志记录
- 记录登录IP、时间、UserAgent
- 区分登录成功/失败
- 失败时记录失败原因

### 3. 会话安全

#### 3.1 JWT Token配置
| 配置项 | 默认值 |
|--------|--------|
| 访问令牌有效期 | 2小时 |
| 刷新令牌有效期 | 7天 |
| 签名算法 | HS256 |

#### 3.2 Token安全
- 刷新令牌使用随机字符串，存储在数据库
- 修改密码后强制重新登录（删除所有刷新令牌）
- 支持主动登出（删除刷新令牌）

### 4. 接口安全

#### 4.1 安全响应头
| 头部 | 值 | 作用 |
|------|-----|------|
| X-Frame-Options | DENY | 防止点击劫持 |
| X-Content-Type-Options | nosniff | 防止MIME嗅探 |
| X-XSS-Protection | 1; mode=block | XSS过滤 |
| Content-Security-Policy | default-src 'self' | 内容安全策略 |
| Referrer-Policy | strict-origin-when-cross-origin | 引用策略 |
| Cache-Control | no-store | API禁止缓存 |

#### 4.2 限流配置
| 类型 | 速率 | 容量 |
|------|------|------|
| 全局限流 | 1000/秒 | 2000 |
| IP限流 | 100/秒 | 200 |

#### 4.3 SQL注入防护
- 使用GORM参数化查询
- 对用户输入进行模式检测
- 检测到注入尝试返回400错误

#### 4.4 XSS防护
- 对输出进行HTML实体转义
- 移除script标签和事件处理属性
- 过滤javascript:协议

### 5. 敏感数据保护

#### 5.1 加密存储
| 数据类型 | 加密算法 | 存储方式 |
|---------|---------|---------|
| 手机号 | AES-256-GCM | Base64编码 |
| 身份证号 | AES-256-GCM | Base64编码 |
| 银行卡号 | AES-256-GCM | Base64编码 |

#### 5.2 数据脱敏显示
| 数据类型 | 脱敏规则 | 示例 |
|---------|---------|------|
| 手机号 | 前3后4 | 138****1234 |
| 身份证 | 前4后4 | 3101**********1234 |
| 银行卡 | 前4后4 | 6222****1234 |

### 6. 审计日志

#### 6.1 记录的操作类型
| 类型 | 级别 | 说明 |
|------|------|------|
| 用户登录 | 信息 | 记录成功/失败 |
| 密码修改 | 严重 | 必须记录 |
| 数据导出 | 警告 | 敏感操作 |
| 提现操作 | 严重 | 资金相关 |
| 代理商创建/禁用 | 警告 | 权限变更 |
| 费率变更 | 警告 | 业务配置 |
| 代扣操作 | 警告 | 资金相关 |

#### 6.2 审计日志字段
- 操作用户、代理商信息
- 操作目标（类型、ID、名称）
- 变更前后值（JSON格式）
- IP地址、UserAgent
- 请求路径、方法
- 操作结果、错误信息

#### 6.3 审计日志保留
- 保留期限：至少180天
- 定期归档到冷存储
- 支持按条件查询和导出

### 7. IP黑名单

#### 7.1 自动封禁规则
- 登录失败超过10次
- 检测到SQL注入尝试
- 请求频率异常

#### 7.2 黑名单管理
- 支持手动添加/删除
- 支持设置过期时间
- 定时清理过期记录

### 8. 安全配置表

系统安全配置存储在`security_configs`表中，支持动态调整：
- 密码策略
- 登录锁定策略
- 会话策略
- 限流策略

### 9. 安全相关数据库表

| 表名 | 用途 |
|------|------|
| audit_logs | 审计日志 |
| ip_blacklist | IP黑名单 |
| login_attempts | 登录尝试记录 |
| security_configs | 安全配置 |
| login_logs | 登录日志（已有） |


# 通道回调处理（代码实现）

系统通过回调处理器（CallbackProcessor）处理各支付通道推送的回调数据。

## 1. 支持的回调类型

| 回调类型 | 动作类型 | 说明 |
|---------|---------|------|
| 交易流水 | transaction | 交易成功后的流水推送 |
| 费率变更 | rate_change | 商户费率变更通知 |
| 设备费用 | device_fee | 流量费/押金等设备相关费用 |
| 商户入网 | merchant_income | 商户审核结果通知 |
| 终端绑定 | terminal_bind | 终端绑定/解绑通知 |

## 2. 回调处理流程

```
通道推送 → 签名验证 → 原始数据入库 → 发送队列 → 异步处理 → 状态更新
```

1. **签名验证**：根据通道配置验证回调数据签名
2. **原始数据入库**：保存到raw_callbacks表，支持追溯和重试
3. **发送队列**：将回调消息发送到异步队列处理
4. **异步处理**：解析数据并调用相应业务逻辑
5. **状态更新**：根据回调结果更新商户/终端状态

## 3. 商户入网回调处理

当收到商户入网审核结果回调时：
- **审核通过**：更新商户 `approve_status = 2`（已通过）
- **审核拒绝**：更新商户 `approve_status = 3`（已拒绝）
- **待审核**：保持 `approve_status = 1`（待审核）

## 4. 终端绑定回调处理

当收到终端绑定/解绑回调时：
- **绑定成功**：更新终端 `status = 3`（已激活）
- **解绑成功**：更新终端 `status = 2`（已分配）

## 5. 失败重试机制

- 处理失败的回调会记录失败原因
- 定时任务每5分钟检查并重试失败的回调
- 最大重试次数：3次
- 超过重试次数后标记为失败，需人工处理

# 定时任务汇总（代码实现）

系统通过定时任务调度器处理周期性业务逻辑。

## 已实现的定时任务

| 任务名称 | 执行周期 | 说明 |
|---------|---------|------|
| alert_checker | 1分钟 | 系统告警检查 |
| profit_calculator | 5分钟 | 分润计算 |
| callback_retry | 5分钟 | 回调重试 |
| message_cleanup | 6小时 | 过期消息清理 |
| partition_manager | 24小时 | 分区管理（自动创建未来3个月的PostgreSQL分区） |
| data_archiver | 24小时 | 数据归档（90天保留期，导出JSONL后删除） |
| daily_deduction | 24小时 | 每日代扣执行 |
| sim_cashback_fallback | 10分钟 | 流量费返现兜底处理 |
| reward_check | 24小时 | 激活奖励检查 |
| deposit_cashback_settle | 10分钟 | 押金返现结算 |
| activation_reward_settle | 10分钟 | 激活奖励结算 |
| sim_cashback_settle | 10分钟 | 流量费返现结算 |
| merchant_type_calculator | 24小时 | 商户类型计算 |

## 数据归档任务说明

系统自动归档超过90天的已处理回调日志：
1. 统计需要归档的数据量
2. 分批处理（每批1000条）
3. 导出到JSONL格式文件（如配置了归档路径）
4. 删除已归档的数据库记录
5. 记录归档进度日志

## 分区管理任务说明

系统自动管理PostgreSQL表分区：
1. 每天检查一次
2. 自动创建未来3个月的月度分区
3. 分区命名格式：`raw_callback_logs_YYYY_MM`
4. 检查分区是否已存在，避免重复创建

# 提现与税筹通道打款（代码实现）

## 1. 提现申请流程
```
代理商申请提现 → 检查钱包余额 → 检查提现门槛
                        ↓
              奖励钱包需检查上级充值钱包余额
                        ↓
              获取税筹通道配置，计算税费
                        ↓
              冻结钱包金额 → 创建提现记录
                        ↓
              记录钱包流水 → 等待审核
```

## 2. 审核通过后自动打款流程
```
管理员审核通过 → 更新状态为已审核
                    ↓
              异步触发自动打款（goroutine）
                    ↓
              检查税筹通道配置（是否启用、是否有API）
                    ↓
              调用税筹通道API → 获取打款流水号
                    ↓
              更新提现状态为已打款
                    ↓
              扣减钱包冻结金额 → 记录钱包流水
```

## 3. 税筹通道API调用
- 解密银行卡号
- 构建请求参数（订单号、金额、银行信息、时间戳）
- 生成签名
- 发送HTTP请求（预留接口，需根据具体通道文档实现）

# 费率校验逻辑（代码实现）

## 商户费率修改校验
修改商户费率时，系统会校验新费率不能低于上级代理商的政策费率：

```
代理商修改商户费率 → 验证商户归属
                        ↓
              验证费率范围（0-10%）
                        ↓
              获取代理商信息，检查是否有上级
                        ↓
              查询上级代理商的通道政策费率
                        ↓
              比较：新费率 >= 上级费率？
                        ↓
              通过则更新，否则返回错误提示



