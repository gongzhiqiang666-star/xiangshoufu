# 8家支付通道对接方案

> 状态：待完善
> 创建时间：2026-01-30
> 最后更新：2026-01-30

## 目标
分批次快速对接8家支付通道，优先联动支付，确保测试覆盖完整，与现有业务逻辑无缝衔接。

---

## 一、接口分类与业务对接点

### 1.1 三类接口与现有业务的关系

| 接口类型 | 回调内容 | 触发的业务逻辑 | 涉及的表 |
|----------|----------|----------------|----------|
| **通知类** | 交易回调 | 分润计算（基础+高调+P+0）| transactions, profits, wallets |
| **通知类** | 流量费回调 | 流量费返现（三档制）| device_fees, terminals(SimFeeCount), wallets |
| **通知类** | 费率变更 | 同步商户费率 | merchants, rate_changes |
| **商户类** | 商户入网 | 创建商户+终端绑定 | merchants, terminals |
| **商户类** | 终端绑定 | 更新终端状态 | terminals |
| **商户类** | 修改默认费率 | 主动调用通道API | 通道API调用 |
| **代付类** | 代付出款通知 | 提现状态更新（优先级最低）| withdraws |

### 1.2 关键业务规则速查

| 业务 | 计算方式 | 入账钱包 | 关键字段 |
|------|---------|----------|----------|
| 交易分润 | 费率级差 | 分润钱包(1) | Amount, CardType, Rate |
| 高调分润 | 高调费率级差 | 分润钱包(1) | **HighRate** (必须从回调解析) |
| P+0分润 | D0配置级差 | 分润钱包(1) | **D0Fee** (必须从回调解析) |
| 流量费返现 | 三档返现级差 | 服务费钱包(2) | **SimFeeCount** (终端表) |
| 押金返现 | 返现配置级差 | 服务费钱包(2) | DepositAmount |

---

## 二、费率类型完整映射链路（核心）

### 2.1 映射链路图

```
通道回调(payTypeCode) → 适配器(mapPayTypeCode) → CardType(int16)
    → getRateTypeFromCardType → 费率编码(string) → 结算价RateConfigs
```

### 2.2 联动 payTypeCode 到系统的完整映射

| 联动 payTypeCode | channel.CardType | CardType(int16) | 费率编码 | 结算价字段 |
|------------------|------------------|-----------------|----------|-----------|
| POS_DC | CardTypeDebit | 1 | DEBIT | RateConfigs["DEBIT"] |
| POS_CC | CardTypeCredit | 2 | CREDIT | RateConfigs["CREDIT"] |
| WECHAT | CardTypeWechat | 3 | WECHAT | RateConfigs["WECHAT"] |
| ALIPAY | CardTypeAlipay | 4 | ALIPAY | RateConfigs["ALIPAY"] |
| UNIONPAY_DOWN_CC | CardTypeUnionpay | 5 | UNIONPAY | RateConfigs["UNIONPAY"] |
| UNIONPAY_DOWN_DC | CardTypeUnionpay | 5 | UNIONPAY | RateConfigs["UNIONPAY"] |
| POS_DISCOUNT_CC | CardTypeCredit | 2 | CREDIT | 特惠贷记卡 |

### 2.3 ⚠️ 费率类型范围校验（关键）

**核心原则**：回调中的交易费率类型必须在结算价已配置的费率类型范围内，否则无法计算分润。

| 校验点 | 说明 |
|--------|------|
| 回调费率类型 | 联动 payTypeCode 映射后的费率编码 |
| 结算价费率类型 | RateConfigs 中已配置的费率编码 |
| 校验逻辑 | 若回调费率类型不在结算价中，记录告警日志 |

**实现要点**：
```go
// ParseTransaction 时检查费率类型
func (a *Adapter) ParseTransaction(rawBody []byte) (*channel.UnifiedTransaction, error) {
    // ... 解析逻辑

    cardType := mapPayTypeCode(req.PayTypeCode)

    // 返回统一交易对象，后续分润计算时会校验
    return &channel.UnifiedTransaction{
        CardType: cardType,
        // ... 其他字段
    }, nil
}

// 分润计算时校验费率类型是否在结算价范围内
// 若不存在，记录告警并跳过该笔分润
```

**测试用例**：
- [ ] 回调费率类型在结算价范围内 → 正常分润
- [ ] 回调费率类型不在结算价范围内 → 记录告警，不计算该笔分润

### 2.4 联动适配器必须实现的映射函数

```go
// mapPayTypeCode 联动支付类型映射
func mapPayTypeCode(payTypeCode string) channel.CardType {
    switch payTypeCode {
    case "POS_DC":
        return channel.CardTypeDebit      // 借记卡
    case "POS_CC", "POS_DISCOUNT_CC", "POS_DISCOUNT_GF_CC", "POS_DISCOUNT_MS_CC", "POS_DISCOUNT_PA_CC":
        return channel.CardTypeCredit     // 贷记卡(含特惠)
    case "WECHAT":
        return channel.CardTypeWechat     // 微信
    case "ALIPAY":
        return channel.CardTypeAlipay     // 支付宝
    case "UNIONPAY_DOWN_CC", "UNIONPAY_DOWN_DC", "UNIONPAY_UP_CC", "UNIONPAY_UP_DC":
        return channel.CardTypeUnionpay   // 云闪付
    default:
        return channel.CardTypeCredit
    }
}
```

### 2.5 通道配置 → 政策模板 → 结算价 费率一致性

```
通道配置 (ChannelRateConfig)
    ├── RateCode: CREDIT/DEBIT/WECHAT/ALIPAY/UNIONPAY
    └── MinRate/MaxRate/DefaultRate
            ↓
政策模板 (PolicyTemplate)
    ├── RateConfigs: {"CREDIT": {"rate": "0.60"}, "DEBIT": {...}}
    └── 旧字段: CreditRate/DebitRate/WechatRate/AlipayRate/UnionpayRate
            ↓
结算价 (SettlementPrice)
    ├── RateConfigs: {"CREDIT": {"rate": "0.55"}, ...}
    └── HighRateConfigs / D0ExtraConfigs（高调/P+0）
            ↓
分润计算
    └── 根据 CardType → 费率编码 → RateConfigs[编码] 获取费率
```

### 2.6 费率类型验证清单

- [ ] 通道配置中已定义所有费率类型（CREDIT/DEBIT/WECHAT/ALIPAY/UNIONPAY）
- [ ] 政策模板 RateConfigs 包含所有费率类型
- [ ] 结算价 RateConfigs 包含所有费率类型
- [ ] `getRateTypeFromCardType` 支持所有 CardType（1-6）
- [ ] 联动 `mapPayTypeCode` 覆盖所有 payTypeCode 值
- [ ] 交易入库时 CardType 正确存储
- [ ] 分润计算时能正确获取对应费率

---

## 三、交易回调的核心字段映射（必须完整）

### 3.1 UnifiedTransaction 关键字段

```go
type UnifiedTransaction struct {
    Amount      int64    // 交易金额（分）- 分润基数
    CardType    CardType // 卡类型 - 决定使用哪个费率计算
    Rate        string   // 费率 - 分润计算
    HighRate    string   // 高调费率 - 高调分润计算 ⚠️关键
    D0Fee       int64    // P+0费用 - P+0分润计算 ⚠️关键
    TerminalSN  string   // 终端SN - 关联商户和代理商
    MerchantNo  string   // 商户号
    OrderNo     string   // 订单号 - 幂等键
    TradeTime   time.Time
}
```

### 3.2 卡类型映射（影响分润费率选择）

| CardType | 分润计算使用的费率 |
|----------|-------------------|
| debit (借记卡) | policy.DebitRate |
| credit (贷记卡) | policy.CreditRate |
| wechat | policy.WechatRate |
| alipay | policy.AlipayRate |
| unionpay | policy.UnionpayRate |

### 3.3 联动交易回调字段映射

| 联动字段 | UnifiedTransaction字段 | 转换说明 |
|----------|------------------------|----------|
| amount | Amount | **元×100→分** |
| payTypeCode | CardType | 枚举映射（需确认联动编码）|
| feeRate | Rate | 费率格式统一 |
| **additionRate** | **HighRate** | 高调费率（联动叫加价费率）|
| **d0Fee/rapidFee** | **D0Fee** | P+0费用（元×100→分）|
| materialsNo | TerminalSN | 直接映射 |
| customerNo | MerchantNo | 直接映射 |
| orderNo | OrderNo | 直接映射 |

---

## 四、流量费与押金识别（联动特殊机制）

### 4.1 ⚠️ 联动关键差异
**联动没有单独的流量费/押金回调！** 是通过交易回调中的**止付(stopPay)字段**识别：

| stopPayType | 含义 | 对应业务 |
|-------------|------|----------|
| MACHINE | 服务费止付 | **押金扣款** |
| SIM | 通讯服务费止付 | **流量费扣款** |

### 4.2 交易回调中的止付字段

```go
// PAY_ORDER_NOTIFY 中的止付相关字段
stopPayType    string  // MACHINE=押金, SIM=流量费
stopPayAmount  float64 // 止付金额（元）
stopRuleIndex  int     // 阶段（SIM时=第几次缴费）
stopPhaseIndex int     // 档位
stopOrderNo    string  // 止付订单编号
```

### 4.3 流量费三档判断逻辑
- `stopRuleIndex` 对应缴费阶段
- 联动的 `stopRuleIndex` 直接对应我们的三档：
  - stopRuleIndex=1 → 首次
  - stopRuleIndex=2 → 第2次
  - stopRuleIndex≥3 → 第3次及以后

### 4.4 实现方案
当解析交易回调时：
1. 检查 `stopPayType` 字段
2. 如果 `stopPayType == "SIM"` → 触发流量费返现逻辑
3. 如果 `stopPayType == "MACHINE"` → 触发押金返现逻辑
4. 使用 `stopRuleIndex` 确定档次

### 4.5 测试用例必须覆盖
- [ ] 普通交易（无止付）→ 仅分润计算
- [ ] 交易+流量费止付(stopPayType=SIM, stopRuleIndex=1) → 分润+首次返现
- [ ] 交易+流量费止付(stopPayType=SIM, stopRuleIndex=2) → 分润+第2次返现
- [ ] 交易+流量费止付(stopPayType=SIM, stopRuleIndex=3) → 分润+第3次返现
- [ ] 交易+押金止付(stopPayType=MACHINE) → 分润+押金返现

---

## 五、商户类接口（主动调用通道API）

### 5.1 接口分类

| 类别 | 接口 | 用途 | PC/APP操作场景 |
|------|------|------|----------------|
| **费率类** | `/batchSetDefaultRate` | 终端修改默认费率 | PC端设置终端默认费率 |
| **费率类** | `/customerRateModify` | 商户修改费率 | PC/APP修改商户费率 |
| **费率类** | `/customerRateQuery` | 查询商户费率 | 查看当前费率 |
| **押金类** | `/machineFeeChange` | 服务费档位设置 | 设置押金档位 |
| **流量费类** | `/simFeeChange` | 通讯服务费设置 | 设置流量费档位 |
| **绑定类** | `/bindMaterials` | 终端绑定商户 | APP绑定终端 |
| **绑定类** | `/unBindMaterials` | 终端解绑 | APP解绑终端 |
| **查询类** | `/materialsDataQuery` | 终端查询 | 查看终端信息 |

### 5.2 费率类接口详情

#### 5.2.1 终端修改默认费率 (`/batchSetDefaultRate`)
```go
// 请求
type BatchSetDefaultRateRequest struct {
    MaterialsNoList          []string              // 终端SN列表
    MaterialsDefaultRateList []DefaultRateItem     // 费率列表
}

type DefaultRateItem struct {
    PayTypeViewCode string  // 费率编码：POS_DC/POS_CC/WECHAT/ALIPAY等
    RateValue       float64 // 费率值（百分比，0.3表示0.3%）
    FixedValue      float64 // 附加费（元）
    CappingValue    float64 // 封顶值（元）
}
```

#### 5.2.2 商户修改费率 (`/customerRateModify`)
```go
type CustomerRateModifyRequest struct {
    CustomerNo       string           // 商户编号
    CustomerRateList []CustomerRate   // 费率列表（需传全部类型）
}
```

#### 5.2.3 费率类型映射

| PayTypeViewCode | 含义 | 系统对应字段 |
|-----------------|------|-------------|
| POS_DC | 借记卡 | DebitRate |
| POS_CC | 贷记卡 | CreditRate |
| WECHAT | 微信 | WechatRate |
| ALIPAY | 支付宝 | AlipayRate |
| UNIONPAY_DOWN_CC | 云闪付1000- | UnionpayRate |

### 5.3 押金类接口详情

#### 5.3.1 服务费设置 (`/machineFeeChange`)
```go
type MachineFeeChangeRequest struct {
    MaterialsNo       string // 终端SN
    MachinePhaseIndex int    // 档位序列（对应押金档位）
}
```

**业务说明**：
- 终端**未绑定商户时**才能设置服务费档位
- `MachinePhaseIndex` 对应终端查询接口返回的 `machinePhaseIndex`

### 5.4 流量费类接口详情

#### 5.4.1 通讯服务费设置 (`/simFeeChange`)
```go
type SimFeeChangeRequest struct {
    MaterialsNo        string              // 终端SN
    SimDeductionsList  []SimDeductionItem  // 通讯服务费扣款配置
}

type SimDeductionItem struct {
    SimRuleIndex   int // 阶段（1/2/3...）
    SimPhaseIndex  int // 档位
    BeginDayNum    int // 扣费起始天数
}
```

**业务说明**：
- 已收取阶段不允许变更档位
- 扣费天数需在 `beginDayMinRang` 和 `beginDayMaxRang` 范围内

### 5.5 绑定类接口详情

#### 5.5.1 终端绑定 (`/bindMaterials`)
```go
type BindMaterialsRequest struct {
    CustomerNo  string // 商户编号
    MaterialsNo string // 终端SN
}
```

#### 5.5.2 终端解绑 (`/unBindMaterials`)
```go
type UnBindMaterialsRequest struct {
    CustomerNo  string // 商户编号
    MaterialsNo string // 终端SN
}
```

**限制**：有成功交易的终端无法使用接口解绑

### 5.6 商户类接口验证清单

#### 费率接口验证
- [ ] PC端设置终端默认费率 → 调用 `/batchSetDefaultRate` → 返回费率版本号
- [ ] PC端修改商户费率 → 调用 `/customerRateModify` → 收到 `CUSTOMER_LAST_RATE_NOTIFY` 回调
- [ ] 查询商户费率 → 调用 `/customerRateQuery` → 返回当前费率列表
- [ ] 费率类型完整性验证（借记卡、贷记卡、微信、支付宝、云闪付）

#### 押金接口验证
- [ ] 查询终端押金档位 → 调用 `/materialsDataQuery` → 返回 `materialsMachineList`
- [ ] 设置押金档位 → 调用 `/machineFeeChange` → 返回成功
- [ ] 验证押金设置限制（仅未绑定终端可设置）

#### 流量费接口验证
- [ ] 查询终端流量费配置 → 调用 `/materialsDataQuery` → 返回 `materialsSimInfo`
- [ ] 设置流量费档位 → 调用 `/simFeeChange` → 返回成功
- [ ] 验证流量费设置限制（已收取阶段不可变更）

#### 绑定接口验证
- [ ] 终端绑定商户 → 调用 `/bindMaterials` → 收到 `MATERIAL_BIND_STATUS_NOTIFY` 回调
- [ ] 终端解绑 → 调用 `/unBindMaterials` → 收到解绑回调
- [ ] 验证解绑限制（有交易终端无法解绑）

---

## 六、费率变更回调处理

### 6.1 触发场景
- 商户首次绑定终端
- 通过接口修改商户费率
- 展业APP修改商户费率

### 6.2 回调处理
- 更新 `rate_changes` 表记录
- 同步更新 `merchants` 表的费率字段
- 使用 `effectiveBegin` 判断最新费率（多次通知时取最新生效时间）

---

## 七、公共组件设计

### 7.1 目录结构
```
server/internal/channel/
├── common/
│   ├── crypto.go       # RSA/AES加解密
│   ├── sign.go         # 签名验证
│   ├── amount.go       # 金额转换（元↔分）
│   ├── response.go     # 响应构建（JSON/"OK"）
│   └── card_type.go    # 通用卡类型映射
├── liandong/
│   ├── adapter.go
│   ├── models.go
│   └── adapter_test.go
└── ...
```

### 7.2 金额转换工具

```go
// 元转分
func YuanToFen(yuan float64) int64 {
    return int64(math.Round(yuan * 100))
}

// 分转元
func FenToYuan(fen int64) float64 {
    return float64(fen) / 100
}
```

---

## 八、完整测试用例清单

### 8.1 交易回调测试

| 测试场景 | 验证点 |
|----------|--------|
| 借记卡交易 | CardType=debit，使用DebitRate计算分润 |
| 贷记卡交易 | CardType=credit，使用CreditRate计算分润 |
| 微信/支付宝交易 | CardType正确映射，使用对应费率 |
| **带高调费率交易** | HighRate正确解析，高调分润计算正确 |
| **P+0交易** | D0Fee正确解析，P+0分润计算正确 |
| 金额转换 | 联动元×100=正确的分 |
| 幂等性 | 同一OrderNo不重复处理 |

### 8.2 流量费回调测试

| 测试场景 | 验证点 |
|----------|--------|
| 首次缴费 | SimFeeCount: 0→1，FirstTimeCashback生效 |
| 第2次缴费 | SimFeeCount: 1→2，SecondTimeCashback生效 |
| 第3次缴费 | SimFeeCount: 2→3，ThirdPlusCashback生效 |
| 第N次缴费 | SimFeeCount递增，ThirdPlusCashback持续生效 |
| 级差计算 | 自身返现-下级返现=实际入账 |

### 8.3 商户类接口测试

| 测试场景 | 验证点 |
|----------|--------|
| 商户入网 | merchants表创建记录，代理商关联正确 |
| 终端绑定 | terminals表状态更新 |
| 费率变更 | merchants表费率字段同步 |
| **修改默认费率** | UpdateMerchantRate调用通道API成功 |

### 8.4 端到端测试（PC/APP操作）

| 操作 | 验证流程 |
|------|----------|
| PC端设置默认费率 | PC调用API → 后端调用通道 → 通道返回 → 数据库更新 |
| 查看分润明细 | 交易回调入库 → 分润计算 → 查询返回正确金额 |
| 查看流量费返现 | 流量费回调 → 三档返现 → 查询返回正确档次和金额 |

---

## 九、数据表交互检查清单

### 9.1 交易回调涉及的表

| 表 | 操作 | 关键字段 |
|----|------|----------|
| transactions | INSERT | order_no, amount, card_type, rate, high_rate, d0_fee |
| profits | INSERT（触发分润后）| agent_id, profit_amount, wallet_type |
| wallets | UPDATE | balance（分润入账）|

### 9.2 流量费回调涉及的表

| 表 | 操作 | 关键字段 |
|----|------|----------|
| device_fees | INSERT | terminal_sn, fee_type, fee_amount |
| terminals | UPDATE | **sim_fee_count** += 1 |
| sim_cashback_records | INSERT | tier, cashback_amount |
| wallets | UPDATE | balance（返现入账）|

### 9.3 商户入网涉及的表

| 表 | 操作 | 关键字段 |
|----|------|----------|
| merchants | INSERT/UPDATE | merchant_no, agent_id, credit_rate, debit_rate |
| terminals | UPDATE | merchant_id, status, bound_at |

---

## 十、联动适配器实施步骤

### Step 1: 公共组件
- [ ] `common/crypto.go` - RSA+AES混合加密
- [ ] `common/amount.go` - 元分转换
- [ ] `common/response.go` - 返回"OK"

### Step 2: 联动模型定义
- [ ] `liandong/models.go` - 所有回调请求结构

### Step 3: 适配器核心方法
- [ ] ParseTransaction - **确保HighRate、D0Fee正确解析**
- [ ] ParseDeviceFee - 确保FeeType区分服务费/流量费
- [ ] ParseMerchantIncome - 检查是否携带押金信息
- [ ] ParseRateChange - 所有费率类型完整
- [ ] ParseTerminalBind
- [ ] UpdateMerchantRate - 主动调用通道API

### Step 4: 单元测试
- [ ] 覆盖上述所有测试场景
- [ ] 测试覆盖率 > 80%

### Step 5: 集成测试
- [ ] 注册到Factory
- [ ] Mock回调 → 验证分润计算
- [ ] Mock回调 → 验证流量费三档返现

---

## 十一、验证报告模板

```
## ✅ 联动通道对接验证报告

### 编译测试
- [ ] go build ./... 通过
- [ ] go test ./internal/channel/liandong/... 通过
- [ ] 测试覆盖率: ___%

### 交易回调验证
- [ ] 基础分润计算正确
- [ ] 高调分润计算正确（HighRate字段）
- [ ] P+0分润计算正确（D0Fee字段）
- [ ] 卡类型映射正确

### 流量费返现验证
- [ ] 首次返现金额正确
- [ ] 第2次返现金额正确
- [ ] 第3次及以后返现金额正确
- [ ] SimFeeCount正确递增

### 商户类接口验证
- [ ] 商户入网数据正确入库
- [ ] 终端绑定状态正确更新
- [ ] 费率变更正确同步
- [ ] UpdateMerchantRate API调用成功

### 数据库验证
- [ ] transactions表记录完整
- [ ] profits表分润记录正确
- [ ] device_fees表流量费记录正确
- [ ] terminals表SimFeeCount正确
- [ ] wallets余额变动正确
```

---

## 十二、代付类接口（优先级最低）

待通知类、商户类接口完成后再实现：
- 需新增 `ParsePayoutNotify` 方法
- 对接提现服务的 `callTaxChannelAPI` 方法

---

## 待完善事项

> 以下问题需要进一步思考和确认：

1. **其他7家通道的接口文档**：目前只有联动的文档，其他通道需获取文档后逐个分析差异
2. **特惠费率的分润计算**：POS_DISCOUNT_CC等特惠类型是否有特殊的分润规则
3. **联动高调费率字段确认**：需确认联动交易回调中的加价费率具体字段名
4. **联动P+0费用字段确认**：需确认联动交易回调中的D0费用具体字段名
5. **押金返现触发时机**：联动是在交易止付时触发，还是有单独的通知
6. **错误处理策略**：费率类型不匹配时如何处理，是否需要告警通知
