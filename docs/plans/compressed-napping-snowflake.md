# ä»£ç†å•†åˆ†æ¶¦ç®¡ç†ç³»ç»Ÿ - è®¾è®¡æ›´æ–°è®°å½•

## æ›´æ–°æ—¥æœŸ: 2025-01-18

---

## ğŸ“‹ å½“å‰çŠ¶æ€ï¼šè®¾è®¡æ–‡æ¡£å·²å®Œæˆï¼Œå‡†å¤‡å¼€å§‹åç«¯å¼€å‘

### âœ… å·²å®Œæˆçš„è®¾è®¡æ–‡æ¡£

| æ–‡æ¡£ | è·¯å¾„ | å¤§å° | å†…å®¹ |
|------|------|------|------|
| **APPè®¾è®¡ç¨¿** | `/design/APPè®¾è®¡ç¨¿.md` | 60KB | FlutteræŠ€æœ¯æ ˆã€è®¾è®¡ç³»ç»Ÿã€12ä¸ªé¡µé¢åŸå‹ã€5ä¸ªæ ¸å¿ƒç»„ä»¶ä»£ç  |
| **PCç«¯ç®¡ç†è®¾è®¡** | `/design/PCç«¯ç®¡ç†åŠŸèƒ½è¯¦ç»†è®¾è®¡.md` | 52KB | Vue3æŠ€æœ¯æ ˆã€10ä¸ªæ ¸å¿ƒé¡µé¢ã€æƒé™çŸ©é˜µã€APIè®¾è®¡ |
| **ä¸šåŠ¡é€»è¾‘æ¢³ç†** | `/design/ä¸šåŠ¡é€»è¾‘æ¢³ç†.md` | 19KB | åŸå§‹ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£ |
| **å®Œæ•´è®¾è®¡æ–¹æ¡ˆ** | `/ä»£ç†å•†åˆ†æ¶¦ç®¡ç†ç³»ç»Ÿ-å®Œæ•´è®¾è®¡æ–¹æ¡ˆ.md` | 192KB | æ•°æ®åº“è®¾è®¡ã€Goåç«¯ä»£ç ã€45+è¡¨ç»“æ„ |

### ğŸš€ ä¸‹ä¸€æ­¥ï¼šåç«¯é¡¹ç›®æ­å»º (Phase 1)

```
å¾…åˆ›å»ºçš„åç«¯é¡¹ç›®ç»“æ„:
xiangshoufu/
â”œâ”€â”€ backend/                    # Goåç«¯é¡¹ç›®
â”‚   â”œâ”€â”€ cmd/
â”‚   â”‚   â””â”€â”€ server/main.go
â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ app/               # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ agent/         # ä»£ç†å•†æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ channel/       # é€šé“ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ policy/        # æ”¿ç­–æ¨¡æ¿
â”‚   â”‚   â”‚   â”œâ”€â”€ terminal/      # ç»ˆç«¯ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ merchant/      # å•†æˆ·ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ profit/        # åˆ†æ¶¦è®¡ç®—
â”‚   â”‚   â”‚   â”œâ”€â”€ wallet/        # é’±åŒ…æ¨¡å—
â”‚   â”‚   â”‚   â””â”€â”€ deduction/     # ä»£æ‰£ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ domain/            # é¢†åŸŸæ¨¡å‹
â”‚   â”‚   â””â”€â”€ infra/             # åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ pkg/                   # å…¬å…±åŒ…
â”‚   â”œâ”€â”€ migrations/            # æ•°æ®åº“è¿ç§»
â”‚   â””â”€â”€ go.mod
â”œâ”€â”€ admin-web/                 # Vue3ç®¡ç†åå°
â””â”€â”€ mobile-app/                # Flutter APP
```

---

## åäºŒã€å®¢æˆ·ç™»è®°æ¨¡å—è¯¦ç»†è®¾è®¡ â­ (å·²æ›´æ–°)

### 12.1 åŠŸèƒ½å®šä½ï¼ˆæ›´æ­£ï¼‰

æ ¹æ®ä¸šåŠ¡é€»è¾‘æ¢³ç†æ–‡æ¡£ç¬¬173-183è¡Œçš„æ›´æ–°ï¼š

> **å®¢æˆ·ç™»è®° = å•†æˆ·ç™»è®°**ï¼ˆæ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼‰

**æ ¸å¿ƒç›®çš„**ï¼š
1. **è¡¥å……ç»´æŠ¤å•†æˆ·æ‰‹æœºå·** - é€šé“æ¨å›çš„å•†æˆ·ä¿¡æ¯æ²¡æœ‰å®Œæ•´æ‰‹æœºå·
2. **æ–¹ä¾¿è”ç³»å•†æˆ·** - å¸®åŠ©ä»£ç†å•†è”ç³»ç›´å±å•†æˆ·
3. **åˆ†ææµå¤±å•†æˆ·** - æœ‰è”ç³»æ–¹å¼æ‰èƒ½åšæµå¤±åˆ†æå’Œå¬å›
4. **é¢„ç•™çœŸå•†è¿›ä»¶** - å½“å‰åªåšå°å¾®ï¼Œåç»­æ‰©å±•çœŸå•†

### 12.2 ä¸šåŠ¡èƒŒæ™¯

```
æ”¯ä»˜äº§å“åˆ†ç±»ï¼š
â”œâ”€â”€ å°å¾®ï¼ˆä¸éœ€è¦è¿›ä»¶ï¼‰â† å½“å‰é‡å¿ƒ
â”‚   â””â”€â”€ é€šé“æ¨å›å•†æˆ·ä¿¡æ¯æ—¶æ²¡æœ‰å®Œæ•´æ‰‹æœºå·
â”‚       â””â”€â”€ éœ€è¦ã€å®¢æˆ·ç™»è®°ã€‘åŠŸèƒ½è¡¥å……ç»´æŠ¤
â”‚
â””â”€â”€ çœŸå•†ï¼ˆéœ€è¦è¿›ä»¶ï¼‰â† åç»­æ‰©å±•
    â””â”€â”€ éœ€è¦é‡‡é›†å•†æˆ·å®Œæ•´ä¿¡æ¯æ¨é€ç»™é€šé“
        â””â”€â”€ ã€å®¢æˆ·ç™»è®°ã€‘åŠŸèƒ½å‡çº§ä¸ºè¿›ä»¶å…¥å£
```

### 12.3 åŠŸèƒ½è®¾è®¡

| åŠŸèƒ½é¡¹ | è¯´æ˜ |
|--------|------|
| **æ‰‹æœºå·ç»´æŠ¤** | å°†é€šé“æ¨å›çš„å•†æˆ·ä¸ä»£ç†å•†ç™»è®°çš„æ‰‹æœºå·åŒ¹é… |
| **å¤‡æ³¨ä¿¡æ¯** | ç»´æŠ¤å•†æˆ·çš„å¤‡æ³¨è¯´æ˜ |
| **å•†æˆ·ç±»å‹** | æ˜¾ç¤ºå•†æˆ·åˆ†ç±»ï¼ˆå¿ è¯š/ä¼˜è´¨/æ½œåŠ›/ä¸€èˆ¬/ä½æ´»è·ƒ/æ— äº¤æ˜“ï¼‰|
| **åŠ å¯†å­˜å‚¨** | æ‰‹æœºå·åŠ å¯†å­˜å‚¨ï¼Œä»…å¯¹åº”ä»£ç†å•†å¯è§ |
| **ç‹¬ç«‹å…¥å£** | APPå’ŒPCç«¯éƒ½ä½œä¸ºç‹¬ç«‹åŠŸèƒ½ |

### 12.4 æ•°æ®åº“è®¾è®¡

```sql
-- å•†æˆ·æ‰‹æœºå·è¡¥å……ç™»è®°è¡¨
CREATE TABLE merchant_contact_registrations (
    id              BIGSERIAL PRIMARY KEY,
    merchant_id     BIGINT NOT NULL,              -- å…³è”å•†æˆ·ID
    agent_id        BIGINT NOT NULL,              -- ç™»è®°ä»£ç†å•†ï¼ˆä»…æ­¤ä»£ç†å•†å¯è§ï¼‰

    -- è”ç³»ä¿¡æ¯
    phone           VARCHAR(256) NOT NULL,        -- æ‰‹æœºå·ï¼ˆAESåŠ å¯†å­˜å‚¨ï¼‰
    phone_masked    VARCHAR(20),                  -- è„±æ•æ‰‹æœºå·ï¼ˆæ˜¾ç¤ºç”¨ï¼‰

    -- å¤‡æ³¨ä¿¡æ¯
    contact_name    VARCHAR(100),                 -- è”ç³»äººå§“å
    remark          TEXT,                         -- å¤‡æ³¨

    -- çŠ¶æ€
    is_matched      BOOLEAN DEFAULT FALSE,        -- æ˜¯å¦å·²åŒ¹é…é€šé“å•†æˆ·
    matched_at      TIMESTAMP,                    -- åŒ¹é…æ—¶é—´

    -- æ—¶é—´
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW(),

    CONSTRAINT fk_merchant FOREIGN KEY (merchant_id) REFERENCES merchants(id),
    CONSTRAINT fk_agent FOREIGN KEY (agent_id) REFERENCES agents(id),
    UNIQUE(merchant_id, agent_id)
);

-- åœ¨å•†æˆ·è¡¨ä¸­æ·»åŠ å­—æ®µ
ALTER TABLE merchants ADD COLUMN registered_phone VARCHAR(256);  -- ç™»è®°çš„æ‰‹æœºå·ï¼ˆåŠ å¯†ï¼‰
ALTER TABLE merchants ADD COLUMN registered_phone_masked VARCHAR(20);  -- è„±æ•æ˜¾ç¤º
ALTER TABLE merchants ADD COLUMN registered_by_agent_id BIGINT;  -- ç™»è®°äºº

-- ç´¢å¼•
CREATE INDEX idx_merchant_contact_agent ON merchant_contact_registrations(agent_id);
CREATE INDEX idx_merchant_contact_merchant ON merchant_contact_registrations(merchant_id);
```

### 12.5 ä¸šåŠ¡æµç¨‹

```
é€šé“æ¨é€å•†æˆ·ä¿¡æ¯
    â”‚ ï¼ˆæ‰‹æœºå·ä¸å®Œæ•´/æ— æ‰‹æœºå·ï¼‰
    â–¼
å•†æˆ·å…¥åº“ï¼ˆmerchantsè¡¨ï¼‰
    â”‚
    â–¼
ä»£ç†å•†APP/PCã€å®¢æˆ·ç™»è®°ã€‘
    â”‚ â”œâ”€â”€ é€‰æ‹©å•†æˆ·
    â”‚ â”œâ”€â”€ è¾“å…¥å®Œæ•´æ‰‹æœºå·
    â”‚ â””â”€â”€ æ·»åŠ å¤‡æ³¨
    â–¼
ä¿å­˜å¹¶åŠ å¯†å­˜å‚¨
    â”‚ ï¼ˆä»…è¯¥ä»£ç†å•†å¯æŸ¥çœ‹ï¼‰
    â–¼
ç”¨äºï¼š
â”œâ”€â”€ æµå¤±å•†æˆ·è”ç³»
â”œâ”€â”€ å•†æˆ·æ•°æ®åˆ†æ
â””â”€â”€ åç»­çœŸå•†è¿›ä»¶ï¼ˆé¢„ç•™ï¼‰
```

### 12.6 APPç«¯é¡µé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â†  å®¢æˆ·ç™»è®°                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ” æœç´¢å•†æˆ·åç§°/ç¼–å·/æœºå…·å·      â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  å¾…ç™»è®° (15)                 å·²ç™»è®° (45)â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ å¼ ä¸‰å•†åº—                  ğŸŸ£å¿ è¯š â”‚   â”‚
â”‚ â”‚ ç¼–å·: M001  æœºå…·: SN12345     â”‚   â”‚
â”‚ â”‚ æ‰‹æœº: æœªç™»è®°                   â”‚   â”‚
â”‚ â”‚                      [ç™»è®°]   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æå››è¶…å¸‚                  ğŸ”´æ— äº¤æ˜“â”‚   â”‚
â”‚ â”‚ ç¼–å·: M002  æœºå…·: SN12346     â”‚   â”‚
â”‚ â”‚ æ‰‹æœº: 139****8888 âœ“          â”‚   â”‚
â”‚ â”‚                      [ç¼–è¾‘]   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ç‹äº”ä¾¿åˆ©åº—                ğŸŸ ä½æ´»è·ƒâ”‚   â”‚
â”‚ â”‚ ç¼–å·: M003  æœºå…·: SN12347     â”‚   â”‚
â”‚ â”‚ æ‰‹æœº: æœªç™»è®°                   â”‚   â”‚
â”‚ â”‚                      [ç™»è®°]   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â†  ç™»è®°æ‰‹æœºå·                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  å•†æˆ·ä¿¡æ¯                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ å•†æˆ·åç§°: å¼ ä¸‰å•†åº—              â”‚   â”‚
â”‚ â”‚ å•†æˆ·ç¼–å·: M001                 â”‚   â”‚
â”‚ â”‚ æœºå…·ç¼–å·: SN12345678           â”‚   â”‚
â”‚ â”‚ å•†æˆ·ç±»å‹: ğŸŸ£å¿ è¯šå•†æˆ·            â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  è”ç³»ä¿¡æ¯                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æ‰‹æœºå· *                       â”‚   â”‚
â”‚ â”‚ [_______________]              â”‚   â”‚
â”‚ â”‚                                â”‚   â”‚
â”‚ â”‚ è”ç³»äººå§“å                      â”‚   â”‚
â”‚ â”‚ [_______________]              â”‚   â”‚
â”‚ â”‚                                â”‚   â”‚
â”‚ â”‚ å¤‡æ³¨                           â”‚   â”‚
â”‚ â”‚ [___________________]          â”‚   â”‚
â”‚ â”‚ [___________________]          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  âš ï¸ æ‰‹æœºå·ä»…æ‚¨å¯è§ï¼ŒåŠ å¯†å­˜å‚¨          â”‚
â”‚                                     â”‚
â”‚        [ä¿å­˜]                        â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.7 APIè®¾è®¡

```typescript
// è·å–å¾…ç™»è®°/å·²ç™»è®°å•†æˆ·åˆ—è¡¨
GET /api/v1/merchants/registration
Query: { registered: boolean, keyword?, page, pageSize }
Response: { total, list: MerchantWithRegistration[] }

// ç™»è®°å•†æˆ·æ‰‹æœºå·
POST /api/v1/merchants/:id/register-contact
Body: { phone, contactName?, remark? }

// æ›´æ–°ç™»è®°ä¿¡æ¯
PUT /api/v1/merchants/:id/register-contact
Body: { phone?, contactName?, remark? }

// è·å–å•†æˆ·ç™»è®°è¯¦æƒ…ï¼ˆå«è§£å¯†æ‰‹æœºå·ï¼‰
GET /api/v1/merchants/:id/contact
Response: { phone, contactName, remark, registeredAt }
// æ³¨æ„ï¼šä»…ç™»è®°äººå¯è°ƒç”¨
```

### 12.8 æƒé™æ§åˆ¶

| æ“ä½œ | æƒé™ |
|------|------|
| ç™»è®°æ‰‹æœºå· | å•†æˆ·çš„ç›´å±ä»£ç†å•† |
| æŸ¥çœ‹å®Œæ•´æ‰‹æœºå· | ä»…ç™»è®°äººï¼ˆè¯¥ä»£ç†å•†ï¼‰|
| æŸ¥çœ‹è„±æ•æ‰‹æœºå· | å•†æˆ·çš„ä¸Šçº§ä»£ç†å•†é“¾ |

### 12.9 ä¸å•†æˆ·ç®¡ç†çš„å…³ç³»

```
å•†æˆ·ç®¡ç†                              å®¢æˆ·ç™»è®°
    â”‚                                     â”‚
    â”œâ”€â”€ å•†æˆ·åˆ—è¡¨                          â”œâ”€â”€ å¾…ç™»è®°å•†æˆ·
    â”œâ”€â”€ å•†æˆ·è¯¦æƒ…                          â”œâ”€â”€ å·²ç™»è®°å•†æˆ·
    â”œâ”€â”€ è´¹ç‡è®¾ç½®                          â”œâ”€â”€ æ‰‹æœºå·ç»´æŠ¤
    â”œâ”€â”€ æŠ¼é‡‘/æµé‡å¡è®¾ç½®                    â”œâ”€â”€ å¤‡æ³¨ç»´æŠ¤
    â””â”€â”€ å•†æˆ·ç±»å‹ â†â”€â”€â”€â”€â”€å…±ç”¨â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å•†æˆ·ç±»å‹
```

### 12.10 çœŸå•†è¿›ä»¶é¢„ç•™ï¼ˆåç»­æ‰©å±•ï¼‰

```sql
-- çœŸå•†è¿›ä»¶ä¿¡æ¯è¡¨ï¼ˆé¢„ç•™ï¼Œå½“å‰ä¸å¼€å‘ï¼‰
CREATE TABLE merchant_applications (
    id              BIGSERIAL PRIMARY KEY,
    merchant_id     BIGINT,
    agent_id        BIGINT NOT NULL,

    -- è¿›ä»¶ä¿¡æ¯
    legal_name      VARCHAR(100),         -- æ³•äººå§“å
    id_card_no      VARCHAR(256),         -- èº«ä»½è¯å·ï¼ˆåŠ å¯†ï¼‰
    business_license VARCHAR(256),        -- è¥ä¸šæ‰§ç…§å·ï¼ˆåŠ å¯†ï¼‰
    bank_account    VARCHAR(256),         -- é“¶è¡Œè´¦å·ï¼ˆåŠ å¯†ï¼‰

    -- çŠ¶æ€
    status          SMALLINT DEFAULT 0,   -- 0è‰ç¨¿ 1å¾…å®¡æ ¸ 2å·²é€šè¿‡ 3å·²æ‹’ç»

    created_at      TIMESTAMP DEFAULT NOW()
);
```

---

## åä¸‰ã€å•†æˆ·åˆ†ç±»ä½“ç³»è®¾è®¡ â­ (å·²æ›´æ–°)

### 13.1 å•†æˆ·åˆ†ç±»æ ‡å‡†

æ ¹æ®ä¸šåŠ¡é€»è¾‘æ¢³ç†æ–‡æ¡£ç¬¬185-187è¡Œï¼š

> **å•†æˆ·ç®¡ç†å’Œå®¢æˆ·ç™»è®°éƒ½è¦å¢åŠ å•†æˆ·ç±»å‹**
> **ä¸€å¤©è®¡ç®—ä¸€æ¬¡å°±å¥½**

æ ¹æ®**æœˆå‡äº¤æ˜“é‡**å°†å•†æˆ·åˆ†ä¸º6ä¸ªç±»å‹ï¼š

| åˆ†ç±» | è‹±æ–‡æ ‡è¯† | æœˆå‡äº¤æ˜“é‡ | é¢œè‰²æ ‡è¯† | è¯´æ˜ |
|------|----------|------------|----------|------|
| **å¿ è¯šå•†æˆ·** | loyal | > 5ä¸‡ | ğŸŸ£ ç´«è‰² | æ ¸å¿ƒå®¢æˆ·ï¼Œé‡ç‚¹ç»´æŠ¤ |
| **ä¼˜è´¨å•†æˆ·** | premium | 3ä¸‡ â‰¤ x < 5ä¸‡ | ğŸ”µ è“è‰² | é«˜ä»·å€¼å®¢æˆ· |
| **æ½œåŠ›å•†æˆ·** | potential | 2ä¸‡ â‰¤ x < 3ä¸‡ | ğŸŸ¢ ç»¿è‰² | æœ‰å¢é•¿ç©ºé—´ |
| **ä¸€èˆ¬å•†æˆ·** | regular | 1ä¸‡ â‰¤ x < 2ä¸‡ | ğŸŸ¡ é»„è‰² | æ™®é€šå®¢æˆ· |
| **ä½æ´»è·ƒå•†æˆ·** | low_active | 0 < x < 1ä¸‡ | ğŸŸ  æ©™è‰² | éœ€è¦æ¿€æ´» |
| **30å¤©æ— äº¤æ˜“** | inactive | 30å¤©å†…æ— äº¤æ˜“ | ğŸ”´ çº¢è‰² | æµå¤±é¢„è­¦ |

### 13.2 æ•°æ®åº“è®¾è®¡

```sql
-- å•†æˆ·åˆ†ç±»æšä¸¾
-- åœ¨ merchants è¡¨ä¸­æ·»åŠ åˆ†ç±»å­—æ®µ
ALTER TABLE merchants ADD COLUMN category SMALLINT DEFAULT 0;
-- 0:æœªåˆ†ç±» 1:å¿ è¯š 2:ä¼˜è´¨ 3:æ½œåŠ› 4:ä¸€èˆ¬ 5:ä½æ´»è·ƒ 6:æ— äº¤æ˜“

-- å•†æˆ·äº¤æ˜“ç»Ÿè®¡è¡¨ï¼ˆç”¨äºåˆ†ç±»è®¡ç®—ï¼‰
CREATE TABLE merchant_trade_stats (
    id              BIGSERIAL PRIMARY KEY,
    merchant_id     BIGINT NOT NULL UNIQUE,
    channel_id      BIGINT NOT NULL,

    -- ç´¯è®¡ç»Ÿè®¡
    total_amount    DECIMAL(20,2) DEFAULT 0,      -- ç´¯è®¡äº¤æ˜“é¢
    total_count     INT DEFAULT 0,                 -- ç´¯è®¡äº¤æ˜“ç¬”æ•°

    -- æœˆåº¦ç»Ÿè®¡
    month_amount    DECIMAL(15,2) DEFAULT 0,       -- æœ¬æœˆäº¤æ˜“é¢
    month_count     INT DEFAULT 0,                 -- æœ¬æœˆäº¤æ˜“ç¬”æ•°

    -- åˆ†ç±»è®¡ç®—ç”¨
    avg_month_amount DECIMAL(15,2) DEFAULT 0,      -- æœˆå‡äº¤æ˜“é¢ï¼ˆè¿‘6ä¸ªæœˆï¼‰
    last_trade_date  DATE,                         -- æœ€åäº¤æ˜“æ—¥æœŸ
    inactive_days    INT DEFAULT 0,                -- æ— äº¤æ˜“å¤©æ•°

    -- åˆ†ç±»ç»“æœ
    category        SMALLINT DEFAULT 0,            -- å•†æˆ·åˆ†ç±»
    category_updated_at TIMESTAMP,                 -- åˆ†ç±»æ›´æ–°æ—¶é—´

    updated_at      TIMESTAMP DEFAULT NOW(),

    CONSTRAINT fk_merchant FOREIGN KEY (merchant_id) REFERENCES merchants(id)
);

-- å•†æˆ·æœˆåº¦äº¤æ˜“æ±‡æ€»è¡¨ï¼ˆå†å²è®°å½•ï¼‰
CREATE TABLE merchant_monthly_stats (
    id              BIGSERIAL PRIMARY KEY,
    merchant_id     BIGINT NOT NULL,
    stat_month      VARCHAR(7) NOT NULL,           -- æ ¼å¼: 2024-01

    trade_amount    DECIMAL(15,2) DEFAULT 0,       -- æœˆäº¤æ˜“é¢
    trade_count     INT DEFAULT 0,                 -- æœˆäº¤æ˜“ç¬”æ•°

    -- åˆ†ç±»äº¤æ˜“é¢
    credit_amount   DECIMAL(15,2) DEFAULT 0,       -- è´·è®°å¡
    debit_amount    DECIMAL(15,2) DEFAULT 0,       -- å€Ÿè®°å¡
    wechat_amount   DECIMAL(15,2) DEFAULT 0,       -- å¾®ä¿¡
    alipay_amount   DECIMAL(15,2) DEFAULT 0,       -- æ”¯ä»˜å®

    created_at      TIMESTAMP DEFAULT NOW(),

    UNIQUE(merchant_id, stat_month)
);

-- å•†æˆ·åˆ†ç±»ç»Ÿè®¡è¡¨ï¼ˆä»£ç†å•†ç»´åº¦æ±‡æ€»ï¼‰
CREATE TABLE merchant_category_stats (
    id              BIGSERIAL PRIMARY KEY,
    agent_id        BIGINT NOT NULL,
    channel_id      BIGINT,
    stat_date       DATE NOT NULL,

    -- å„åˆ†ç±»å•†æˆ·æ•°é‡
    loyal_count     INT DEFAULT 0,                 -- å¿ è¯šå•†æˆ·æ•°
    premium_count   INT DEFAULT 0,                 -- ä¼˜è´¨å•†æˆ·æ•°
    potential_count INT DEFAULT 0,                 -- æ½œåŠ›å•†æˆ·æ•°
    regular_count   INT DEFAULT 0,                 -- ä¸€èˆ¬å•†æˆ·æ•°
    low_active_count INT DEFAULT 0,                -- ä½æ´»è·ƒå•†æˆ·æ•°
    inactive_count  INT DEFAULT 0,                 -- æ— äº¤æ˜“å•†æˆ·æ•°

    total_count     INT DEFAULT 0,                 -- å•†æˆ·æ€»æ•°

    created_at      TIMESTAMP DEFAULT NOW(),

    UNIQUE(agent_id, channel_id, stat_date)
);

-- ç´¢å¼•
CREATE INDEX idx_merchant_stats_category ON merchant_trade_stats(category);
CREATE INDEX idx_merchant_stats_inactive ON merchant_trade_stats(inactive_days);
CREATE INDEX idx_merchant_monthly_month ON merchant_monthly_stats(stat_month);
CREATE INDEX idx_category_stats_agent ON merchant_category_stats(agent_id, stat_date);
```

### 13.3 åˆ†ç±»è®¡ç®—é€»è¾‘

```go
// internal/app/merchant/category_calculator.go

package merchant

import (
    "time"
    "github.com/shopspring/decimal"
)

// MerchantCategory å•†æˆ·åˆ†ç±»
type MerchantCategory int

const (
    CategoryUnknown   MerchantCategory = 0
    CategoryLoyal     MerchantCategory = 1  // å¿ è¯šå•†æˆ· > 5ä¸‡
    CategoryPremium   MerchantCategory = 2  // ä¼˜è´¨å•†æˆ· 3-5ä¸‡
    CategoryPotential MerchantCategory = 3  // æ½œåŠ›å•†æˆ· 2-3ä¸‡
    CategoryRegular   MerchantCategory = 4  // ä¸€èˆ¬å•†æˆ· 1-2ä¸‡
    CategoryLowActive MerchantCategory = 5  // ä½æ´»è·ƒ 0-1ä¸‡
    CategoryInactive  MerchantCategory = 6  // 30å¤©æ— äº¤æ˜“
)

// åˆ†ç±»é˜ˆå€¼ï¼ˆå•ä½ï¼šåˆ†ï¼‰
var categoryThresholds = map[MerchantCategory]int64{
    CategoryLoyal:     5000000,  // 5ä¸‡ = 5000000åˆ†
    CategoryPremium:   3000000,  // 3ä¸‡
    CategoryPotential: 2000000,  // 2ä¸‡
    CategoryRegular:   1000000,  // 1ä¸‡
    CategoryLowActive: 1,        // > 0
}

// CalculateCategory è®¡ç®—å•†æˆ·åˆ†ç±»
func CalculateCategory(stats *MerchantTradeStats) MerchantCategory {
    // 1. ä¼˜å…ˆåˆ¤æ–­30å¤©æ— äº¤æ˜“
    if stats.InactiveDays >= 30 {
        return CategoryInactive
    }

    // 2. æ ¹æ®æœˆå‡äº¤æ˜“é¢åˆ†ç±»
    avgAmount := stats.AvgMonthAmount // å•ä½ï¼šåˆ†

    switch {
    case avgAmount >= 5000000:  // > 5ä¸‡
        return CategoryLoyal
    case avgAmount >= 3000000:  // >= 3ä¸‡
        return CategoryPremium
    case avgAmount >= 2000000:  // >= 2ä¸‡
        return CategoryPotential
    case avgAmount >= 1000000:  // >= 1ä¸‡
        return CategoryRegular
    case avgAmount > 0:         // > 0
        return CategoryLowActive
    default:
        return CategoryInactive
    }
}

// UpdateMerchantCategories å®šæ—¶ä»»åŠ¡ï¼šæ›´æ–°æ‰€æœ‰å•†æˆ·åˆ†ç±»
func (s *MerchantService) UpdateMerchantCategories() error {
    // 1. è®¡ç®—æ¯ä¸ªå•†æˆ·è¿‘6ä¸ªæœˆçš„æœˆå‡äº¤æ˜“é¢
    sql := `
        UPDATE merchant_trade_stats mts
        SET
            avg_month_amount = (
                SELECT COALESCE(AVG(trade_amount), 0)
                FROM merchant_monthly_stats mms
                WHERE mms.merchant_id = mts.merchant_id
                AND mms.stat_month >= to_char(NOW() - interval '6 months', 'YYYY-MM')
            ),
            inactive_days = EXTRACT(DAY FROM NOW() - last_trade_date),
            updated_at = NOW()
    `

    // 2. æ ¹æ®æœˆå‡äº¤æ˜“é¢æ›´æ–°åˆ†ç±»
    // 3. æ›´æ–°ä»£ç†å•†ç»´åº¦çš„åˆ†ç±»ç»Ÿè®¡

    return nil
}
```

### 13.4 å®šæ—¶ä»»åŠ¡è®¾è®¡

```yaml
# å•†æˆ·åˆ†ç±»æ›´æ–°ä»»åŠ¡
cron:
  merchant_category_update:
    schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    description: "æ›´æ–°å•†æˆ·åˆ†ç±»"
    steps:
      - è®¡ç®—è¿‘6ä¸ªæœˆæœˆå‡äº¤æ˜“é¢
      - è®¡ç®—æ— äº¤æ˜“å¤©æ•°
      - æ›´æ–°å•†æˆ·åˆ†ç±»
      - æ±‡æ€»ä»£ç†å•†ç»´åº¦ç»Ÿè®¡
      - ç”Ÿæˆåˆ†ç±»å˜æ›´é€šçŸ¥
```

### 13.5 APPç«¯å±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â†  å•†æˆ·ç®¡ç†                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  å•†æˆ·åˆ†ç±»ç»Ÿè®¡                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ğŸŸ£  â”‚â”‚ ğŸ”µ  â”‚â”‚ ğŸŸ¢  â”‚â”‚ ğŸŸ¡  â”‚â”‚ ğŸŸ   â”‚â”‚ ğŸ”´  â”‚â”‚
â”‚ â”‚ å¿ è¯š â”‚â”‚ ä¼˜è´¨ â”‚â”‚ æ½œåŠ› â”‚â”‚ ä¸€èˆ¬ â”‚â”‚ä½æ´»è·ƒâ”‚â”‚æ— äº¤æ˜“â”‚â”‚
â”‚ â”‚ 12  â”‚â”‚ 25  â”‚â”‚ 38  â”‚â”‚ 56  â”‚â”‚ 89  â”‚â”‚ 15  â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚  åˆ†ç±»ç­›é€‰: [å…¨éƒ¨â–¼]                    â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸŸ£ å¼ ä¸‰å•†åº—                     â”‚   â”‚
â”‚ â”‚ ç¼–å·: M001  æœˆå‡: Â¥68,500      â”‚   â”‚
â”‚ â”‚ æœ¬æœˆ: Â¥72,000   çŠ¶æ€: æ´»è·ƒ     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ”´ æå››è¶…å¸‚         âš ï¸ é¢„è­¦    â”‚   â”‚
â”‚ â”‚ ç¼–å·: M002  æœ€åäº¤æ˜“: 35å¤©å‰   â”‚   â”‚
â”‚ â”‚ æœˆå‡: Â¥0       çŠ¶æ€: æ— äº¤æ˜“    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.6 PCç«¯æ•°æ®åˆ†æé¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®æŠ¥è¡¨ > å•†æˆ·åˆ†æ                                              [å¯¼å‡º]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ å•†æˆ·åˆ†ç±»åˆ†å¸ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚   å¿ è¯šå•†æˆ· â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 12 (5.1%)          â”‚ â”‚
â”‚  â”‚   ä¼˜è´¨å•†æˆ· â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 25 (10.6%)  â”‚ â”‚
â”‚  â”‚   æ½œåŠ›å•†æˆ· â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 38 (16%)â”‚ â”‚
â”‚  â”‚   ä¸€èˆ¬å•†æˆ· â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 56  â”‚ â”‚
â”‚  â”‚   ä½æ´»è·ƒ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 89â”‚ â”‚
â”‚  â”‚   æ— äº¤æ˜“   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 15 (6.4%)                                       â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ åˆ†ç±»è¶‹åŠ¿ (è¿‘6ä¸ªæœˆ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚         [æŠ˜çº¿å›¾ï¼šå„åˆ†ç±»å•†æˆ·æ•°é‡å˜åŒ–è¶‹åŠ¿]                                  â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ å•†æˆ·åˆ—è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  [åˆ†ç±»â–¼] [é€šé“â–¼] [ä»£ç†å•†â–¼] [æœç´¢________]                               â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ åˆ†ç±»  â”‚ å•†æˆ·åç§°   â”‚ æœˆå‡äº¤æ˜“   â”‚ æœ¬æœˆäº¤æ˜“   â”‚ æ‰€å±ä»£ç† â”‚ æœ€åäº¤æ˜“  â”‚ æ“ä½œ â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ğŸŸ£å¿ è¯šâ”‚ å¼ ä¸‰å•†åº—   â”‚ Â¥68,500   â”‚ Â¥72,000   â”‚ ä»£ç†A   â”‚ ä»Šå¤©     â”‚ è¯¦æƒ…â”‚ â”‚
â”‚  â”‚ ğŸ”µä¼˜è´¨â”‚ ç‹äº”è¶…å¸‚   â”‚ Â¥35,200   â”‚ Â¥38,000   â”‚ ä»£ç†B   â”‚ æ˜¨å¤©     â”‚ è¯¦æƒ…â”‚ â”‚
â”‚  â”‚ ğŸ”´æ— äº¤æ˜“â”‚ æå››ä¾¿åˆ©åº—â”‚ Â¥0        â”‚ Â¥0        â”‚ ä»£ç†A   â”‚ 35å¤©å‰   â”‚ è¯¦æƒ…â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.7 APIè®¾è®¡

```typescript
// å•†æˆ·åˆ†ç±»ç»Ÿè®¡
GET /api/v1/merchants/category-stats
Query: { agentId?, channelId? }
Response: {
    loyal: 12,
    premium: 25,
    potential: 38,
    regular: 56,
    lowActive: 89,
    inactive: 15,
    total: 235
}

// å•†æˆ·åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†ç±»ç­›é€‰ï¼‰
GET /api/v1/merchants
Query: { category?, channelId?, agentId?, keyword?, page, pageSize }
Response: { total, list: Merchant[] }

// å•†æˆ·åˆ†ç±»è¶‹åŠ¿
GET /api/v1/merchants/category-trend
Query: { agentId?, months: 6 }
Response: {
    months: ["2024-01", "2024-02", ...],
    data: {
        loyal: [10, 11, 12, ...],
        premium: [22, 24, 25, ...],
        ...
    }
}

// è§¦å‘åˆ†ç±»æ›´æ–°ï¼ˆæ‰‹åŠ¨ï¼‰
POST /api/v1/merchants/recalculate-categories
```

### 13.8 Flutter ç»„ä»¶

```dart
// lib/shared/widgets/tags/merchant_category_tag.dart

enum MerchantCategory {
  loyal,      // å¿ è¯š
  premium,    // ä¼˜è´¨
  potential,  // æ½œåŠ›
  regular,    // ä¸€èˆ¬
  lowActive,  // ä½æ´»è·ƒ
  inactive,   // æ— äº¤æ˜“
}

class MerchantCategoryTag extends StatelessWidget {
  final MerchantCategory category;

  const MerchantCategoryTag({super.key, required this.category});

  String get _label {
    switch (category) {
      case MerchantCategory.loyal:
        return 'å¿ è¯šå•†æˆ·';
      case MerchantCategory.premium:
        return 'ä¼˜è´¨å•†æˆ·';
      case MerchantCategory.potential:
        return 'æ½œåŠ›å•†æˆ·';
      case MerchantCategory.regular:
        return 'ä¸€èˆ¬å•†æˆ·';
      case MerchantCategory.lowActive:
        return 'ä½æ´»è·ƒ';
      case MerchantCategory.inactive:
        return 'æ— äº¤æ˜“';
    }
  }

  Color get _color {
    switch (category) {
      case MerchantCategory.loyal:
        return const Color(0xFF8B5CF6);  // ç´«è‰²
      case MerchantCategory.premium:
        return const Color(0xFF3B82F6);  // è“è‰²
      case MerchantCategory.potential:
        return const Color(0xFF10B981);  // ç»¿è‰²
      case MerchantCategory.regular:
        return const Color(0xFFF59E0B);  // é»„è‰²
      case MerchantCategory.lowActive:
        return const Color(0xFFF97316);  // æ©™è‰²
      case MerchantCategory.inactive:
        return const Color(0xFFEF4444);  // çº¢è‰²
    }
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        color: _color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(4),
      ),
      child: Text(
        _label,
        style: TextStyle(
          fontSize: 12,
          fontWeight: FontWeight.w500,
          color: _color,
        ),
      ),
    );
  }
}
```

---

## åå…­ã€æ”¶äº«ä»˜æ¶æ„è®¾è®¡ â­ (æ–°å¢)

### 16.1 æ ¸å¿ƒé—®é¢˜åˆ†æ

| é—®é¢˜ | è§£ç­” |
|------|------|
| **åŸå§‹æ•°æ®æ˜¯å¦ä¿ç•™ï¼Ÿ** | âœ… å¿…é¡»ä¿ç•™ï¼Œç”¨äºå¯¹è´¦ã€å®¡è®¡ã€é—®é¢˜è¿½æº¯ |
| **ä¿ç•™åœ¨å“ªé‡Œï¼Ÿ** | åˆ†å±‚å­˜å‚¨ï¼šçƒ­æ•°æ®(DB) â†’ æ¸©æ•°æ®(å½’æ¡£è¡¨) â†’ å†·æ•°æ®(OSS) |
| **ä¿ç•™å¤šä¹…ï¼Ÿ** | çƒ­æ•°æ®30å¤©ï¼Œæ¸©æ•°æ®1å¹´ï¼Œå†·æ•°æ®æ°¸ä¹…ï¼ˆæˆ–æŒ‰æ³•è§„è¦æ±‚ï¼‰ |
| **æœåŠ¡å™¨å‹åŠ›ï¼Ÿ** | é‡‡ç”¨å¼‚æ­¥å¤„ç†+æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå‰Šå³°å¡«è°· |
| **å¦‚ä½•ä¿è¯æ€§èƒ½ï¼Ÿ** | åˆ†åº“åˆ†è¡¨+è¯»å†™åˆ†ç¦»+ç¼“å­˜ |

### 16.2 é€šé“é€‚é…å™¨æ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   é€šé“ç½‘å…³                        â”‚
                    â”‚  (ç»Ÿä¸€å…¥å£ã€é‰´æƒã€é™æµã€æ—¥å¿—)                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚       â”‚       â”‚           â”‚           â”‚
        â–¼           â–¼           â–¼       â–¼       â–¼           â–¼           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â” ... â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”
    â”‚æ‹‰å¡æ‹‰  â”‚   â”‚éšè¡Œä»˜  â”‚   â”‚ é€šé“3 â”‚     â”‚ é€šé“6 â”‚   â”‚ é€šé“7 â”‚   â”‚ é€šé“8 â”‚
    â”‚Adapterâ”‚   â”‚Adapterâ”‚   â”‚Adapterâ”‚     â”‚Adapterâ”‚   â”‚Adapterâ”‚   â”‚Adapterâ”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
        â”‚           â”‚           â”‚             â”‚           â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   ç»Ÿä¸€æ•°æ®æ ¼å¼è½¬æ¢      â”‚
                            â”‚  (ChannelTransaction)  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚     æ¶ˆæ¯é˜Ÿåˆ— (MQ)      â”‚
                            â”‚   (RabbitMQ/Kafka)    â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                   â–¼                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  äº¤æ˜“å…¥åº“    â”‚     â”‚  åˆ†æ¶¦è®¡ç®—    â”‚     â”‚  æ¶ˆæ¯é€šçŸ¥    â”‚
            â”‚  Consumer   â”‚     â”‚  Consumer   â”‚     â”‚  Consumer   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 16.3 é€šé“é€‚é…å™¨è®¾è®¡æ¨¡å¼

```go
// internal/channel/adapter.go

// ChannelAdapter é€šé“é€‚é…å™¨æ¥å£
type ChannelAdapter interface {
    // åŸºæœ¬ä¿¡æ¯
    GetChannelCode() string
    GetChannelName() string

    // æ•°æ®æ¥æ”¶
    ReceiveTransaction(raw []byte) (*ChannelTransaction, error)
    ReceiveMerchant(raw []byte) (*ChannelMerchant, error)

    // æ•°æ®æ¨é€
    PushMerchantRate(merchantID string, rate float64) error
    PushTerminalConfig(terminalSN string, config *TerminalConfig) error

    // ç­¾åéªŒè¯
    VerifySign(data []byte, sign string) bool
    GenerateSign(data []byte) string
}

// ChannelTransaction ç»Ÿä¸€äº¤æ˜“æ•°æ®ç»“æ„
type ChannelTransaction struct {
    // é€šé“ä¿¡æ¯
    ChannelCode     string    `json:"channel_code"`
    ChannelTxNo     string    `json:"channel_tx_no"`     // é€šé“äº¤æ˜“å·

    // äº¤æ˜“ä¿¡æ¯
    MerchantNo      string    `json:"merchant_no"`       // å•†æˆ·å·
    TerminalSN      string    `json:"terminal_sn"`       // ç»ˆç«¯å·
    Amount          int64     `json:"amount"`            // é‡‘é¢ï¼ˆåˆ†ï¼‰
    Fee             int64     `json:"fee"`               // æ‰‹ç»­è´¹ï¼ˆåˆ†ï¼‰
    Rate            float64   `json:"rate"`              // è´¹ç‡

    // äº¤æ˜“ç±»å‹
    TradeType       int       `json:"trade_type"`        // 1åˆ·å¡ 2æ‰«ç  3äº‘é—ªä»˜...
    CardType        int       `json:"card_type"`         // 1è´·è®° 2å€Ÿè®°
    PayChannel      string    `json:"pay_channel"`       // wechat/alipay/unionpay

    // æ—¶é—´
    TradeTime       time.Time `json:"trade_time"`
    SettleTime      time.Time `json:"settle_time"`

    // åŸå§‹æ•°æ®
    RawData         string    `json:"raw_data"`          // åŸå§‹æŠ¥æ–‡ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
}

// æ‹‰å¡æ‹‰é€‚é…å™¨å®ç°
type LakalaAdapter struct {
    appID     string
    appSecret string
    baseURL   string
}

func (a *LakalaAdapter) GetChannelCode() string {
    return "lakala"
}

func (a *LakalaAdapter) ReceiveTransaction(raw []byte) (*ChannelTransaction, error) {
    // 1. è§£ææ‹‰å¡æ‹‰ç‰¹æœ‰çš„æŠ¥æ–‡æ ¼å¼
    var lakalaData LakalaTransactionData
    if err := json.Unmarshal(raw, &lakalaData); err != nil {
        return nil, err
    }

    // 2. è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
    return &ChannelTransaction{
        ChannelCode: "lakala",
        ChannelTxNo: lakalaData.OrderNo,
        Amount:      lakalaData.TotalAmount,
        // ... å­—æ®µæ˜ å°„
        RawData:     string(raw), // ä¿ç•™åŸå§‹æ•°æ®
    }, nil
}

// éšè¡Œä»˜é€‚é…å™¨å®ç°
type SuixingfuAdapter struct {
    merchantNo string
    signKey    string
    baseURL    string
}

// ... ç±»ä¼¼å®ç°

// é€‚é…å™¨å·¥å‚
func NewChannelAdapter(channelCode string, config *ChannelConfig) ChannelAdapter {
    switch channelCode {
    case "lakala":
        return &LakalaAdapter{...}
    case "suixingfu":
        return &SuixingfuAdapter{...}
    // ... å…¶ä»–é€šé“
    default:
        return nil
    }
}
```

### 16.4 æ•°æ®å­˜å‚¨åˆ†å±‚ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  çƒ­æ•°æ® (Hot) - PostgreSQLä¸»åº“                                          â”‚
â”‚  â”œâ”€â”€ ä¿ç•™æœŸé™: 30å¤©                                                     â”‚
â”‚  â”œâ”€â”€ å­˜å‚¨å†…å®¹: æœ€è¿‘30å¤©çš„äº¤æ˜“æµæ°´                                        â”‚
â”‚  â”œâ”€â”€ è®¿é—®é¢‘ç‡: é«˜ï¼ˆå®æ—¶æŸ¥è¯¢ã€åˆ†æ¶¦è®¡ç®—ï¼‰                                   â”‚
â”‚  â””â”€â”€ ç´¢å¼•: å…¨é‡ç´¢å¼•ï¼Œæ”¯æŒå¿«é€ŸæŸ¥è¯¢                                        â”‚
â”‚                                                                         â”‚
â”‚  æ¸©æ•°æ® (Warm) - PostgreSQLå½’æ¡£è¡¨/åˆ†åŒº                                   â”‚
â”‚  â”œâ”€â”€ ä¿ç•™æœŸé™: 1å¹´                                                      â”‚
â”‚  â”œâ”€â”€ å­˜å‚¨å†…å®¹: 30å¤©-1å¹´çš„å†å²äº¤æ˜“                                        â”‚
â”‚  â”œâ”€â”€ è®¿é—®é¢‘ç‡: ä¸­ï¼ˆæŠ¥è¡¨æŸ¥è¯¢ã€å¯¹è´¦ï¼‰                                       â”‚
â”‚  â””â”€â”€ ç´¢å¼•: éƒ¨åˆ†ç´¢å¼•ï¼ŒæŒ‰æ—¶é—´åˆ†åŒº                                          â”‚
â”‚                                                                         â”‚
â”‚  å†·æ•°æ® (Cold) - é˜¿é‡Œäº‘OSS                                               â”‚
â”‚  â”œâ”€â”€ ä¿ç•™æœŸé™: æ°¸ä¹…ï¼ˆæˆ–æŒ‰æ³•è§„è¦æ±‚5-7å¹´ï¼‰                                  â”‚
â”‚  â”œâ”€â”€ å­˜å‚¨å†…å®¹: 1å¹´ä»¥ä¸Šçš„å†å²æ•°æ®                                         â”‚
â”‚  â”œâ”€â”€ è®¿é—®é¢‘ç‡: ä½ï¼ˆå®¡è®¡ã€ç‰¹æ®ŠæŸ¥è¯¢ï¼‰                                       â”‚
â”‚  â””â”€â”€ æ ¼å¼: Parquet/JSONå‹ç¼©å­˜å‚¨                                         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 16.5 æ•°æ®åº“è®¾è®¡ï¼ˆåŸå§‹æ•°æ®ä¿ç•™ï¼‰

```sql
-- åŸå§‹äº¤æ˜“æŠ¥æ–‡è¡¨ï¼ˆä¿ç•™é€šé“åŸå§‹æ•°æ®ï¼‰
CREATE TABLE channel_raw_messages (
    id              BIGSERIAL PRIMARY KEY,
    channel_code    VARCHAR(50) NOT NULL,         -- é€šé“ç¼–ç 
    message_type    SMALLINT NOT NULL,            -- 1äº¤æ˜“ 2å•†æˆ· 3ç»ˆç«¯ 4å…¶ä»–
    message_id      VARCHAR(100) NOT NULL,        -- æ¶ˆæ¯å”¯ä¸€ID

    -- åŸå§‹æ•°æ®
    raw_content     TEXT NOT NULL,                -- åŸå§‹æŠ¥æ–‡ï¼ˆåŠ å¯†ï¼‰
    content_hash    VARCHAR(64) NOT NULL,         -- å†…å®¹å“ˆå¸Œï¼ˆé˜²ç¯¡æ”¹ï¼‰

    -- å¤„ç†çŠ¶æ€
    process_status  SMALLINT DEFAULT 0,           -- 0å¾…å¤„ç† 1æˆåŠŸ 2å¤±è´¥
    process_result  TEXT,                         -- å¤„ç†ç»“æœ/é”™è¯¯ä¿¡æ¯
    retry_count     INT DEFAULT 0,                -- é‡è¯•æ¬¡æ•°

    -- æ—¶é—´
    received_at     TIMESTAMP DEFAULT NOW(),      -- æ¥æ”¶æ—¶é—´
    processed_at    TIMESTAMP,                    -- å¤„ç†æ—¶é—´

    -- åˆ†åŒºé”®
    created_date    DATE DEFAULT CURRENT_DATE
) PARTITION BY RANGE (created_date);

-- æŒ‰æœˆåˆ†åŒºï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
CREATE TABLE channel_raw_messages_2024_01
    PARTITION OF channel_raw_messages
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- äº¤æ˜“æµæ°´è¡¨ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰
CREATE TABLE transactions (
    id              BIGSERIAL PRIMARY KEY,
    tx_no           VARCHAR(32) NOT NULL UNIQUE,  -- ç³»ç»Ÿäº¤æ˜“å·

    -- é€šé“ä¿¡æ¯
    channel_id      BIGINT NOT NULL,
    channel_tx_no   VARCHAR(100) NOT NULL,        -- é€šé“äº¤æ˜“å·
    raw_message_id  BIGINT,                       -- å…³è”åŸå§‹æŠ¥æ–‡ID

    -- å•†æˆ·ç»ˆç«¯
    merchant_id     BIGINT NOT NULL,
    terminal_id     BIGINT NOT NULL,
    agent_id        BIGINT NOT NULL,              -- ç›´å±ä»£ç†å•†

    -- äº¤æ˜“ä¿¡æ¯
    amount          BIGINT NOT NULL,              -- é‡‘é¢ï¼ˆåˆ†ï¼‰
    fee             BIGINT NOT NULL,              -- æ‰‹ç»­è´¹ï¼ˆåˆ†ï¼‰
    rate            DECIMAL(10,6) NOT NULL,       -- è´¹ç‡

    -- äº¤æ˜“ç±»å‹
    trade_type      SMALLINT NOT NULL,            -- 1æ™®é€š 2æŠ¼é‡‘ 3æµé‡è´¹ 4é€€æ¬¾
    card_type       SMALLINT,                     -- 1è´·è®° 2å€Ÿè®°
    pay_channel     VARCHAR(20),                  -- wechat/alipay/card

    -- T+0
    is_t0           BOOLEAN DEFAULT FALSE,
    t0_fee          BIGINT DEFAULT 0,

    -- æ—¶é—´
    trade_time      TIMESTAMP NOT NULL,
    settle_time     TIMESTAMP,

    -- åˆ†æ¶¦å¤„ç†
    profit_status   SMALLINT DEFAULT 0,           -- 0å¾…è®¡ç®— 1å·²è®¡ç®— 2å·²å‘æ”¾
    profit_calc_at  TIMESTAMP,

    -- åˆ†åŒºé”®
    created_date    DATE DEFAULT CURRENT_DATE
) PARTITION BY RANGE (created_date);

-- äº¤æ˜“å½’æ¡£è¡¨ï¼ˆè¶…è¿‡30å¤©çš„æ•°æ®ï¼‰
CREATE TABLE transactions_archive (
    LIKE transactions INCLUDING ALL
) PARTITION BY RANGE (created_date);

-- ç´¢å¼•
CREATE INDEX idx_raw_msg_channel ON channel_raw_messages(channel_code, created_date);
CREATE INDEX idx_raw_msg_status ON channel_raw_messages(process_status) WHERE process_status != 1;
CREATE INDEX idx_tx_merchant ON transactions(merchant_id, trade_time);
CREATE INDEX idx_tx_agent ON transactions(agent_id, trade_time);
CREATE INDEX idx_tx_profit ON transactions(profit_status) WHERE profit_status = 0;
```

### 16.6 æ•°æ®å½’æ¡£ä»»åŠ¡

```go
// internal/job/archive_job.go

// ArchiveJob æ•°æ®å½’æ¡£ä»»åŠ¡
type ArchiveJob struct {
    db        *gorm.DB
    ossClient *oss.Client
}

// Run æ¯å¤©å‡Œæ™¨æ‰§è¡Œ
func (j *ArchiveJob) Run() error {
    // 1. å½’æ¡£30å¤©å‰çš„äº¤æ˜“æ•°æ®åˆ°å½’æ¡£è¡¨
    err := j.archiveOldTransactions(30)
    if err != nil {
        return err
    }

    // 2. å½’æ¡£1å¹´å‰çš„æ•°æ®åˆ°OSS
    err = j.archiveToOSS(365)
    if err != nil {
        return err
    }

    // 3. æ¸…ç†å·²å½’æ¡£çš„åŸå§‹æŠ¥æ–‡
    err = j.cleanupRawMessages(30)
    if err != nil {
        return err
    }

    return nil
}

func (j *ArchiveJob) archiveOldTransactions(days int) error {
    cutoffDate := time.Now().AddDate(0, 0, -days)

    // æ‰¹é‡è¿ç§»åˆ°å½’æ¡£è¡¨
    sql := `
        INSERT INTO transactions_archive
        SELECT * FROM transactions
        WHERE created_date < $1
        ON CONFLICT DO NOTHING
    `
    j.db.Exec(sql, cutoffDate)

    // åˆ é™¤å·²å½’æ¡£æ•°æ®
    j.db.Exec(`DELETE FROM transactions WHERE created_date < $1`, cutoffDate)

    return nil
}

func (j *ArchiveJob) archiveToOSS(days int) error {
    cutoffDate := time.Now().AddDate(0, 0, -days)

    // æŒ‰æœˆå¯¼å‡ºåˆ°OSS
    // æ ¼å¼: /archive/transactions/2023/01/data.parquet

    return nil
}
```

### 16.7 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 1. æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°

```yaml
# æ¶ˆæ¯é˜Ÿåˆ—é…ç½®
rabbitmq:
  queues:
    # äº¤æ˜“æ•°æ®é˜Ÿåˆ—ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
    transaction_queue:
      durable: true
      prefetch_count: 100      # é¢„å–æ•°é‡
      consumer_count: 5        # æ¶ˆè´¹è€…æ•°é‡

    # åˆ†æ¶¦è®¡ç®—é˜Ÿåˆ—
    profit_calc_queue:
      durable: true
      prefetch_count: 50
      consumer_count: 3

    # æ¶ˆæ¯é€šçŸ¥é˜Ÿåˆ—ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
    notification_queue:
      durable: true
      prefetch_count: 200
      consumer_count: 2
```

#### 2. æ•°æ®åº“ä¼˜åŒ–

```sql
-- è¯»å†™åˆ†ç¦»é…ç½®
-- å†™æ“ä½œ â†’ ä¸»åº“
-- è¯»æ“ä½œ â†’ ä»åº“ï¼ˆæŠ¥è¡¨æŸ¥è¯¢ç­‰ï¼‰

-- è¿æ¥æ± é…ç½®
-- max_connections: 100
-- idle_connections: 10

-- è¡¨åˆ†åŒºç­–ç•¥
-- äº¤æ˜“è¡¨æŒ‰å¤©åˆ†åŒº
-- åŸå§‹æŠ¥æ–‡è¡¨æŒ‰æœˆåˆ†åŒº

-- æ‰¹é‡æ’å…¥ä¼˜åŒ–
-- ä½¿ç”¨ COPY å‘½ä»¤æ‰¹é‡æ’å…¥
-- äº‹åŠ¡æ‰¹æ¬¡: 1000æ¡/æ‰¹
```

#### 3. ç¼“å­˜ç­–ç•¥

```go
// Redisç¼“å­˜é…ç½®
type CacheConfig struct {
    // å•†æˆ·ä¿¡æ¯ç¼“å­˜ (10åˆ†é’Ÿ)
    MerchantTTL: 10 * time.Minute,

    // ä»£ç†å•†ä¿¡æ¯ç¼“å­˜ (10åˆ†é’Ÿ)
    AgentTTL: 10 * time.Minute,

    // æ”¿ç­–æ¨¡æ¿ç¼“å­˜ (5åˆ†é’Ÿ)
    PolicyTTL: 5 * time.Minute,

    // è´¹ç‡ç¼“å­˜ (1åˆ†é’Ÿ)
    RateTTL: 1 * time.Minute,
}
```

### 16.8 é€šé“å¯¹æ¥å¼€å‘æµç¨‹

```
8é€šé“å¯¹æ¥å¼€å‘è®¡åˆ’ (æ€»è®¡çº¦6å‘¨)

Week 1-2: åŸºç¡€æ¡†æ¶
â”œâ”€â”€ é€šé“ç½‘å…³å¼€å‘
â”œâ”€â”€ é€‚é…å™¨æ¥å£å®šä¹‰
â”œâ”€â”€ æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ
â”œâ”€â”€ åŸå§‹æ•°æ®å­˜å‚¨
â””â”€â”€ ç»Ÿä¸€æ•°æ®æ ¼å¼è®¾è®¡

Week 3-4: æ ¸å¿ƒé€šé“
â”œâ”€â”€ æ‹‰å¡æ‹‰é€‚é…å™¨ (å‚è€ƒé‡æœ€å¤§)
â”œâ”€â”€ éšè¡Œä»˜é€‚é…å™¨
â”œâ”€â”€ è”è°ƒæµ‹è¯•
â””â”€â”€ åˆ†æ¶¦è®¡ç®—éªŒè¯

Week 5: å…¶ä»–é€šé“
â”œâ”€â”€ é€šé“3-5é€‚é…å™¨
â”œâ”€â”€ å•å…ƒæµ‹è¯•
â””â”€â”€ é›†æˆæµ‹è¯•

Week 6: æ”¶å°¾é€šé“
â”œâ”€â”€ é€šé“6-8é€‚é…å™¨
â”œâ”€â”€ å‹åŠ›æµ‹è¯•
â”œâ”€â”€ å¼‚å¸¸åœºæ™¯æµ‹è¯•
â””â”€â”€ ä¸Šçº¿å‡†å¤‡
```

### 16.9 é€šé“å¯¹æ¥æ£€æŸ¥æ¸…å•

æ¯ä¸ªé€šé“å¯¹æ¥éœ€è¦å®Œæˆï¼š

| æ£€æŸ¥é¡¹ | è¯´æ˜ |
|--------|------|
| â˜ è·å–æ¥å£æ–‡æ¡£ | ç¡®è®¤æ–‡æ¡£ç‰ˆæœ¬å’Œå®Œæ•´æ€§ |
| â˜ ç”³è¯·æµ‹è¯•ç¯å¢ƒ | è·å–æµ‹è¯•å•†æˆ·å·ã€å¯†é’¥ |
| â˜ ç­¾åéªŒè¯ | å®ç°ç­¾åç”Ÿæˆå’ŒéªŒè¯ |
| â˜ äº¤æ˜“æ•°æ®æ¥æ”¶ | å›è°ƒæ¥å£æˆ–ä¸»åŠ¨æ‹‰å– |
| â˜ å•†æˆ·æ•°æ®åŒæ­¥ | å•†æˆ·ä¿¡æ¯æ¨é€/æ‹‰å– |
| â˜ ç»ˆç«¯é…ç½®æ¨é€ | è´¹ç‡ã€æŠ¼é‡‘ã€æµé‡å¡è®¾ç½® |
| â˜ æ•°æ®æ ¼å¼è½¬æ¢ | è½¬ä¸ºç»Ÿä¸€ChannelTransaction |
| â˜ å¼‚å¸¸å¤„ç† | è¶…æ—¶ã€é‡è¯•ã€å‘Šè­¦ |
| â˜ å•å…ƒæµ‹è¯• | è¦†ç›–ä¸»è¦åœºæ™¯ |
| â˜ è”è°ƒæµ‹è¯• | ä¸é€šé“æ–¹è”è°ƒ |

### 16.10 æœåŠ¡å™¨å‹åŠ›è¯„ä¼°

#### æ—¥äº¤æ˜“é‡å‡è®¾

| æŒ‡æ ‡ | åˆæœŸ | ä¸­æœŸ | åæœŸ |
|------|------|------|------|
| æ—¥äº¤æ˜“ç¬”æ•° | 5,000 | 50,000 | 500,000 |
| å³°å€¼QPS | 10 | 100 | 1,000 |
| æ—¥æ•°æ®é‡ | 50MB | 500MB | 5GB |
| æœˆæ•°æ®é‡ | 1.5GB | 15GB | 150GB |

#### æœåŠ¡å™¨é…ç½®å»ºè®®

| é˜¶æ®µ | é…ç½® | æœˆæˆæœ¬ |
|------|------|--------|
| **åˆæœŸ** | 2æ ¸4GÃ—1 + RDSåŸºç¡€ç‰ˆ | Â¥500 |
| **ä¸­æœŸ** | 4æ ¸8GÃ—2 + RDSæ ‡å‡†ç‰ˆ + Redis | Â¥2,000 |
| **åæœŸ** | 8æ ¸16GÃ—4 + RDSé«˜å¯ç”¨ + MQ | Â¥8,000+ |

#### æ€§èƒ½æŒ‡æ ‡ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| äº¤æ˜“æ¥æ”¶å“åº” | < 100ms |
| åˆ†æ¶¦è®¡ç®—å»¶è¿Ÿ | < 5s |
| é¡µé¢æŸ¥è¯¢å“åº” | < 500ms |
| ç³»ç»Ÿå¯ç”¨æ€§ | > 99.9% |

---

### 14.1 åŠŸèƒ½æ¦‚è¿°

æ ¹æ®ä¸šåŠ¡é€»è¾‘æ¢³ç†æ–‡æ¡£ç¬¬252-256è¡Œï¼š

| å¹³å° | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| **APPç«¯** | ä¸šåŠ¡æé†’ | åˆ†æ¶¦/æ³¨å†Œ/æ¶ˆè´¹æé†’ï¼ŒèŠ‚å‡æ—¥æé†’ |
| **APPç«¯** | æ¶ˆæ¯ç®¡ç† | å†å²æ¶ˆæ¯æŸ¥çœ‹ |
| **APPç«¯** | æ¶ˆæ¯æœ‰æ•ˆæœŸ | **3å¤©æœ‰æ•ˆæœŸ**ï¼ŒæœªæŸ¥çœ‹ä¸€ç›´æ´»è·ƒ |
| **PCç«¯** | ç™»å½•å¼¹çª— | æé†’æœ€è¿‘é‡è¦æ›´æ–°å†…å®¹ |

### 14.2 æ¶ˆæ¯ç±»å‹

| ç±»å‹ | æ ‡è¯† | è§¦å‘æ¡ä»¶ | å†…å®¹ç¤ºä¾‹ |
|------|------|----------|----------|
| **åˆ†æ¶¦åˆ°è´¦** | profit | åˆ†æ¶¦å…¥è´¦æ—¶ | "æ‚¨æœ‰ä¸€ç¬”Â¥8.00çš„äº¤æ˜“åˆ†æ¶¦å·²å…¥è´¦" |
| **æ–°ä»£ç†æ³¨å†Œ** | register | ä¸‹çº§æ³¨å†ŒæˆåŠŸ | "æå››(139****9999)å·²æ³¨å†Œæˆä¸ºæ‚¨çš„ä¸‹çº§ä»£ç†" |
| **äº¤æ˜“é€šçŸ¥** | transaction | å•†æˆ·äº¤æ˜“å®Œæˆ | "å•†æˆ·å¼ ä¸‰å•†åº—å®Œæˆä¸€ç¬”Â¥1,500åˆ·å¡äº¤æ˜“" |
| **èŠ‚å‡æ—¥æé†’** | holiday | ç³»ç»Ÿå®šæ—¶å‘é€ | "ç¥æ‚¨æ˜¥èŠ‚å¿«ä¹ï¼" |
| **ç³»ç»Ÿå…¬å‘Š** | announcement | åå°å‘é€ | "ç³»ç»Ÿå°†äº1æœˆ25æ—¥è¿›è¡Œå‡çº§ç»´æŠ¤" |

### 14.3 æ¶ˆæ¯æœ‰æ•ˆæœŸè§„åˆ™

```
æ¶ˆæ¯åˆ›å»º
    â”‚
    â–¼
çŠ¶æ€: æœªè¯» + æ´»è·ƒ
    â”‚
    â”œâ”€â”€ 3å¤©å†…ç”¨æˆ·æŸ¥çœ‹ â†’ çŠ¶æ€: å·²è¯»
    â”‚
    â””â”€â”€ 3å¤©å†…æœªæŸ¥çœ‹ â†’ æ¶ˆæ¯è¿‡æœŸï¼ˆä¸å†æ˜¾ç¤ºæˆ–æ ‡è®°å·²è¿‡æœŸï¼‰
```

### 14.4 æ•°æ®åº“è®¾è®¡

```sql
-- æ¶ˆæ¯ç±»å‹è¡¨ï¼ˆç³»ç»Ÿé…ç½®ï¼‰
CREATE TABLE message_types (
    id              BIGSERIAL PRIMARY KEY,
    type_code       VARCHAR(50) NOT NULL UNIQUE,  -- profit/register/transactionç­‰
    type_name       VARCHAR(100) NOT NULL,        -- ç±»å‹åç§°
    icon            VARCHAR(50),                  -- å›¾æ ‡
    is_enabled      BOOLEAN DEFAULT TRUE,
    created_at      TIMESTAMP DEFAULT NOW()
);

-- æ¶ˆæ¯è¡¨
CREATE TABLE messages (
    id              BIGSERIAL PRIMARY KEY,
    message_no      VARCHAR(32) NOT NULL UNIQUE,  -- æ¶ˆæ¯ç¼–å·

    -- å‘é€ç›®æ ‡
    agent_id        BIGINT NOT NULL,              -- æ¥æ”¶ä»£ç†å•†
    channel_id      BIGINT,                       -- å…³è”é€šé“

    -- æ¶ˆæ¯å†…å®¹
    type_code       VARCHAR(50) NOT NULL,         -- æ¶ˆæ¯ç±»å‹
    title           VARCHAR(200) NOT NULL,        -- æ¶ˆæ¯æ ‡é¢˜
    content         TEXT NOT NULL,                -- æ¶ˆæ¯å†…å®¹
    extra_data      JSONB,                        -- æ‰©å±•æ•°æ®ï¼ˆäº¤æ˜“IDã€é‡‘é¢ç­‰ï¼‰

    -- çŠ¶æ€
    is_read         BOOLEAN DEFAULT FALSE,        -- æ˜¯å¦å·²è¯»
    read_at         TIMESTAMP,                    -- é˜…è¯»æ—¶é—´

    -- æœ‰æ•ˆæœŸ
    expire_at       TIMESTAMP NOT NULL,           -- è¿‡æœŸæ—¶é—´ï¼ˆåˆ›å»ºæ—¶é—´+3å¤©ï¼‰
    is_expired      BOOLEAN DEFAULT FALSE,        -- æ˜¯å¦å·²è¿‡æœŸ

    -- æ¨é€
    is_pushed       BOOLEAN DEFAULT FALSE,        -- æ˜¯å¦å·²æ¨é€
    pushed_at       TIMESTAMP,                    -- æ¨é€æ—¶é—´

    created_at      TIMESTAMP DEFAULT NOW(),

    CONSTRAINT fk_agent FOREIGN KEY (agent_id) REFERENCES agents(id)
);

-- ç³»ç»Ÿå…¬å‘Šè¡¨ï¼ˆPCç«¯å¼¹çª—ç”¨ï¼‰
CREATE TABLE system_announcements (
    id              BIGSERIAL PRIMARY KEY,
    title           VARCHAR(200) NOT NULL,
    content         TEXT NOT NULL,
    announce_type   SMALLINT NOT NULL,            -- 1ç³»ç»Ÿæ›´æ–° 2æ”¿ç­–å˜æ›´ 3é‡è¦é€šçŸ¥
    is_force_read   BOOLEAN DEFAULT FALSE,        -- æ˜¯å¦å¼ºåˆ¶é˜…è¯»

    -- å±•ç¤ºèŒƒå›´
    target_type     SMALLINT DEFAULT 0,           -- 0å…¨éƒ¨ 1ä»…PC 2ä»…APP
    target_roles    VARCHAR(100),                 -- ç›®æ ‡è§’è‰²ï¼Œé€—å·åˆ†éš”

    -- æœ‰æ•ˆæœŸ
    start_time      TIMESTAMP,
    end_time        TIMESTAMP,
    status          SMALLINT DEFAULT 1,           -- 1å¯ç”¨ 0ç¦ç”¨

    created_at      TIMESTAMP DEFAULT NOW()
);

-- å…¬å‘Šé˜…è¯»è®°å½•è¡¨
CREATE TABLE announcement_reads (
    id              BIGSERIAL PRIMARY KEY,
    announcement_id BIGINT NOT NULL,
    user_id         BIGINT NOT NULL,
    read_at         TIMESTAMP DEFAULT NOW(),

    UNIQUE(announcement_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_messages_agent ON messages(agent_id);
CREATE INDEX idx_messages_type ON messages(type_code);
CREATE INDEX idx_messages_expire ON messages(expire_at, is_expired);
CREATE INDEX idx_messages_unread ON messages(agent_id, is_read) WHERE is_read = FALSE;
```

### 14.5 æ¶ˆæ¯ç”Ÿæˆè§¦å‘ç‚¹

```go
// åˆ†æ¶¦åˆ°è´¦æ¶ˆæ¯
func (s *ProfitService) CreateProfitMessage(profit *ProfitRecord) {
    msg := &Message{
        AgentID:   profit.AgentID,
        TypeCode:  "profit",
        Title:     "åˆ†æ¶¦åˆ°è´¦",
        Content:   fmt.Sprintf("æ‚¨æœ‰ä¸€ç¬”Â¥%.2fçš„%så·²å…¥è´¦", profit.Amount, profit.TypeName),
        ExtraData: map[string]interface{}{
            "profit_id": profit.ID,
            "amount":    profit.Amount,
        },
        ExpireAt:  time.Now().Add(72 * time.Hour), // 3å¤©
    }
    s.msgRepo.Create(msg)
    s.pushService.Push(msg)
}

// æ–°ä»£ç†æ³¨å†Œæ¶ˆæ¯
func (s *AgentService) CreateRegisterMessage(newAgent *Agent) {
    // é€šçŸ¥ä¸Šçº§ä»£ç†å•†
    msg := &Message{
        AgentID:  newAgent.ParentID,
        TypeCode: "register",
        Title:    "æ–°ä»£ç†å•†æ³¨å†Œ",
        Content:  fmt.Sprintf("%s(%s)å·²æ³¨å†Œæˆä¸ºæ‚¨çš„ä¸‹çº§ä»£ç†", newAgent.Name, maskPhone(newAgent.Phone)),
    }
    // ...
}
```

### 14.6 APPç«¯é¡µé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â†  æ¶ˆæ¯é€šçŸ¥                     â—3  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  [ å…¨éƒ¨ | åˆ†æ¶¦ | æ³¨å†Œ | äº¤æ˜“ | ç³»ç»Ÿ ] â”‚
â”‚                                     â”‚
â”‚  ä»Šå¤©                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ’° åˆ†æ¶¦åˆ°è´¦              â— æœªè¯»â”‚   â”‚
â”‚ â”‚ æ‚¨æœ‰ä¸€ç¬”Â¥8.00çš„äº¤æ˜“åˆ†æ¶¦å·²å…¥è´¦   â”‚   â”‚
â”‚ â”‚ ä»Šå¤© 10:30                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ‘¤ æ–°ä»£ç†å•†æ³¨å†Œ           â— æœªè¯»â”‚   â”‚
â”‚ â”‚ æå››(139****9999)å·²æ³¨å†Œæˆä¸º... â”‚   â”‚
â”‚ â”‚ ä»Šå¤© 09:15                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  æ˜¨å¤©                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ’³ äº¤æ˜“é€šçŸ¥                    â”‚   â”‚
â”‚ â”‚ å•†æˆ·"å¼ ä¸‰å•†åº—"å®Œæˆä¸€ç¬”Â¥1,500...â”‚   â”‚
â”‚ â”‚ æ˜¨å¤© 18:20                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  æ›´æ—©                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ“¢ ç³»ç»Ÿå…¬å‘Š                    â”‚   â”‚
â”‚ â”‚ ç³»ç»Ÿå°†äº1æœˆ25æ—¥è¿›è¡Œå‡çº§ç»´æŠ¤...  â”‚   â”‚
â”‚ â”‚ 3å¤©å‰                         â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  âš ï¸ æ¶ˆæ¯3å¤©åè‡ªåŠ¨è¿‡æœŸ               â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.7 PCç«¯ç™»å½•å¼¹çª—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿå…¬å‘Š                                                            [Ã—]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ğŸ“¢ é‡è¦é€šçŸ¥                                                   2024-01-20  â”‚
â”‚                                                                             â”‚
â”‚  å°Šæ•¬çš„ä»£ç†å•†ï¼š                                                             â”‚
â”‚                                                                             â”‚
â”‚  ä¸ºæå‡ç”¨æˆ·ä½“éªŒï¼Œç³»ç»Ÿå°†äº2024å¹´1æœˆ25æ—¥è¿›è¡Œå‡çº§ç»´æŠ¤ï¼Œå±Šæ—¶ä»¥ä¸‹åŠŸèƒ½å°†æœ‰æ‰€è°ƒæ•´ï¼š  â”‚
â”‚                                                                             â”‚
â”‚  1. æ–°å¢T+0ç§’åˆ°è´¹ç‡è®¾ç½®åŠŸèƒ½                                                 â”‚
â”‚  2. ä¼˜åŒ–åˆ†æ¶¦è®¡ç®—é€»è¾‘                                                        â”‚
â”‚  3. ä¿®å¤å·²çŸ¥é—®é¢˜                                                            â”‚
â”‚                                                                             â”‚
â”‚  å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å®¢æœã€‚                                                      â”‚
â”‚                                                                             â”‚
â”‚  â˜ ä¸å†æç¤ºæ­¤å…¬å‘Š                                                          â”‚
â”‚                                                                             â”‚
â”‚                                              [æˆ‘çŸ¥é“äº†]                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.8 APIè®¾è®¡

```typescript
// APPç«¯æ¶ˆæ¯åˆ—è¡¨
GET /api/v1/messages
Query: { typeCode?, isRead?, page, pageSize }
Response: { total, unreadCount, list: Message[] }

// æ ‡è®°å·²è¯»
PUT /api/v1/messages/:id/read

// æ‰¹é‡æ ‡è®°å·²è¯»
PUT /api/v1/messages/batch-read
Body: { ids: number[] }

// å…¨éƒ¨æ ‡è®°å·²è¯»
PUT /api/v1/messages/read-all

// è·å–æœªè¯»æ•°é‡
GET /api/v1/messages/unread-count
Response: { count: number, byType: { profit: 3, register: 1, ... } }

// PCç«¯å…¬å‘Šåˆ—è¡¨ï¼ˆå¾…å¼¹çª—ï¼‰
GET /api/v1/announcements/pending
Response: { list: Announcement[] }

// æ ‡è®°å…¬å‘Šå·²è¯»
PUT /api/v1/announcements/:id/read
```

### 14.9 æ¨é€æœåŠ¡é€‚é…

```go
// æ¨é€æœåŠ¡æ¥å£
type PushService interface {
    Push(msg *Message) error
}

// iOS APNsæ¨é€
type IOSPushService struct {}

// Android FCM/æå…‰æ¨é€
type AndroidPushService struct {}

// é¸¿è’™åä¸ºPush
type HarmonyPushService struct {}

// æ¨é€å·¥å‚
func NewPushService(platform string) PushService {
    switch platform {
    case "ios":
        return &IOSPushService{}
    case "harmony":
        return &HarmonyPushService{}
    default:
        return &AndroidPushService{}
    }
}
```

---

## åäº”ã€æ•°æ®åˆ†ææ¨¡å—è¯¦ç»†è®¾è®¡ â­ (æ–°å¢)

### 15.1 åŠŸèƒ½æ¦‚è¿°

æ ¹æ®ä¸šåŠ¡é€»è¾‘æ¢³ç†æ–‡æ¡£ç¬¬201-214è¡Œï¼š

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **äº¤æ˜“æŸ¥è¯¢** | å…¨éƒ¨/ç›´è¥/å›¢é˜Ÿä¸‰éƒ¨åˆ†ï¼Œæœ€è¿‘6ä¸ªæœˆæ•°æ® |
| **å•†æˆ·åˆ†ç±»åˆ†æ** | 6ç§å•†æˆ·ç±»å‹ç»Ÿè®¡ |
| **ä»£ç†æ’å** | äº¤æ˜“é‡/ç¬”æ•°/ç»ˆç«¯æ•°æ’å |
| **å®¢æˆ·åˆ†æ** | åˆ·å¡/æ”¯ä»˜å®/å¾®ä¿¡å æ¯” |
| **APPæ•°æ®èŒƒå›´** | ä»…æ˜¾ç¤ºè‡ªå·±å’Œå­ä»£ç†æ±‡æ€»ï¼Œæ·±å±‚æ•°æ®PCåå°æŸ¥çœ‹ |

### 15.2 æ•°æ®èŒƒå›´è¯´æ˜

```
APPç«¯æ•°æ®å¯è§èŒƒå›´ï¼š
â”œâ”€â”€ ä»£ç†å•†Aï¼ˆå½“å‰ç”¨æˆ·ï¼‰
â”‚   â”œâ”€â”€ ç›´è¥å•†æˆ·æ•°æ® âœ“ å¯è§
â”‚   â”œâ”€â”€ ç›´å±ä¸‹çº§Bçš„æ±‡æ€»æ•°æ® âœ“ å¯è§
â”‚   â”‚   â””â”€â”€ Bçš„ä¸‹çº§Cçš„æ•°æ® âœ— APPä¸å¯è§ï¼ˆPCåå°å¯çœ‹ï¼‰
â”‚   â””â”€â”€ ç›´å±ä¸‹çº§Dçš„æ±‡æ€»æ•°æ® âœ“ å¯è§
â”‚       â””â”€â”€ Dçš„ä¸‹çº§Eçš„æ•°æ® âœ— APPä¸å¯è§ï¼ˆPCåå°å¯çœ‹ï¼‰
```

### 15.3 äº¤æ˜“æŸ¥è¯¢

#### æ•°æ®ç»´åº¦

| ç»´åº¦ | è¯´æ˜ |
|------|------|
| **å…¨éƒ¨** | è‡ªå·±+å›¢é˜Ÿæ‰€æœ‰äº¤æ˜“ |
| **ç›´è¥** | è‡ªå·±ç›´æ¥æ‹“å±•çš„å•†æˆ·äº¤æ˜“ |
| **å›¢é˜Ÿ** | ä¸‹çº§ä»£ç†å•†çš„å•†æˆ·äº¤æ˜“ |

#### æ—¶é—´èŒƒå›´

- æœ€è¿‘6ä¸ªæœˆæ•°æ®
- æ”¯æŒæŒ‰æœˆ/æŒ‰æ—¥æŸ¥çœ‹

#### é¡µé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â†  äº¤æ˜“æŸ¥è¯¢                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  [ å…¨éƒ¨ | ç›´è¥ | å›¢é˜Ÿ ]              â”‚
â”‚                                     â”‚
â”‚  æ—¶é—´: [2024å¹´1æœˆâ–¼]                  â”‚
â”‚                                     â”‚
â”‚  äº¤æ˜“æ±‡æ€»                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚    æ€»äº¤æ˜“é¢         äº¤æ˜“ç¬”æ•°    â”‚   â”‚
â”‚ â”‚  Â¥1,234,567         5,678    â”‚   â”‚
â”‚ â”‚                               â”‚   â”‚
â”‚ â”‚  è´·è®°å¡    å€Ÿè®°å¡    æ‰«ç       â”‚   â”‚
â”‚ â”‚  Â¥800,000  Â¥300,000  Â¥134,567â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  æœˆåº¦è¶‹åŠ¿                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚        [æŸ±çŠ¶å›¾]                â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  äº¤æ˜“æ˜ç»†                    æŸ¥çœ‹æ›´å¤š>â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ å¼ ä¸‰å•†åº—  åˆ·å¡   Â¥1,500  10:30 â”‚   â”‚
â”‚ â”‚ æå››è¶…å¸‚  å¾®ä¿¡   Â¥320    10:25 â”‚   â”‚
â”‚ â”‚ ç‹äº”ä¾¿åˆ©åº— æ”¯ä»˜å® Â¥180   10:20 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 15.4 å•†æˆ·åˆ†ç±»åˆ†æ

å·²åœ¨**å•†æˆ·åˆ†ç±»ä½“ç³»è®¾è®¡**ä¸­è¯¦ç»†è¯´æ˜ï¼Œè¿™é‡Œä»…åˆ—å‡ºå±•ç¤ºè¦æ±‚ï¼š

- æ˜¾ç¤º6ç§åˆ†ç±»çš„å•†æˆ·æ•°é‡
- æ”¯æŒç‚¹å‡»åˆ†ç±»æŸ¥çœ‹å•†æˆ·åˆ—è¡¨
- æ˜¾ç¤ºåˆ†ç±»è¶‹åŠ¿å˜åŒ–

### 15.5 ä»£ç†æ’å

#### æ’åç»´åº¦

| æ’å | è¯´æ˜ |
|------|------|
| **äº¤æ˜“é‡æ’å** | æŒ‰æœˆåº¦äº¤æ˜“é¢æ’åº |
| **äº¤æ˜“ç¬”æ•°æ’å** | æŒ‰æœˆåº¦äº¤æ˜“ç¬”æ•°æ’åº |
| **ç»ˆç«¯æ€»æ•°æ’å** | æŒ‰æŒæœ‰ç»ˆç«¯æ•°é‡æ’åº |
| **å·²æ¿€æ´»ç»ˆç«¯æ’å** | æŒ‰å·²æ¿€æ´»ç»ˆç«¯æ•°æ’åº |

#### é¡µé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â†  ä»£ç†æ’å                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  [äº¤æ˜“é‡ | äº¤æ˜“ç¬”æ•° | ç»ˆç«¯æ•° | æ¿€æ´»æ•°] â”‚
â”‚                                     â”‚
â”‚  æ—¶é—´: [2024å¹´1æœˆâ–¼]                  â”‚
â”‚                                     â”‚
â”‚  ğŸ¥‡ 1. å¼ ä¸‰ (A001)                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æœ¬æœˆäº¤æ˜“: Â¥1,250,000           â”‚   â”‚
â”‚ â”‚ è¾ƒä¸Šæœˆ: â†‘ 15.2%                â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  ğŸ¥ˆ 2. æå›› (A002)                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æœ¬æœˆäº¤æ˜“: Â¥980,000             â”‚   â”‚
â”‚ â”‚ è¾ƒä¸Šæœˆ: â†‘ 8.5%                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  ğŸ¥‰ 3. ç‹äº” (A003)                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æœ¬æœˆäº¤æ˜“: Â¥756,000             â”‚   â”‚
â”‚ â”‚ è¾ƒä¸Šæœˆ: â†“ 3.2%                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  (æ›´å¤šæ’å...)                       â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 15.6 å®¢æˆ·åˆ†æ

#### åˆ†æç»´åº¦

| ç»´åº¦ | è¯´æ˜ |
|------|------|
| **æ”¯ä»˜æ–¹å¼å æ¯”** | åˆ·å¡/æ”¯ä»˜å®/å¾®ä¿¡å æ¯” |
| **ç›´è¥vsä¸‹çº§** | ç›´è¥å•†æˆ·å’Œä¸‹çº§å•†æˆ·å¯¹æ¯” |

#### é¡µé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â†  å®¢æˆ·åˆ†æ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  [ ç›´è¥ | ä¸‹çº§ ]                     â”‚
â”‚                                     â”‚
â”‚  æ”¯ä»˜æ–¹å¼å æ¯”                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚                               â”‚   â”‚
â”‚ â”‚        [é¥¼å›¾]                  â”‚   â”‚
â”‚ â”‚   åˆ·å¡ 65%                    â”‚   â”‚
â”‚ â”‚   å¾®ä¿¡ 20%                    â”‚   â”‚
â”‚ â”‚   æ”¯ä»˜å® 15%                  â”‚   â”‚
â”‚ â”‚                               â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  æ€»äº¤æ˜“é‡: Â¥1,234,567               â”‚
â”‚                                     â”‚
â”‚  ç›´è¥å•†æˆ·æ’å (æœ¬æœˆ)          æŸ¥çœ‹æ›´å¤š>â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 1. å¼ ä¸‰å•†åº—  139****8888       â”‚   â”‚
â”‚ â”‚    ç´¯è®¡: Â¥125ä¸‡   æœ¬æœˆ: Â¥12ä¸‡  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 2. æå››è¶…å¸‚  137****6666       â”‚   â”‚
â”‚ â”‚    ç´¯è®¡: Â¥98ä¸‡    æœ¬æœˆ: Â¥9.5ä¸‡ â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 15.7 ç›´è¥å•†æˆ·è¯¦æƒ…

ç‚¹å‡»ç›´è¥å•†æˆ·è¿›å…¥è¯¦æƒ…é¡µï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â†  å•†æˆ·äº¤æ˜“è¯¦æƒ…                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  å¼ ä¸‰å•†åº—                            â”‚
â”‚  æœºå…·å·: SN12345678                  â”‚
â”‚                                     â”‚
â”‚  äº¤æ˜“ç»Ÿè®¡                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ åˆ·å¡äº¤æ˜“      Â¥800,000         â”‚   â”‚
â”‚ â”‚ æ‰«ç äº¤æ˜“      Â¥250,000         â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  è¿‘7å¤©äº¤æ˜“                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚        [æŠ˜çº¿å›¾]                â”‚   â”‚
â”‚ â”‚                               â”‚   â”‚
â”‚ â”‚  æ€»è®¡: Â¥35,600                â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  è¿‘åŠå¹´äº¤æ˜“                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚        [æŸ±çŠ¶å›¾]                â”‚   â”‚
â”‚ â”‚                               â”‚   â”‚
â”‚ â”‚  æœˆå‡: Â¥125,000               â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 15.8 æ•°æ®åº“è®¾è®¡

```sql
-- ä»£ç†å•†ç»Ÿè®¡æ±‡æ€»è¡¨ï¼ˆæ—¥ç»´åº¦ï¼‰
CREATE TABLE agent_daily_stats (
    id              BIGSERIAL PRIMARY KEY,
    agent_id        BIGINT NOT NULL,
    stat_date       DATE NOT NULL,

    -- äº¤æ˜“ç»Ÿè®¡
    trade_amount    DECIMAL(20,2) DEFAULT 0,      -- äº¤æ˜“é¢
    trade_count     INT DEFAULT 0,                 -- äº¤æ˜“ç¬”æ•°
    credit_amount   DECIMAL(20,2) DEFAULT 0,       -- è´·è®°å¡äº¤æ˜“é¢
    debit_amount    DECIMAL(20,2) DEFAULT 0,       -- å€Ÿè®°å¡äº¤æ˜“é¢
    wechat_amount   DECIMAL(20,2) DEFAULT 0,       -- å¾®ä¿¡äº¤æ˜“é¢
    alipay_amount   DECIMAL(20,2) DEFAULT 0,       -- æ”¯ä»˜å®äº¤æ˜“é¢

    -- åˆ†æ¶¦ç»Ÿè®¡
    profit_amount   DECIMAL(15,2) DEFAULT 0,       -- åˆ†æ¶¦é‡‘é¢

    -- ç»ˆç«¯ç»Ÿè®¡
    terminal_total  INT DEFAULT 0,                 -- ç»ˆç«¯æ€»æ•°
    terminal_active INT DEFAULT 0,                 -- å·²æ¿€æ´»æ•°

    -- å•†æˆ·ç»Ÿè®¡
    merchant_total  INT DEFAULT 0,                 -- å•†æˆ·æ€»æ•°
    merchant_active INT DEFAULT 0,                 -- æ´»è·ƒå•†æˆ·æ•°

    created_at      TIMESTAMP DEFAULT NOW(),

    UNIQUE(agent_id, stat_date)
);

-- ä»£ç†å•†æ’åè¡¨ï¼ˆæœˆç»´åº¦ï¼‰
CREATE TABLE agent_monthly_rankings (
    id              BIGSERIAL PRIMARY KEY,
    agent_id        BIGINT NOT NULL,
    stat_month      VARCHAR(7) NOT NULL,           -- 2024-01

    -- æ’åæ•°æ®
    trade_amount    DECIMAL(20,2) DEFAULT 0,
    trade_count     INT DEFAULT 0,
    terminal_total  INT DEFAULT 0,
    terminal_active INT DEFAULT 0,

    -- æ’åç»“æœ
    rank_by_amount  INT,                           -- äº¤æ˜“é¢æ’å
    rank_by_count   INT,                           -- äº¤æ˜“ç¬”æ•°æ’å
    rank_by_terminal INT,                          -- ç»ˆç«¯æ•°æ’å
    rank_by_active  INT,                           -- æ¿€æ´»æ•°æ’å

    -- ç¯æ¯”æ•°æ®
    amount_change_rate DECIMAL(10,4),              -- äº¤æ˜“é¢ç¯æ¯”

    created_at      TIMESTAMP DEFAULT NOW(),

    UNIQUE(agent_id, stat_month)
);

-- ç´¢å¼•
CREATE INDEX idx_agent_daily_agent ON agent_daily_stats(agent_id, stat_date);
CREATE INDEX idx_agent_ranking_month ON agent_monthly_rankings(stat_month, rank_by_amount);
```

### 15.9 APIè®¾è®¡

```typescript
// äº¤æ˜“æŸ¥è¯¢
GET /api/v1/analytics/transactions
Query: { scope: 'all'|'direct'|'team', month, page, pageSize }
Response: {
    summary: { totalAmount, totalCount, credit, debit, wechat, alipay },
    trend: [{ date, amount }],
    list: Transaction[]
}

// å•†æˆ·åˆ†ç±»ç»Ÿè®¡
GET /api/v1/analytics/merchant-categories
Response: { loyal, premium, potential, regular, lowActive, inactive, total }

// ä»£ç†æ’å
GET /api/v1/analytics/agent-rankings
Query: { rankType: 'amount'|'count'|'terminal'|'active', month, page, pageSize }
Response: { list: AgentRanking[] }

// å®¢æˆ·åˆ†æ
GET /api/v1/analytics/customer-analysis
Query: { scope: 'direct'|'sub' }
Response: {
    paymentRatio: { card: 65, wechat: 20, alipay: 15 },
    totalAmount: 1234567,
    topMerchants: Merchant[]
}

// ç›´è¥å•†æˆ·è¯¦æƒ…
GET /api/v1/analytics/merchants/:id
Response: {
    basic: { name, terminalNo, ... },
    stats: { cardAmount, scanAmount },
    last7Days: [{ date, amount }],
    last6Months: [{ month, amount }]
}
```

### 15.10 å®šæ—¶ä»»åŠ¡

```yaml
cron:
  # æ¯æ—¥ç»Ÿè®¡æ±‡æ€»
  daily_stats_aggregation:
    schedule: "0 1 * * *"  # æ¯å¤©å‡Œæ™¨1ç‚¹
    description: "æ±‡æ€»ä»£ç†å•†æ—¥ç»Ÿè®¡æ•°æ®"

  # æ¯æœˆæ’åè®¡ç®—
  monthly_ranking_calculation:
    schedule: "0 2 1 * *"  # æ¯æœˆ1æ—¥å‡Œæ™¨2ç‚¹
    description: "è®¡ç®—ä»£ç†å•†æœˆåº¦æ’å"

  # å•†æˆ·åˆ†ç±»æ›´æ–°
  merchant_category_update:
    schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
    description: "æ›´æ–°å•†æˆ·åˆ†ç±»"
```

---

| é—®é¢˜ | çŠ¶æ€ | ç¡®è®¤ç»“æœ |
|------|------|----------|
| T+0ç§’åˆ°è´¹ç‡åŠ 1/åŠ 2/åŠ 3 | âœ… å·²ç¡®è®¤ | ç¬”æ•°è´¹ï¼Œæ¯ç¬”1-3å…ƒï¼Œå¯è®¾ä¸º0 |
| æœåŠ¡å•†å·æ•°æ®æƒé™ | âœ… å·²ç¡®è®¤ | æš‚ä¸å¼€å‘ï¼Œåç»­ç‰ˆæœ¬è€ƒè™‘ |
| é€€è´¹åˆ†æ¶¦å¤„ç† | âœ… å·²ç¡®è®¤ | åˆ†æ¶¦å›æ‰£ï¼Œæ ‡æ³¨é€€è´§ |

**T+0å·²æ·»åŠ åˆ°æ”¿ç­–æ¨¡æ¿**ï¼š
- `policy_templates.t0_fee_type` - ç§’åˆ°è´¹ç‡æ¡£ä½ (0:ä¸å¼€é€š 1:åŠ 1 2:åŠ 2 3:åŠ 3)
- `policy_templates.t0_fee_amount` - ç§’åˆ°è´¹ç”¨ï¼ˆå…ƒ/ç¬”ï¼‰
- `terminals.t0_enabled` - æ˜¯å¦å¼€é€šT+0
- `transactions.is_t0` / `t0_fee` - äº¤æ˜“T+0æ ‡è¯†å’Œè´¹ç”¨

---

## äºŒã€4ç§åˆ†æ¶¦ç±»å‹ï¼ˆå·²ç¡®è®¤ï¼‰

### 2.1 åˆ†æ¶¦ç±»å‹æ€»è§ˆ

| ç±»å‹ | è§¦å‘æ¡ä»¶ | è®¡ç®—æ–¹å¼ | å…¥è´¦é’±åŒ… |
|------|----------|----------|----------|
| **äº¤æ˜“åˆ†æ¶¦** | æ™®é€šäº¤æ˜“ | è´¹ç‡çº§å·® Ã— äº¤æ˜“é¢ | åˆ†æ¶¦é’±åŒ… |
| **æ¿€æ´»å¥–åŠ±** | è¾¾æ ‡äº¤æ˜“é¢ | å›ºå®šé‡‘é¢(åˆ†é˜¶æ®µ) | å¥–åŠ±é’±åŒ… |
| **æŠ¼é‡‘è¿”ç°** | æŠ¼é‡‘æ‰£å–æˆåŠŸ | **è¿”ç°çº§å·®** â­ | æœåŠ¡è´¹é’±åŒ… |
| **æµé‡è¿”ç°** | æµé‡è´¹æ‰£å–æˆåŠŸ | **è¿”ç°çº§å·®** â­ | æœåŠ¡è´¹é’±åŒ… |

### 2.2 äº¤æ˜“åˆ†æ¶¦è®¡ç®—ï¼ˆå·²ç¡®è®¤ï¼‰

**å…¬å¼**: `åˆ†æ¶¦ = (ä¸‹çº§è´¹ç‡ - æœ¬çº§è´¹ç‡) Ã— äº¤æ˜“é‡‘é¢`

**ç¤ºä¾‹**ï¼ˆ10,000å…ƒäº¤æ˜“ï¼‰:
```
å•†æˆ·è´¹ç‡: 60 (ä¸‡åˆ†ä¹‹60)
â”œâ”€â”€ å››çº§ä»£ç†(è´¹ç‡55): (60-55)Ã—10000Ã·10000 = 5å…ƒ
â”œâ”€â”€ ä¸‰çº§ä»£ç†(è´¹ç‡50): (55-50)Ã—10000Ã·10000 = 5å…ƒ
â”œâ”€â”€ äºŒçº§ä»£ç†(è´¹ç‡50): (50-50)Ã—10000Ã·10000 = 0å…ƒ (æ— çº§å·®)
â””â”€â”€ ä¸€çº§ä»£ç†(è´¹ç‡49): (50-49)Ã—10000Ã·10000 = 1å…ƒ
```

### 2.3 æŠ¼é‡‘è¿”ç°/æµé‡è¿”ç°çº§å·®é€»è¾‘ â­ (æœ¬æ¬¡æ›´æ–°)

**é‡è¦æ›´æ­£**: æŠ¼é‡‘è¿”ç°å’Œæµé‡è¿”ç°ä¹Ÿéµå¾ªçº§å·®é€»è¾‘ï¼Œä¸äº¤æ˜“åˆ†æ¶¦è®¡ç®—æ–¹å¼ä¸€è‡´

**å…¬å¼**: `è¿”ç° = æœ¬çº§è®¾ç½®è¿”ç°é‡‘é¢ - ä¸‹çº§è®¾ç½®è¿”ç°é‡‘é¢`

**æµé‡è¿”ç°çº§å·®ç¤ºä¾‹**ï¼ˆ79å…ƒæµé‡è´¹ï¼‰:
```
é€šé“æ”¶å–: 79å…ƒ
â”œâ”€â”€ å››çº§ä»£ç†(ç›´è¥): è®¾ç½®30å…ƒ â†’ æ‹¿30å…ƒ
â”œâ”€â”€ ä¸‰çº§ä»£ç†: è®¾ç½®50å…ƒ â†’ æ‹¿50-30 = 20å…ƒ
â”œâ”€â”€ äºŒçº§ä»£ç†: è®¾ç½®60å…ƒ â†’ æ‹¿60-50 = 10å…ƒ
â”œâ”€â”€ ä¸€çº§ä»£ç†: è®¾ç½®60å…ƒ â†’ æ‹¿60-60 = 0å…ƒ (æ— çº§å·®)
â””â”€â”€ å¹³å°ä¿ç•™: 79-60 = 19å…ƒ
```

**æŠ¼é‡‘è¿”ç°çº§å·®ç¤ºä¾‹**ï¼ˆ299å…ƒæŠ¼é‡‘ï¼‰:
```
å•†æˆ·æŠ¼é‡‘: 299å…ƒ
â”œâ”€â”€ å››çº§ä»£ç†(ç›´è¥): è®¾ç½®150å…ƒ â†’ æ‹¿150å…ƒ
â”œâ”€â”€ ä¸‰çº§ä»£ç†: è®¾ç½®200å…ƒ â†’ æ‹¿200-150 = 50å…ƒ
â”œâ”€â”€ äºŒçº§ä»£ç†: è®¾ç½®250å…ƒ â†’ æ‹¿250-200 = 50å…ƒ
â”œâ”€â”€ ä¸€çº§ä»£ç†: è®¾ç½®250å…ƒ â†’ æ‹¿250-250 = 0å…ƒ (æ— çº§å·®)
â””â”€â”€ å¹³å°ä¿ç•™: 299-250 = 49å…ƒ
```

---

## ä¸‰ã€æ”¿ç­–æ¨¡æ¿æ–°è§„åˆ™ â­ (æœ¬æ¬¡æ›´æ–°)

### 3.1 æ¨¡æ¿åˆå§‹åŒ–è§„åˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| **é»˜è®¤æ¨¡æ¿** | ä»£ç†å•†æ³¨å†Œæ—¶ç»§æ‰¿ä¸Šçº§çš„æ”¿ç­–æ¨¡æ¿ï¼Œæˆ–æ¨¡æ¿ä¸ºç©º |
| **åˆ’æ‹¨çº¦æŸ** | âš ï¸ **æœªè®¾ç½®æ”¿ç­–æ¨¡æ¿å‰ï¼Œæ— æ³•åˆ’æ‹¨æœºå…·** |

### 3.2 ä¸šåŠ¡æµç¨‹çº¦æŸ

```
ä»£ç†å•†æ³¨å†Œ
    â”‚
    â–¼
ç»§æ‰¿ä¸Šçº§æ¨¡æ¿ / æ¨¡æ¿ä¸ºç©º
    â”‚
    â–¼
å¿…é¡»è®¾ç½®æ”¿ç­–æ¨¡æ¿ â†â”€â”€ æ ¡éªŒç‚¹
    â”‚
    â–¼
æ‰èƒ½åˆ’æ‹¨æœºå…·
    â”‚
    â–¼
æœºå…·ç»‘å®šå•†æˆ·
```

### 3.3 ä»£ç å®ç°è¦ç‚¹

```go
// æœºå…·åˆ’æ‹¨å‰æ ¡éªŒ
func (s *TerminalService) Dispatch(terminalID, toAgentID int64) error {
    // 1. æ£€æŸ¥ç›®æ ‡ä»£ç†å•†æ˜¯å¦è®¾ç½®äº†æ”¿ç­–æ¨¡æ¿
    policies, _ := s.policyRepo.GetByAgentID(toAgentID)
    if len(policies) == 0 {
        return errors.New("ä»£ç†å•†æœªè®¾ç½®æ”¿ç­–æ¨¡æ¿ï¼Œæ— æ³•åˆ’æ‹¨æœºå…·")
    }

    // 2. ç»§ç»­åˆ’æ‹¨æµç¨‹...
}
```

### 3.4 æ•°æ®åº“è®¾è®¡è°ƒæ•´

```sql
-- ä»£ç†å•†-æ”¿ç­–å…³è”è¡¨å¢åŠ å¿…å¡«æ ¡éªŒ
-- åˆ’æ‹¨æœºå…·æ—¶éœ€è¦æ£€æŸ¥æ­¤è¡¨æ˜¯å¦æœ‰è®°å½•

-- ä»£ç†å•†æ”¿ç­–çŠ¶æ€å­—æ®µï¼ˆå¯é€‰ï¼‰
ALTER TABLE agents ADD COLUMN policy_configured BOOLEAN DEFAULT FALSE;

-- åˆ’æ‹¨æ—¶æ ¡éªŒ
-- IF NOT EXISTS (SELECT 1 FROM agent_policies WHERE agent_id = ?) THEN
--     RAISE EXCEPTION 'ä»£ç†å•†æœªè®¾ç½®æ”¿ç­–æ¨¡æ¿';
-- END IF;
```

---

## å››ã€éœ€è¦æ›´æ–°çš„è®¾è®¡å†…å®¹

### 4.1 æŠ¼é‡‘è¿”ç°è®¡ç®—å™¨æ›´æ–°

åŸè®¾è®¡ï¼ˆå›ºå®šé‡‘é¢ï¼‰â†’ æ›´æ–°ä¸ºçº§å·®è®¡ç®—ï¼š

```go
// internal/app/profit/deposit_cashback.go

func (c *DepositCashbackCalculator) Calculate(tx *Transaction) ([]*ProfitResult, error) {
    results := make([]*ProfitResult, 0)

    // 1. è·å–ä»£ç†å•†é“¾
    agentChain, _ := c.agentRepo.GetAgentChain(tx.AgentID)

    // 2. è·å–æ¯çº§ä»£ç†å•†çš„æŠ¼é‡‘è¿”ç°è®¾ç½®
    prevCashback := decimal.Zero // ä¸‹çº§çš„è¿”ç°è®¾ç½®

    for i, agent := range agentChain {
        // è·å–å½“å‰ä»£ç†å•†çš„æŠ¼é‡‘è¿”ç°è§„åˆ™
        rule, _ := c.policyRepo.GetDepositCashbackRule(agent.ID, tx.ChannelID, tx.Amount)
        if rule == nil {
            continue
        }

        currentCashback := rule.CashbackAmount

        // 3. è®¡ç®—çº§å·®
        var cashbackAmount decimal.Decimal
        if i == 0 {
            // ç›´å±ä»£ç†å•†æ‹¿å…¨éƒ¨è®¾ç½®çš„è¿”ç°
            cashbackAmount = currentCashback
        } else {
            // ä¸Šçº§ä»£ç†å•†æ‹¿çº§å·®
            cashbackAmount = currentCashback.Sub(prevCashback)
        }

        if cashbackAmount.GreaterThan(decimal.Zero) {
            results = append(results, &ProfitResult{
                AgentID:      agent.ID,
                Layer:        i + 1,
                ProfitAmount: cashbackAmount,
                WalletType:   WalletTypeService,
            })
        }

        prevCashback = currentCashback
    }

    return results, nil
}
```

### 4.2 æµé‡è´¹è¿”ç°è®¡ç®—å™¨æ›´æ–°

åŒæ ·æ›´æ–°ä¸ºçº§å·®è®¡ç®—é€»è¾‘ã€‚

### 4.3 æ”¿ç­–æ¨¡æ¿è¡¨ç»“æ„è°ƒæ•´

```sql
-- ä»£ç†å•†-æ”¿ç­–å…³è”è¡¨éœ€è¦è®°å½•è¿”ç°è®¾ç½®
CREATE TABLE agent_policy_cashbacks (
    id              BIGSERIAL PRIMARY KEY,
    agent_id        BIGINT NOT NULL,
    channel_id      BIGINT NOT NULL,

    -- æŠ¼é‡‘è¿”ç°è®¾ç½®ï¼ˆç»™ä¸‹çº§çš„ï¼‰
    deposit_99_cashback   DECIMAL(10,2),  -- 99å…ƒæŠ¼é‡‘è¿”ç°
    deposit_199_cashback  DECIMAL(10,2),  -- 199å…ƒæŠ¼é‡‘è¿”ç°
    deposit_299_cashback  DECIMAL(10,2),  -- 299å…ƒæŠ¼é‡‘è¿”ç°

    -- æµé‡è´¹è¿”ç°è®¾ç½®ï¼ˆç»™ä¸‹çº§çš„ï¼‰
    sim_first_cashback    DECIMAL(10,2),  -- é¦–æ¬¡æµé‡è´¹è¿”ç°
    sim_renewal_cashback  DECIMAL(10,2),  -- ç»­è´¹æµé‡è´¹è¿”ç°

    created_at      TIMESTAMP DEFAULT NOW(),
    UNIQUE(agent_id, channel_id)
);
```

---

## äº”ã€å…³é”®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¯´æ˜ | æ›´æ–°çŠ¶æ€ |
|------|------|----------|
| `internal/app/profit/calculator.go` | äº¤æ˜“åˆ†æ¶¦è®¡ç®— | âœ… å·²è®¾è®¡ |
| `internal/app/profit/deposit_cashback.go` | æŠ¼é‡‘è¿”ç°è®¡ç®— | â­ éœ€æ›´æ–°ä¸ºçº§å·® |
| `internal/app/profit/sim_cashback.go` | æµé‡è´¹è¿”ç°è®¡ç®— | â­ éœ€æ›´æ–°ä¸ºçº§å·® |
| `internal/app/terminal/dispatch.go` | æœºå…·åˆ’æ‹¨ | â­ éœ€å¢åŠ æ¨¡æ¿æ ¡éªŒ |
| `internal/app/policy/engine.go` | æ”¿ç­–æ¨¡æ¿å¼•æ“ | âœ… å·²è®¾è®¡ |

---

## å…­ã€éªŒè¯æ–¹æ¡ˆ

### 6.1 æŠ¼é‡‘è¿”ç°çº§å·®æµ‹è¯•

```go
func TestDepositCashbackWithDiff(t *testing.T) {
    // åœºæ™¯: 299å…ƒæŠ¼é‡‘ï¼Œå››çº§ä»£ç†é“¾
    // ä¸€çº§è®¾ç½®250ï¼ŒäºŒçº§è®¾ç½®200ï¼Œä¸‰çº§è®¾ç½®150ï¼Œå››çº§ç›´è¥

    tx := &Transaction{Amount: 299, TradeType: 5} // æŠ¼é‡‘äº¤æ˜“

    results, _ := calculator.Calculate(tx)

    assert.Equal(t, 150, results[0].ProfitAmount) // å››çº§: 150
    assert.Equal(t, 50, results[1].ProfitAmount)  // ä¸‰çº§: 200-150=50
    assert.Equal(t, 50, results[2].ProfitAmount)  // äºŒçº§: 250-200=50
    assert.Equal(t, 0, results[3].ProfitAmount)   // ä¸€çº§: 250-250=0
}
```

### 6.2 æœºå…·åˆ’æ‹¨æ¨¡æ¿æ ¡éªŒæµ‹è¯•

```go
func TestDispatchWithoutPolicy(t *testing.T) {
    // ä»£ç†å•†æœªè®¾ç½®æ”¿ç­–æ¨¡æ¿æ—¶ï¼Œåˆ’æ‹¨åº”è¯¥å¤±è´¥
    err := terminalSvc.Dispatch(terminalID, agentWithoutPolicy)
    assert.Error(t, err)
    assert.Contains(t, err.Error(), "æœªè®¾ç½®æ”¿ç­–æ¨¡æ¿")
}
```

---

## ä¸ƒã€è®¾è®¡å®Œæ•´æ€§æ£€æŸ¥ âœ…

### 7.1 æ ¸å¿ƒä¸šåŠ¡æ¨¡å—è¦†ç›–åº¦

| ä¸šåŠ¡éœ€æ±‚ | è®¾è®¡çŠ¶æ€ | è¯´æ˜ |
|----------|----------|------|
| åˆ†æ¶¦é€»è¾‘ï¼ˆçº§å·®è®¡ç®—ï¼‰ | âœ… å·²è®¾è®¡ | å‘ä¸Šè¿½æº¯ï¼Œå–ä¸‹åŸåˆ™ |
| é€šé“ç®¡ç†ï¼ˆ8å®¶ï¼‰ | âœ… å·²è®¾è®¡ | é€šé“é€‚é…å™¨æ¨¡å¼ |
| ä»£ç†æ‹“å±•ï¼ˆæ³¨å†Œï¼‰ | âœ… å·²è®¾è®¡ | ä¸»åŠ¨/è¢«åŠ¨æ³¨å†Œï¼Œæ¨å¹¿ç  |
| è¥é”€æµ·æŠ¥/æ»šåŠ¨å›¾ | âœ… å·²è®¾è®¡ | åˆ†ç±»ç®¡ç†ï¼Œå›¾ç‰‡åŒæ­¥ |
| æ”¿ç­–æ¨¡æ¿ | âœ… å·²è®¾è®¡+æ›´æ–° | 4ç§è§„åˆ™ï¼Œçº§å·®é€»è¾‘ |
| T+0ç§’åˆ°è´¹ç‡ | âœ… å·²ç¡®è®¤ | åŠ 1/åŠ 2/åŠ 3å…ƒ/ç¬” |
| æ‰‹åŠ¨è°ƒè´¦ | âœ… å·²è®¾è®¡ | åå°ç®¡ç†åŠŸèƒ½ |
| ç»ˆç«¯ç®¡ç† | âœ… å·²è®¾è®¡ | ä¸‹å‘/å›æ‹¨ï¼Œä¸è·¨çº§ |
| å•†æˆ·ç®¡ç† | âœ… å·²è®¾è®¡ | ç›´è¥/å›¢é˜Ÿï¼Œè„±æ•å­˜å‚¨ |
| æ•°æ®åˆ†æ | âœ… å·²è®¾è®¡ | å•†æˆ·åˆ†ç±»ï¼Œæ’å |
| ä»£æ‰£ç®¡ç† | âœ… å·²è®¾è®¡ | ä¸Šçº§æ‰£æ¬¾ï¼Œä¼™ä¼´ä»£æ‰£ |
| é’±åŒ…ç³»ç»Ÿ | âœ… å·²è®¾è®¡ | 3ç§é’±åŒ…ï¼Œç¨ç­¹é€šé“ |
| æ¶ˆæ¯é€šçŸ¥ | âœ… å·²è®¾è®¡ | 3å¤©æœ‰æ•ˆæœŸ |

### 7.2 å¾…å®ç°å‰ç¡®è®¤çš„æ¨¡å—

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è´§æ¬¾ä»£æ‰£ | âœ… å·²ç¡®è®¤ | è¯¦è§ä¸‹æ–¹è§„åˆ™ |
| æœåŠ¡å•†å·æ•°æ®æƒé™ | âŒ æš‚ä¸å¼€å‘ | åç»­ç‰ˆæœ¬è€ƒè™‘ |
| æ²‰æ·€é’±åŒ…å€Ÿè´· | â³ çº¿ä¸‹å¤„ç† | ç³»ç»Ÿæš‚ä¸å¤„ç†åˆ©æ¯è®¡ç®— |

### 7.3 è´§æ¬¾ä»£æ‰£è§„åˆ™ï¼ˆå·²ç¡®è®¤ï¼‰â­

**åŠŸèƒ½è¯´æ˜**ï¼šåˆ’æ‹¨ç»ˆç«¯æ—¶ï¼Œä¸Šçº§å¯ç»™ä¸‹çº§è®¾ç½®è´§æ¬¾ä»£æ‰£

**å±•ç¤ºä½ç½®**ï¼šAPPç«¯ç‹¬ç«‹æ¨¡å—å±•ç° â­

**ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹**ï¼š
```
ä¸€å°POSæœºè´§æ¬¾50å…ƒ
ä»£ç†Aä»å…¬å¸æ‹¿äº†100å°
è´§æ¬¾ = 50 Ã— 100 = 5000å…ƒ
ä»£ç†Aæ²¡æœ‰ç»™å…¬å¸è´§æ¬¾
â†“
å…¬å¸ç»™ä»£ç†Aè®¾ç½®5000å…ƒçš„è´§æ¬¾ä»£æ‰£
ä»£ç†Aæ¥æ”¶å
é€‰æ‹©çš„é’±åŒ…æœ‰äº†é’±å°±ä¼šè¢«æ‰£èµ°
ç›´åˆ°æ‰£å¤Ÿ5000å…ƒåœæ­¢
```

**æ ¸å¿ƒè§„åˆ™**ï¼š

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| **è§¦å‘æ—¶æœº** | åˆ’æ‹¨ç»ˆç«¯æ—¶è®¾ç½® |
| **ç¡®è®¤æœºåˆ¶** | éœ€è¦ä¸‹çº§æ¥æ”¶ç¡®è®¤ |
| **æ‰£æ¬¾æ¥æº** | å¯é€‰æ‹©ï¼šåˆ†æ¶¦é’±åŒ… / è¿”ç°é’±åŒ… / ä¸¤ä¸ªéƒ½æ‰£ |
| **æ‰£æ¬¾æ–¹å¼** | æœ‰é’±å°±æ‰£ï¼Œç›´åˆ°æ‰£å¤Ÿè®¾å®šé‡‘é¢åœæ­¢ |
| **æƒé™èŒƒå›´** | æ¯çº§ä»£ç†å•†éƒ½æœ‰æ­¤æƒé™ï¼ˆAâ†’Bï¼ŒBâ†’Cï¼‰ |

**æ•°æ®åº“è®¾è®¡**ï¼š

```sql
-- è´§æ¬¾ä»£æ‰£è¡¨
CREATE TABLE cargo_deductions (
    id              BIGSERIAL PRIMARY KEY,
    deduction_no    VARCHAR(32) NOT NULL UNIQUE,  -- ä»£æ‰£ç¼–å·

    -- å…³è”æ–¹
    from_agent_id   BIGINT NOT NULL,              -- è®¾ç½®æ–¹ï¼ˆä¸Šçº§ï¼‰
    to_agent_id     BIGINT NOT NULL,              -- è¢«æ‰£æ–¹ï¼ˆä¸‹çº§ï¼‰

    -- ä»£æ‰£è®¾ç½®
    total_amount    DECIMAL(15,2) NOT NULL,       -- æ€»ä»£æ‰£é‡‘é¢
    deducted_amount DECIMAL(15,2) DEFAULT 0,      -- å·²æ‰£é‡‘é¢
    remaining_amount DECIMAL(15,2) NOT NULL,      -- å‰©ä½™å¾…æ‰£é‡‘é¢

    -- æ‰£æ¬¾æ¥æºè®¾ç½®
    deduct_from_profit  BOOLEAN DEFAULT TRUE,     -- ä»åˆ†æ¶¦é’±åŒ…æ‰£
    deduct_from_service BOOLEAN DEFAULT FALSE,    -- ä»æœåŠ¡è´¹é’±åŒ…æ‰£
    deduct_from_reward  BOOLEAN DEFAULT FALSE,    -- ä»å¥–åŠ±é’±åŒ…æ‰£

    -- å…³è”ç»ˆç«¯
    terminal_count  INT NOT NULL,                 -- ç»ˆç«¯æ•°é‡
    unit_price      DECIMAL(10,2) NOT NULL,       -- å•ä»·

    -- çŠ¶æ€
    status          SMALLINT DEFAULT 0,           -- 0å¾…æ¥æ”¶ 1å·²æ¥æ”¶ 2è¿›è¡Œä¸­ 3å·²å®Œæˆ 4å·²å–æ¶ˆ

    -- æ—¶é—´
    created_at      TIMESTAMP DEFAULT NOW(),
    accepted_at     TIMESTAMP,                    -- æ¥æ”¶æ—¶é—´
    completed_at    TIMESTAMP,                    -- å®Œæˆæ—¶é—´

    CONSTRAINT fk_from_agent FOREIGN KEY (from_agent_id) REFERENCES agents(id),
    CONSTRAINT fk_to_agent FOREIGN KEY (to_agent_id) REFERENCES agents(id)
);

-- è´§æ¬¾ä»£æ‰£æµæ°´è¡¨
CREATE TABLE cargo_deduction_logs (
    id              BIGSERIAL PRIMARY KEY,
    deduction_id    BIGINT NOT NULL,

    wallet_type     SMALLINT NOT NULL,            -- æ‰£æ¬¾é’±åŒ…ç±»å‹
    amount          DECIMAL(15,2) NOT NULL,       -- æœ¬æ¬¡æ‰£æ¬¾é‡‘é¢

    deducted_before DECIMAL(15,2) NOT NULL,       -- æ‰£å‰å·²æ‰£é‡‘é¢
    deducted_after  DECIMAL(15,2) NOT NULL,       -- æ‰£åå·²æ‰£é‡‘é¢

    created_at      TIMESTAMP DEFAULT NOW()
);
```

**ä»£ç å®ç°è¦ç‚¹**ï¼š

```go
// internal/app/deduction/cargo_deduction.go

// CargoDeductionService è´§æ¬¾ä»£æ‰£æœåŠ¡
type CargoDeductionService struct {
    deductionRepo CargoDeductionRepository
    walletSvc     WalletService
}

// Create åˆ›å»ºè´§æ¬¾ä»£æ‰£ï¼ˆåˆ’æ‹¨ç»ˆç«¯æ—¶è°ƒç”¨ï¼‰
func (s *CargoDeductionService) Create(req *CreateCargoDeductionReq) error {
    deduction := &CargoDeduction{
        FromAgentID:     req.FromAgentID,
        ToAgentID:       req.ToAgentID,
        TotalAmount:     req.UnitPrice.Mul(decimal.NewFromInt(int64(req.TerminalCount))),
        RemainingAmount: req.TotalAmount,
        TerminalCount:   req.TerminalCount,
        UnitPrice:       req.UnitPrice,
        DeductFromProfit:  req.DeductFromProfit,
        DeductFromService: req.DeductFromService,
        Status:          StatusPending, // å¾…æ¥æ”¶
    }
    return s.deductionRepo.Create(deduction)
}

// Accept ä¸‹çº§æ¥æ”¶ä»£æ‰£
func (s *CargoDeductionService) Accept(deductionID, agentID int64) error {
    deduction, _ := s.deductionRepo.GetByID(deductionID)
    if deduction.ToAgentID != agentID {
        return errors.New("æ— æƒæ“ä½œ")
    }
    deduction.Status = StatusAccepted
    deduction.AcceptedAt = time.Now()
    return s.deductionRepo.Update(deduction)
}

// TryDeduct å°è¯•æ‰£æ¬¾ï¼ˆé’±åŒ…å…¥è´¦åè°ƒç”¨ï¼‰
func (s *CargoDeductionService) TryDeduct(agentID int64, walletType int) error {
    // 1. æŸ¥è¯¢è¯¥ä»£ç†å•†è¿›è¡Œä¸­çš„è´§æ¬¾ä»£æ‰£
    deductions, _ := s.deductionRepo.GetActiveByAgent(agentID)

    for _, d := range deductions {
        // 2. æ£€æŸ¥æ˜¯å¦ä»è¯¥é’±åŒ…æ‰£
        if !s.shouldDeductFrom(d, walletType) {
            continue
        }

        // 3. è·å–é’±åŒ…ä½™é¢
        balance := s.walletSvc.GetBalance(agentID, walletType)
        if balance.LessThanOrEqual(decimal.Zero) {
            continue
        }

        // 4. è®¡ç®—æœ¬æ¬¡æ‰£æ¬¾é‡‘é¢
        deductAmount := decimal.Min(balance, d.RemainingAmount)

        // 5. æ‰§è¡Œæ‰£æ¬¾
        s.walletSvc.DeductBalance(agentID, walletType, deductAmount, "è´§æ¬¾ä»£æ‰£", d.DeductionNo)

        // 6. æ›´æ–°ä»£æ‰£è®°å½•
        d.DeductedAmount = d.DeductedAmount.Add(deductAmount)
        d.RemainingAmount = d.RemainingAmount.Sub(deductAmount)

        if d.RemainingAmount.LessThanOrEqual(decimal.Zero) {
            d.Status = StatusCompleted
            d.CompletedAt = time.Now()
        }

        s.deductionRepo.Update(d)
    }
    return nil
}
```

**ä¸šåŠ¡æµç¨‹å›¾**ï¼š

```
ä¸Šçº§åˆ’æ‹¨ç»ˆç«¯ç»™ä¸‹çº§
        â”‚
        â–¼
è®¾ç½®è´§æ¬¾ä»£æ‰£ï¼ˆé‡‘é¢ã€æ‰£æ¬¾æ¥æºï¼‰
        â”‚
        â–¼
ä¸‹çº§æ”¶åˆ°ä»£æ‰£é€šçŸ¥
        â”‚
        â–¼
ä¸‹çº§æ¥æ”¶ç¡®è®¤ â”€â”€â†’ æ‹’ç»åˆ™å–æ¶ˆåˆ’æ‹¨ï¼Ÿ
        â”‚
        â–¼
â­ APPç«¯ç»‘å®šè¯¥ä»£ç†å•†ï¼ˆç”¨äºåç»­è‡ªåŠ¨æ‰£æ¬¾ï¼‰
        â”‚
        â–¼
ä»£æ‰£çŠ¶æ€å˜ä¸º"è¿›è¡Œä¸­"
        â”‚
        â–¼
ä¸‹çº§é’±åŒ…æœ‰å…¥è´¦æ—¶è§¦å‘ TryDeduct()
        â”‚
        â”œâ”€â”€ åˆ†æ¶¦å…¥è´¦ â†’ æ£€æŸ¥æ˜¯å¦ä»åˆ†æ¶¦é’±åŒ…æ‰£
        â”œâ”€â”€ è¿”ç°å…¥è´¦ â†’ æ£€æŸ¥æ˜¯å¦ä»æœåŠ¡è´¹é’±åŒ…æ‰£
        â””â”€â”€ å¥–åŠ±å…¥è´¦ â†’ æ£€æŸ¥æ˜¯å¦ä»å¥–åŠ±é’±åŒ…æ‰£
        â”‚
        â–¼
æ‰£å¤Ÿé‡‘é¢åï¼ŒçŠ¶æ€å˜ä¸º"å·²å®Œæˆ"
```

**APPç«¯ç»‘å®šè¦æ±‚** â­ï¼ˆæ–°å¢ï¼‰ï¼š

| è¦æ±‚ | è¯´æ˜ |
|------|------|
| **ç»‘å®šæ—¶æœº** | ç»ˆç«¯åˆ’æ‹¨æ—¶è®¾ç½®è´§æ¬¾ä»£æ‰£ |
| **ç»‘å®šç›®çš„** | APPç«¯éœ€ç»‘å®šè¯¥ä»£ç†å•†ï¼Œç”¨äºåç»­è‡ªåŠ¨ä»å…¶é’±åŒ…æ‰£æ¬¾ |
| **æŠ€æœ¯å®ç°** | ä»£æ‰£è®°å½•éœ€å…³è”ä»£ç†å•†IDï¼Œé’±åŒ…å…¥è´¦æ—¶è‡ªåŠ¨è§¦å‘æ‰£æ¬¾æ£€æŸ¥ |

---

## å…«ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… ç¡®è®¤é—ç•™é—®é¢˜å·²æ›´æ–°
2. âœ… ç¡®è®¤4ç§åˆ†æ¶¦è§„åˆ™ç†è§£æ­£ç¡®
3. âœ… æ›´æ–°æŠ¼é‡‘/æµé‡è¿”ç°ä¸ºçº§å·®é€»è¾‘
4. âœ… æ·»åŠ æ”¿ç­–æ¨¡æ¿åˆ’æ‹¨çº¦æŸè§„åˆ™
5. âœ… å®Œæˆè®¾è®¡å®Œæ•´æ€§æ£€æŸ¥
6. â³ å¼€å§‹å®ç°åç«¯ä»£ç 

---

## ä¹ã€å®ç°ä¼˜å…ˆçº§å»ºè®®

### Phase 1: åŸºç¡€æ¶æ„ (Week 1-3)
- [ ] é¡¹ç›®æ¡†æ¶æ­å»º
- [ ] æ•°æ®åº“è®¾è®¡ä¸è¿ç§»
- [ ] é€šé“ç®¡ç†æ¨¡å—
- [ ] ç”¨æˆ·è®¤è¯ä¸æƒé™

### Phase 2: æ ¸å¿ƒä¸šåŠ¡ (Week 4-10) â­
- [ ] ä»£ç†å•†ç®¡ç†ï¼ˆæ ‘ç»“æ„ã€æ¨å¹¿ç ï¼‰
- [ ] æ”¿ç­–æ¨¡æ¿å¼•æ“ï¼ˆ4ç§è§„åˆ™é…ç½®ï¼‰
- [ ] ç»ˆç«¯ç®¡ç†ï¼ˆä¸‹å‘ã€å›æ‹¨ã€æ”¿ç­–æ¨¡æ¿æ ¡éªŒï¼‰
- [ ] å•†æˆ·ç®¡ç†
- [ ] äº¤æ˜“æµæ°´æ¥æ”¶
- [ ] **åˆ†æ¶¦è®¡ç®—ï¼ˆ4ç§ç±»å‹+çº§å·®é€»è¾‘ï¼‰**

### Phase 3: é’±åŒ…ä¸è´¢åŠ¡ (Week 11-14)
- [ ] é’±åŒ…æ¨¡å—ï¼ˆ3ç§é’±åŒ…ï¼‰
- [ ] æç°ç®¡ç†ï¼ˆç¨ç­¹é€šé“å¯¹æ¥ï¼‰
- [ ] ä»£æ‰£ç®¡ç†
- [ ] æ‰‹åŠ¨è°ƒè´¦åŠŸèƒ½

### Phase 4: æ•°æ®ä¸è¥é”€ (Week 15-17)
- [ ] æ•°æ®åˆ†ææ¨¡å—
- [ ] æ”¶ç›Šç»Ÿè®¡
- [ ] è¥é”€æµ·æŠ¥ã€æ¨å¹¿ç 
- [ ] æ¶ˆæ¯é€šçŸ¥

---

## åã€é‡‘é¢è®¡ç®—ä¸¥è°¨æ€§è¦æ±‚ â­ï¼ˆæ–°å¢ï¼‰

æ ¹æ®ä¸šåŠ¡é€»è¾‘æ¢³ç†ç¬¬242è¡Œè¦æ±‚ï¼Œæœ¬ç³»ç»Ÿå¯¹é‡‘é¢è®¡ç®—æœ‰ä¸¥æ ¼çš„è¦æ±‚ï¼š

### 10.1 æ ¸å¿ƒåŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **å‰åä¸€è‡´** | æ‰€æœ‰é’±åŒ…å˜åŠ¨å¿…é¡»å‰åä¸€è‡´ï¼Œæœ‰æ®å¯æŸ¥ |
| **æ¥æºå¯æº¯** | é‡‘é¢ä¸èƒ½å‡­ç©ºäº§ç”Ÿï¼Œå¿…é¡»åŸºäºä¸šåŠ¡æ•°æ®æ¥æº |
| **å…¨ç¨‹è®°å½•** | æ‰€æœ‰å˜åŠ¨å¿…é¡»æœ‰è®°å½•è¡¨è®°å½• |
| **è‡ªåŠ¨æµ‹è¯•** | æ¯æ¬¡æ‰“åŒ…å¿…é¡»æµ‹è¯•é€šè¿‡æ‰èƒ½å‘å¸ƒ |

### 10.2 æ¶‰åŠé‡‘é¢çš„å…³é”®æ¨¡å—

```
é‡‘é¢æ•æ„Ÿæ¨¡å—
â”œâ”€â”€ åˆ†æ¶¦è®¡ç®—ï¼ˆ4ç§ç±»å‹ï¼‰
â”‚   â”œâ”€â”€ äº¤æ˜“åˆ†æ¶¦
â”‚   â”œâ”€â”€ æ¿€æ´»å¥–åŠ±
â”‚   â”œâ”€â”€ æŠ¼é‡‘è¿”ç°
â”‚   â””â”€â”€ æµé‡è´¹è¿”ç°
â”‚
â”œâ”€â”€ é’±åŒ…ç³»ç»Ÿï¼ˆ5ç§é’±åŒ…ï¼‰
â”‚   â”œâ”€â”€ åˆ†æ¶¦é’±åŒ…
â”‚   â”œâ”€â”€ æœåŠ¡è´¹é’±åŒ…
â”‚   â”œâ”€â”€ å¥–åŠ±é’±åŒ…
â”‚   â”œâ”€â”€ å……å€¼é’±åŒ…
â”‚   â””â”€â”€ æ²‰æ·€é’±åŒ…
â”‚
â”œâ”€â”€ ä»£æ‰£ç®¡ç†
â”‚   â”œâ”€â”€ è´§æ¬¾ä»£æ‰£
â”‚   â”œâ”€â”€ ä¸Šçº§æ‰£æ¬¾
â”‚   â””â”€â”€ ä¼™ä¼´ä»£æ‰£
â”‚
â””â”€â”€ æç°ç®¡ç†
    â”œâ”€â”€ ç¨è´¹è®¡ç®—
    â””â”€â”€ å®é™…åˆ°è´¦è®¡ç®—
```

### 10.3 å®¡è®¡è¦æ±‚

1. **æ¯ç¬”åˆ†æ¶¦å¿…é¡»æœ‰æµæ°´è®°å½•**ï¼š
   - æ¥æºäº¤æ˜“ID
   - è®¡ç®—å…¬å¼å‚æ•°
   - è®¡ç®—ç»“æœ

2. **æ¯æ¬¡é’±åŒ…å˜åŠ¨å¿…é¡»æœ‰æ—¥å¿—**ï¼š
   - å˜åŠ¨å‰ä½™é¢
   - å˜åŠ¨é‡‘é¢
   - å˜åŠ¨åä½™é¢
   - å˜åŠ¨ç±»å‹å’ŒåŸå› 
   - å…³è”ä¸šåŠ¡å•å·

3. **å¯¹è´¦æœºåˆ¶**ï¼š
   - å®šæ—¶å¯¹è´¦ä»»åŠ¡
   - å¼‚å¸¸å‘Šè­¦

### 10.4 è‡ªåŠ¨åŒ–æµ‹è¯•è¦æ±‚

```go
// é‡‘é¢è®¡ç®—æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

func TestProfitCalculation(t *testing.T) {
    // 1. å•çº§ä»£ç†åˆ†æ¶¦
    // 2. å¤šçº§ä»£ç†åˆ†æ¶¦
    // 3. æ— çº§å·®æƒ…å†µï¼ˆå–ä¸‹åŸåˆ™ï¼‰
    // 4. è¾¹ç•Œæ¡ä»¶æµ‹è¯•
}

func TestWalletBalance(t *testing.T) {
    // 1. å…¥è´¦åä½™é¢éªŒè¯
    // 2. æç°åä½™é¢éªŒè¯
    // 3. ä»£æ‰£åä½™é¢éªŒè¯
    // 4. å¹¶å‘æ“ä½œæµ‹è¯•
}

func TestDeductionFlow(t *testing.T) {
    // 1. è´§æ¬¾ä»£æ‰£å®Œæ•´æµç¨‹
    // 2. å¤šé’±åŒ…åŒæ—¶æ‰£æ¬¾
    // 3. æ‰£å¤Ÿåœæ­¢éªŒè¯
}
```

**CI/CDè¦æ±‚**ï¼šæ¯æ¬¡æ‰“åŒ…å‰å¿…é¡»è¿è¡Œå®Œæ•´çš„é‡‘é¢ç›¸å…³æµ‹è¯•å¥—ä»¶ï¼Œå…¨éƒ¨é€šè¿‡æ‰èƒ½å‘å¸ƒã€‚

---

## åä¸€ã€APPæ ¸å¿ƒåŠŸèƒ½æ¸…å•

### 11.1 é¦–é¡µæ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æ»šåŠ¨å›¾ | é¦–é¡µè½®æ’­å®£ä¼ å›¾ |
| ä»Šæ—¥æ”¶ç›Š | æ˜¾ç¤ºä»Šæ—¥åˆ†æ¶¦æ€»é¢ |
| å¿«æ·å…¥å£ | å¸¸ç”¨åŠŸèƒ½å…¥å£ |
| æ¶ˆæ¯é€šçŸ¥ | æœªè¯»æ¶ˆæ¯æé†’ï¼ˆ3å¤©æœ‰æ•ˆæœŸï¼‰|

### 11.2 ä»£ç†æ‹“å±•æ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æ¨å¹¿ç å±•ç¤º | äºŒç»´ç +é“¾æ¥ |
| ä¿å­˜ç›¸å†Œ | äºŒç»´ç ä¿å­˜åˆ°æœ¬åœ° |
| å¤åˆ¶é“¾æ¥ | åˆ†äº«ç»™ä¸‹çº§ä»£ç† |
| æ‰‹åŠ¨æ·»åŠ ä»£ç† | è¢«åŠ¨æ³¨å†Œæ–¹å¼ |

### 11.3 ç»ˆç«¯ç®¡ç†æ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ç»ˆç«¯åˆ—è¡¨ | æ€»æ•°ã€å·²æ¿€æ´»ã€æœªæ¿€æ´»ã€æ˜¨æ—¥/ä»Šæ—¥/æœ¬æœˆæ¿€æ´»æ•° |
| ç»ˆç«¯åˆ’æ‹¨ | ä¸å¯è·¨çº§ |
| ç»ˆç«¯å›æ‹¨ | ä¸å¯è·¨çº§ï¼Œæœªæ¿€æ´»æ‰èƒ½å›æ‹¨ |
| æ‰¹é‡è®¾ç½®è´¹ç‡ | 0.53%-0.6% |
| æ‰¹é‡è®¾ç½®SIMå¡ | é¦–æ¬¡/éé¦–æ¬¡é‡‘é¢ã€é—´éš”å¤©æ•° |
| æ‰¹é‡è®¾ç½®æŠ¼é‡‘ | æ— /99/199/299å…ƒ |
| åˆ’æ‹¨/å›æ‹¨è®°å½• | æ“ä½œå†å² |

### 11.4 è´§æ¬¾ä»£æ‰£æ¨¡å—ï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ä»£æ‰£åˆ—è¡¨ | å¾…æ¥æ”¶ã€è¿›è¡Œä¸­ã€å·²å®Œæˆ |
| è®¾ç½®ä»£æ‰£ | åˆ’æ‹¨æ—¶è®¾ç½®é‡‘é¢å’Œæ‰£æ¬¾æ¥æº |
| æ¥æ”¶ä»£æ‰£ | ä¸‹çº§ç¡®è®¤æ¥æ”¶ |
| ä»£æ‰£è¿›åº¦ | å·²æ‰£/å¾…æ‰£é‡‘é¢ |

### 11.5 å•†æˆ·ç®¡ç†æ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| å•†æˆ·åˆ—è¡¨ | ç›´è¥/å›¢é˜Ÿå•†æˆ· |
| å•†æˆ·è¯¦æƒ… | è„±æ•ä¿¡æ¯ã€äº¤æ˜“ç»Ÿè®¡ |
| è´¹ç‡ä¿®æ”¹ | è°ƒç”¨é€šé“æ¥å£å®æ—¶ç”Ÿæ•ˆ |
| æŠ¼é‡‘/æµé‡å¡è®¾ç½® | ä¸‹å‘åˆ°æœºå…· |
| äº’æŸ¥åŠŸèƒ½ | å§“å/ç¼–å·/æœºå…·å·äº’æŸ¥ |

### 11.6 æ•°æ®åˆ†ææ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| äº¤æ˜“æŸ¥è¯¢ | å…¨éƒ¨/ç›´è¥/å›¢é˜Ÿï¼Œæœ€è¿‘6ä¸ªæœˆ |
| å•†æˆ·åˆ†ç±» | å¿ è¯š/ä¼˜è´¨/æ½œåŠ›/ä¸€èˆ¬/ä½æ´»è·ƒ/æ— äº¤æ˜“ |
| ä»£ç†æ’å | äº¤æ˜“é‡/ç¬”æ•°/ç»ˆç«¯æ•°æ’å |
| å®¢æˆ·åˆ†æ | åˆ·å¡/æ”¯ä»˜å®/å¾®ä¿¡å æ¯” |

### 11.7 æ”¶ç›Šç»Ÿè®¡æ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ä»Šæ—¥æ”¶ç›Š | äº¤æ˜“æ”¶ç›Šã€æŠ¼é‡‘è¿”ç°ã€æµé‡è¿”ç°æ˜ç»† |
| æ”¶ç›Šè¶‹åŠ¿ | è¿‘7å¤©ã€è¿‘30å¤© |
| æœˆæ”¶ç›Š | è¿‘6æœˆã€1å¹´ã€2å¹´ |

### 11.8 é’±åŒ…æ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| é’±åŒ…ä½™é¢ | æŒ‰é€šé“+ç±»å‹åˆ†ç¦»æ˜¾ç¤º |
| æç°ç”³è¯· | è¾¾åˆ°é—¨æ§›å¯æç° |
| æç°è®°å½• | å†å²è®°å½• |
| å……å€¼é’±åŒ… | å¯éšè— |
| æ²‰æ·€é’±åŒ… | å¯éšè— |

### 11.9 ä»£æ‰£ç®¡ç†æ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ä¸Šçº§æ‰£æ¬¾ | å‘èµ·â†’ç¡®è®¤ |
| ä¼™ä¼´ä»£æ‰£ | å‘èµ·â†’ç¡®è®¤ |
| ä»£æ‰£è®°å½• | å†å²è®°å½• |

### 11.10 æˆ‘çš„ä¿¡æ¯æ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| åŸºæœ¬ä¿¡æ¯ | å§“åã€æ‰‹æœºå·ã€ç¼–å·ã€å…¥ç½‘æ—¶é—´ |
| èº«ä»½è¯å· | è„±æ•æ˜¾ç¤º |
| ç»“ç®—å¡ | æ”¯æŒæ›´æ”¹ |
| è´¹ç‡æˆæœ¬ | æ˜¾ç¤ºå½“å‰è´¹ç‡ |
| é‚€è¯·ç  | å”¯ä¸€ï¼Œå¯è‡ªå®šä¹‰é“å· |

### 11.11 è¥é”€æµ·æŠ¥æ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æµ·æŠ¥åˆ—è¡¨ | æŒ‰åˆ†ç±»å±•ç¤º |
| ä¿å­˜æµ·æŠ¥ | ä¿å­˜åˆ°æœ¬åœ°ç›¸å†Œ |

### 11.12 æ¶ˆæ¯é€šçŸ¥æ¨¡å—

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æ¶ˆæ¯åˆ—è¡¨ | åˆ†æ¶¦/æ³¨å†Œ/æ¶ˆè´¹/èŠ‚å‡æ—¥æé†’ |
| æ¶ˆæ¯è¯¦æƒ… | æŸ¥çœ‹å†å²æ¶ˆæ¯ |
| æœ‰æ•ˆæœŸ | 3å¤©å†…æœªæŸ¥çœ‹ä¸€ç›´æ´»è·ƒ |
