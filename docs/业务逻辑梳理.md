# 收享付业务逻辑梳理

## 一、首页与统计分析模块

### 1.1 数据统计范围

系统支持两种统计范围：
- **直营(direct)**: 仅统计当前代理商直接关联的商户和交易
- **团队(team)**: 统计当前代理商及其所有下级代理商的商户和交易

### 1.2 物化路径查询

为优化团队范围查询性能，使用物化路径方案：
- `agents.agent_path` 字段存储完整路径，如 `/1/5/12/`
- 查询团队时使用 `LIKE '/1/5/%'` 匹配所有下级
- 代理商注册时自动拼接路径，转移时批量更新

### 1.3 收益分类

今日收益按来源分为四类：
| 类型 | 字段 | 说明 |
|------|------|------|
| 交易分润 | profit_trade | 交易金额产生的分润 |
| 押金返现 | profit_deposit | 终端押金返还 |
| 流量返现 | profit_sim | SIM卡流量返现 |
| 激活奖励 | profit_reward | 终端激活奖励 |

### 1.4 汇总表设计

为提升查询性能，维护两张汇总表：

**agent_daily_stats（每日汇总）**
- 每10分钟增量刷新今日数据
- 存储交易额、交易笔数、四类收益、商户数、终端激活数

**agent_monthly_stats（每月汇总）**
- 每日凌晨2点汇总前一日数据到月表
- 存储月度交易总额、分润总额、商户终端统计

### 1.5 商户类型分类

根据月均交易额将商户分为6类：
| 类型 | 月均交易额 | 说明 |
|------|-----------|------|
| loyal | ≥5万元 | 忠诚客户 |
| quality | 3-5万元 | 优质客户 |
| potential | 2-3万元 | 潜力客户 |
| normal | 1-2万元 | 一般客户 |
| low_active | <1万元 | 低活跃客户 |
| inactive | 无交易 | 30天无交易 |

分类由 `MerchantTypeCalculatorJob` 每日凌晨计算更新。

### 1.6 排名功能

**代理商排名**
- 支持按交易额、分润、终端激活数排名
- 支持本日/本周/本月时间范围
- 默认展示TOP10

**商户排名**
- 按本月交易额排名
- 支持按商户类型筛选
- 商户名称脱敏显示

### 1.7 通道统计

统计各支付通道的交易占比：
- 计算各通道交易额和笔数
- 计算百分比占比
- 展示通道成功率

---

## 二、API接口清单

### 2.1 仪表盘接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/dashboard/overview | 概览数据(支持scope参数) |
| GET | /api/v1/dashboard/charts | 趋势图表(支持days参数) |
| GET | /api/v1/dashboard/channel-stats | 通道统计 |
| GET | /api/v1/dashboard/merchant-distribution | 商户类型分布 |
| GET | /api/v1/dashboard/recent-transactions | 最近交易 |

### 2.2 分析接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/analytics/agent-ranking | 代理商排名 |
| GET | /api/v1/analytics/merchant-ranking | 商户排名 |
| GET | /api/v1/analytics/summary | 分析汇总 |

---

## 三、定时任务

| 任务名 | 执行周期 | 说明 |
|--------|---------|------|
| AgentStatsRefreshJob | 每10分钟 | 刷新今日汇总表 |
| AgentStatsDailyJob | 每日凌晨2点 | 全量刷新+月表汇总 |
| StatsConsistencyChecker | 每日凌晨4点 | 数据一致性校验 |
| MerchantTypeCalculatorJob | 每日凌晨3点 | 商户类型计算 |

---

## 四、前端页面

### 4.1 APP端

- **首页(HomePage)**: 今日收益、四宫格分润、快捷入口、最近交易
- **数据分析页(AnalyticsPage)**: Tab切换、时间选择、趋势图、通道占比、商户分布

### 4.2 PC端

- **代理商工作台(DashboardView)**: 直营/团队Tab、6卡片统计、趋势图、通道饼图、商户柱状图、排名列表
- **管理员控制台(AdminDashboardView)**: 全平台汇总、通道运营、运营预警、代理商排行

---

## 五、数据一致性保障

1. **汇总表校验**: 每日对比汇总表与原始表SUM()，差异超过1元则告警
2. **金额单位**: 所有金额存储使用分(int64)，展示时转换为元
3. **路径维护**: 代理商注册/转移时自动维护agent_path
