# 代理/商户转移功能业务梳理

> 本文档通过苏格拉底式提问梳理，明确了代理转移和商户转移两个功能的业务规则。

---

## 一、功能概述

| 功能 | 说明 |
|------|------|
| **代理转移** | 代理A 从原上级移动到 代理B 名下（更换上级） |
| **商户+终端转移** | 将商户及其绑定的终端从原代理转移到新代理名下 |

**核心原则**：
- 转移前的历史数据归原代理
- 转移后的新交易和分润归新代理

---

## 二、功能一：代理转移（更换上级）

### 2.1 业务场景

代理A 需要更换上级，从原来的上级移动到新的代理B 名下。

```
转移前:
  原上级 → 代理A → 代理A的下级们
                 → 代理A的商户们

转移后:
  代理B → 代理A → 代理A的下级们
                → 代理A的商户们
```

### 2.2 业务规则

| 规则项 | 处理方式 | 说明 |
|--------|----------|------|
| **下级代理** | 跟着一起转移 | 整个子树移动，下级的 ParentID 不变，仍指向代理A |
| **直属商户** | 仍归属代理A | AgentID 不变，商户跟着代理A走 |
| **层级(Level)** | 重新计算 | 代理A及其所有下级的Level需要根据新位置重算 |
| **分润政策** | 需要重新配置 | 代理A相对于新上级代理B的分润政策需要重新设置 |
| **跨层级转移** | 允许 | 任意层级的代理都可以转移到任意层级的代理下 |
| **循环检测** | 需要校验 | 不允许将代理移动到自己的下级名下（防止循环引用） |

### 2.3 历史数据处理

| 数据类型 | 处理方式 |
|----------|----------|
| **转移前的分润记录** | 归原上级链，保持不变 |
| **转移后的新交易分润** | 按新的层级关系计算，代理B作为新上级参与级差分润 |

### 2.4 数据变更

| 表名 | 字段 | 变更说明 |
|------|------|----------|
| `agents` | `parent_id` | 代理A的上级改为代理B的ID |
| `agents` | `level` | 代理A及其所有下级的Level重新计算 |

### 2.5 校验规则

1. **目标代理存在**：代理B必须存在且状态正常
2. **循环检测**：代理B不能是代理A的下级（防止 A→B→...→A 的循环）
3. **自身检测**：代理A不能移动到自己名下

---

## 三、功能二：商户+终端转移

### 3.1 业务场景

将商户（及其绑定的终端）从原代理转移到新代理名下。

```
转移前:
  原代理A → 商户M → 终端T

转移后:
  新代理B → 商户M → 终端T
```

### 3.2 业务规则

| 规则项 | 处理方式 | 说明 |
|--------|----------|------|
| **操作权限** | 仅管理员 | 只有平台管理员可以执行商户转移操作 |
| **商户归属** | 变更 | Merchant.AgentID 改为新代理ID |
| **终端归属** | 一起变更 | Terminal.OwnerAgentID 也改为新代理ID |
| **终端绑定关系** | 保持不变 | Terminal.MerchantID 仍指向原商户 |

### 3.3 历史数据处理

| 数据类型 | 处理方式 |
|----------|----------|
| **已入账的分润** | 归原代理，已进入钱包的不变 |
| **新交易产生的分润** | 归新代理及其上级链 |
| **未完成的押金返现** | 改为返给新代理 |
| **未完成的激活奖励** | 改为返给新代理 |

> **说明**：分润是实时计算入账的，不存在"待结算"的分润。

### 3.4 数据变更

| 表名 | 字段 | 变更说明 |
|------|------|----------|
| `merchants` | `agent_id` | 变更为新代理ID |
| `terminals` | `owner_agent_id` | 变更为新代理ID |
| `deposit_cashback_records` | `agent_id` | 未入账(wallet_status=0)的记录变更为新代理 |
| `activation_reward_records` | `agent_id` | 未入账(wallet_status=0)的记录变更为新代理 |

### 3.5 校验规则

1. **目标代理存在**：新代理必须存在且状态正常
2. **商户状态**：商户状态正常才能转移

---

## 四、通用要求

### 4.1 操作日志

两个功能都需要记录完整的转移日志：

| 字段 | 说明 |
|------|------|
| `transfer_type` | 转移类型：agent/merchant |
| `target_id` | 被转移对象ID（代理ID或商户ID） |
| `from_agent_id` | 原归属代理ID |
| `to_agent_id` | 新归属代理ID |
| `operator_id` | 操作人ID |
| `transfer_time` | 转移时间 |
| `remark` | 备注（可选） |

### 4.2 实现范围

| 端 | 是否需要 |
|----|----------|
| PC端管理后台 | ✅ 需要 |
| APP端 | ❌ 不需要 |

### 4.3 权限控制

- 仅管理员可见、可操作
- 普通代理商不可见此功能

---

## 五、业务流程图

### 5.1 代理转移流程

```
┌─────────────────────────────────────────────────────────────┐
│                     代理转移流程                              │
├─────────────────────────────────────────────────────────────┤
│  1. 管理员选择要转移的代理A                                    │
│                    ↓                                         │
│  2. 选择目标上级代理B                                         │
│                    ↓                                         │
│  3. 系统校验：                                                │
│     - 代理B存在且状态正常                                      │
│     - 代理B不是代理A的下级（防循环）                            │
│                    ↓                                         │
│  4. 执行转移：                                                │
│     - 更新代理A的 parent_id = 代理B的ID                        │
│     - 递归更新代理A及其下级的 level                            │
│                    ↓                                         │
│  5. 记录转移日志                                              │
│                    ↓                                         │
│  6. 提示：需要重新配置代理A的分润政策                           │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 商户转移流程

```
┌─────────────────────────────────────────────────────────────┐
│                   商户+终端转移流程                            │
├─────────────────────────────────────────────────────────────┤
│  1. 管理员选择要转移的商户M                                    │
│                    ↓                                         │
│  2. 选择目标代理B                                             │
│                    ↓                                         │
│  3. 系统校验：                                                │
│     - 代理B存在且状态正常                                      │
│     - 商户状态正常                                            │
│                    ↓                                         │
│  4. 执行转移：                                                │
│     - 更新商户的 agent_id = 代理B的ID                          │
│     - 更新关联终端的 owner_agent_id = 代理B的ID                │
│     - 更新未入账的押金返现记录的 agent_id                       │
│     - 更新未入账的激活奖励记录的 agent_id                       │
│                    ↓                                         │
│  5. 记录转移日志                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 六、注意事项

### 6.1 代理转移注意事项

1. **分润政策需重新配置**：转移后，代理A与新上级代理B之间的分润政策需要管理员手动配置
2. **历史分润不追溯**：已经产生的分润记录不会因为转移而重新计算归属
3. **Level连锁更新**：代理A的Level变化会影响其所有下级的Level

### 6.2 商户转移注意事项

1. **终端一起转移**：商户绑定的终端归属权也会一起变更
2. **押金返现变更**：未完成的押金返现周期会改为返给新代理
3. **激活奖励变更**：未触发的激活奖励会改为归新代理

---

## 七、后续开发任务

确认本文档后，需要开发以下内容：

### 后端
- [ ] 创建转移日志模型 `TransferLog`
- [ ] 实现代理转移API `/api/admin/agents/:id/transfer`
- [ ] 实现商户转移API `/api/admin/merchants/:id/transfer`
- [ ] 实现循环检测算法
- [ ] 实现Level递归更新算法
- [ ] 创建数据库迁移脚本

### PC端
- [ ] 代理管理页面增加「转移」操作按钮
- [ ] 商户管理页面增加「转移」操作按钮
- [ ] 转移弹窗组件（选择目标代理）
- [ ] 转移日志查看页面

---

> 文档创建时间：2025年1月
> 状态：待确认
