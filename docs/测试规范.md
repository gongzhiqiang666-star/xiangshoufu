# 测试规范

本文档定义了后端(Go)、PC端(Vue3)和APP端(Flutter)的完整测试规范。

---

## 一、核心原则

| 之前 | 之后 |
|------|------|
| 编译通过就部署 | 测试通过才部署 |
| 手动测试验证 | 一个命令自动验证 |
| 改代码担心破坏旧功能 | 测试会告诉你哪里坏了 |
| Bug在生产环境发现 | Bug在开发时就被发现 |

---

## 二、测试金字塔

```
┌─────────────────────────────────────────────────────────┐
│  E2E测试 (10%)   │ 端到端测试，真实用户流程            │
├─────────────────────────────────────────────────────────┤
│  集成测试 (20%)  │ 多模块协作、API测试                 │
├─────────────────────────────────────────────────────────┤
│  组件测试 (20%)  │ UI组件渲染、交互测试                │
├─────────────────────────────────────────────────────────┤
│  单元测试 (50%)  │ 工具函数、Service、Store/Provider  │
└─────────────────────────────────────────────────────────┘
```

---

## 三、必须测试的4种场景

每个函数/组件必须覆盖以下场景：

| 场景 | 说明 | 示例 |
|------|------|------|
| 正常流程 | Happy Path | `formatAmount(100) → "1.00"` |
| 边界情况 | Edge Cases | `formatAmount(0) → "0.00"` |
| 错误处理 | Error Handling | `formatAmount(-100) → "-1.00"` |
| 特殊输入 | Special Inputs | `formatAmount(10000000) → "100,000.00"` |

---

## 四、后端测试规范 (Go)

### 4.1 测试命令

```bash
cd server

# 运行所有测试
go test ./...

# 运行指定模块测试（带详细输出）
go test ./internal/service/... -v

# 查看覆盖率
go test ./internal/service/... -cover

# 生成覆盖率报告
go test ./... -coverprofile=coverage.out
go tool cover -html=coverage.out -o coverage.html
```

### 4.2 目录结构

```
server/internal/
├── service/
│   ├── wallet_service.go
│   └── wallet_service_test.go      # 同目录下的测试文件
├── handler/
│   ├── wallet_handler.go
│   └── wallet_handler_test.go
├── repository/
│   ├── wallet_repository.go
│   └── wallet_repository_test.go
└── channel/
    └── hengxintong/
        ├── adapter.go
        └── adapter_test.go
```

### 4.3 测试文件命名规范

| 源文件 | 测试文件 |
|--------|----------|
| `xxx_service.go` | `xxx_service_test.go` |
| `xxx_handler.go` | `xxx_handler_test.go` |
| `adapter.go` | `adapter_test.go` |

### 4.4 单元测试模板

```go
package service

import (
    "testing"
)

func TestCalculateProfit(t *testing.T) {
    // ✅ 正常流程
    t.Run("should calculate profit correctly", func(t *testing.T) {
        result := CalculateProfit(10000, 0.001)
        if result != 10 {
            t.Errorf("expected 10, got %d", result)
        }
    })

    // ✅ 边界情况
    t.Run("should handle zero amount", func(t *testing.T) {
        result := CalculateProfit(0, 0.001)
        if result != 0 {
            t.Errorf("expected 0, got %d", result)
        }
    })

    // ✅ 错误处理
    t.Run("should handle negative rate", func(t *testing.T) {
        result := CalculateProfit(10000, -0.001)
        if result != 0 {
            t.Errorf("expected 0 for negative rate, got %d", result)
        }
    })
}
```

### 4.5 表驱动测试模板（推荐）

```go
func TestFormatAmount(t *testing.T) {
    tests := []struct {
        name     string
        amount   int64
        expected string
    }{
        {"normal amount", 10000, "100.00"},
        {"zero", 0, "0.00"},
        {"small amount", 1, "0.01"},
        {"negative", -100, "-1.00"},
        {"large amount", 10000000, "100000.00"},
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            result := FormatAmount(tt.amount)
            if result != tt.expected {
                t.Errorf("FormatAmount(%d) = %s, want %s",
                    tt.amount, result, tt.expected)
            }
        })
    }
}
```

### 4.6 Service层测试模板（带Mock）

```go
package service

import (
    "context"
    "testing"
)

// Mock Repository
type MockWalletRepository struct {
    GetByAgentIDFunc func(ctx context.Context, agentID int64) (*models.Wallet, error)
    UpdateFunc       func(ctx context.Context, wallet *models.Wallet) error
}

func (m *MockWalletRepository) GetByAgentID(ctx context.Context, agentID int64) (*models.Wallet, error) {
    return m.GetByAgentIDFunc(ctx, agentID)
}

func (m *MockWalletRepository) Update(ctx context.Context, wallet *models.Wallet) error {
    return m.UpdateFunc(ctx, wallet)
}

func TestWalletService_GetBalance(t *testing.T) {
    t.Run("should return balance for valid agent", func(t *testing.T) {
        mockRepo := &MockWalletRepository{
            GetByAgentIDFunc: func(ctx context.Context, agentID int64) (*models.Wallet, error) {
                return &models.Wallet{Balance: 10000}, nil
            },
        }

        svc := NewWalletService(mockRepo)
        balance, err := svc.GetBalance(context.Background(), 1)

        if err != nil {
            t.Errorf("unexpected error: %v", err)
        }
        if balance != 10000 {
            t.Errorf("expected 10000, got %d", balance)
        }
    })

    t.Run("should return error for non-existent agent", func(t *testing.T) {
        mockRepo := &MockWalletRepository{
            GetByAgentIDFunc: func(ctx context.Context, agentID int64) (*models.Wallet, error) {
                return nil, errors.New("not found")
            },
        }

        svc := NewWalletService(mockRepo)
        _, err := svc.GetBalance(context.Background(), 999)

        if err == nil {
            t.Error("expected error, got nil")
        }
    })
}
```

### 4.7 Handler层测试模板

```go
package handler

import (
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
)

func TestWalletHandler_GetBalance(t *testing.T) {
    gin.SetMode(gin.TestMode)

    t.Run("should return 200 with balance", func(t *testing.T) {
        router := gin.New()

        mockService := &MockWalletService{
            GetBalanceFunc: func(ctx context.Context, agentID int64) (int64, error) {
                return 10000, nil
            },
        }

        handler := NewWalletHandler(mockService)
        router.GET("/wallet/balance", handler.GetBalance)

        req := httptest.NewRequest(http.MethodGet, "/wallet/balance", nil)
        w := httptest.NewRecorder()
        router.ServeHTTP(w, req)

        if w.Code != http.StatusOK {
            t.Errorf("expected status 200, got %d", w.Code)
        }
    })
}
```

### 4.8 Mock规范

- 使用接口进行依赖注入，便于mock
- Mock实现放在 `_test.go` 文件中
- 命名规范：`Mock<Interface>` 如 `MockWalletRepository`

---

## 五、PC端测试规范 (Vue3 + Vitest)

### 5.1 测试命令

```bash
cd web

# 运行测试（监听模式）
npm run test

# 单次运行测试
npm run test:run

# 查看覆盖率报告
npm run test:coverage
```

### 5.2 目录结构

```
web/src/
├── test-utils/
│   ├── index.ts          # 测试工具函数
│   └── setup.ts          # 全局测试设置
├── utils/__tests__/
│   └── format.test.ts    # 工具函数测试
├── stores/__tests__/
│   └── user.test.ts      # Store测试
└── components/__tests__/
    └── StatCard.test.ts  # 组件测试
```

### 5.3 测试文件命名规范

| 源文件 | 测试文件 |
|--------|----------|
| `src/utils/format.ts` | `src/utils/__tests__/format.test.ts` |
| `src/stores/user.ts` | `src/stores/__tests__/user.test.ts` |
| `src/components/StatCard.vue` | `src/components/__tests__/StatCard.test.ts` |

### 5.4 工具函数测试模板

```typescript
import { describe, it, expect } from 'vitest'
import { formatAmount } from '../format'

describe('formatAmount', () => {
  // ✅ 正常流程
  it('should format 100 cents to "1.00"', () => {
    expect(formatAmount(100)).toBe('1.00')
  })

  // ✅ 边界情况
  it('should handle zero', () => {
    expect(formatAmount(0)).toBe('0.00')
  })

  // ✅ 错误处理
  it('should handle negative values', () => {
    expect(formatAmount(-100)).toBe('-1.00')
  })

  // ✅ 特殊输入
  it('should format large numbers', () => {
    expect(formatAmount(10000000)).toBe('100,000.00')
  })
})
```

### 5.5 Store测试模板

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { setActivePinia, createPinia } from 'pinia'
import { useUserStore } from '../user'

// Mock API
vi.mock('@/api/auth', () => ({
  login: vi.fn(),
  logout: vi.fn(),
}))

describe('useUserStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
    vi.clearAllMocks()
  })

  it('should initialize with null user', () => {
    const store = useUserStore()
    expect(store.userInfo).toBeNull()
    expect(store.isLoggedIn).toBe(false)
  })
})
```

### 5.6 组件测试模板

```typescript
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import StatCard from '../Common/StatCard.vue'

describe('StatCard.vue', () => {
  it('should render title and value', () => {
    const wrapper = mount(StatCard, {
      props: { title: '今日交易', value: '1,234' },
      global: { stubs: { 'el-icon': true } },
    })
    expect(wrapper.text()).toContain('今日交易')
    expect(wrapper.text()).toContain('1,234')
  })
})
```

### 5.7 Mock规范

```typescript
// 使用 vi.mock 模拟模块
vi.mock('@/api/auth', () => ({
  login: vi.fn(),
  logout: vi.fn(),
}))

// 使用 vi.mocked 获取类型安全的 mock
vi.mocked(loginApi).mockResolvedValue(mockResponse)
```

---

## 六、APP端测试规范 (Flutter)

### 6.1 测试命令

```bash
cd mobileapp

# 运行所有测试
flutter test

# 运行指定目录测试
flutter test test/utils/

# 查看覆盖率
flutter test --coverage

# 生成覆盖率报告
genhtml coverage/lcov.info -o coverage/html
```

### 6.2 目录结构

```
mobileapp/test/
├── test_utils.dart           # 测试工具函数
├── mocks/
│   └── mock_dio.dart         # Dio Mock工具
├── utils/
│   └── format_test.dart      # 工具函数测试
├── providers/
│   └── xxx_provider_test.dart
├── widgets/
│   └── xxx_widget_test.dart
└── features/
    └── home/
        └── home_model_test.dart
```

### 6.3 测试文件命名规范

| 源文件 | 测试文件 |
|--------|----------|
| `lib/utils/format.dart` | `test/utils/format_test.dart` |
| `lib/features/home/domain/home_model.dart` | `test/features/home/home_model_test.dart` |

### 6.4 单元测试模板

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:xiangshoufu_app/utils/format.dart';

void main() {
  group('formatAmount', () {
    // ✅ 正常流程
    test('should format 100 cents to "1.00"', () {
      expect(formatAmount(100), equals('1.00'));
    });

    // ✅ 边界情况
    test('should handle zero', () {
      expect(formatAmount(0), equals('0.00'));
    });

    // ✅ 错误处理
    test('should handle negative values', () {
      expect(formatAmount(-100), equals('-1.00'));
    });
  });
}
```

### 6.5 Provider测试模板

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:mocktail/mocktail.dart';

class MockApi extends Mock implements SomeApi {}

void main() {
  late MockApi mockApi;
  late ProviderContainer container;

  setUp(() {
    mockApi = MockApi();
    container = ProviderContainer(overrides: [
      apiProvider.overrideWithValue(mockApi),
    ]);
  });

  tearDown(() {
    container.dispose();
  });

  test('should load data successfully', () async {
    when(() => mockApi.getData()).thenAnswer(
      (_) async => SomeData(value: 100),
    );

    final result = await container.read(dataProvider.future);
    expect(result.value, equals(100));
  });
}
```

### 6.6 Widget测试模板

```dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';

void main() {
  testWidgets('StatCard displays title and value', (tester) async {
    await tester.pumpWidget(
      const MaterialApp(
        home: Scaffold(
          body: StatCard(title: '今日交易', value: '1,234'),
        ),
      ),
    );

    expect(find.text('今日交易'), findsOneWidget);
    expect(find.text('1,234'), findsOneWidget);
  });
}
```

### 6.7 Mock规范

```dart
// 使用 mocktail 创建 Mock 类
class MockDio extends Mock implements Dio {}

// 设置 Mock 行为
when(() => mockDio.get('/api/data'))
    .thenAnswer((_) async => Response(data: mockData));
```

---

## 七、覆盖率目标

| 模块 | 最低覆盖率 |
|------|-----------|
| 后端 Service 层 | 80% |
| 后端 Handler 层 | 60% |
| 后端 Repository 层 | 50% |
| PC端 工具函数 | 90% |
| PC端 Store | 70% |
| PC端 组件 | 60% |
| APP端 工具函数 | 90% |
| APP端 Provider | 70% |
| APP端 Widget | 60% |

---

## 八、开发流程

### 8.1 TDD开发流程

```
1. 写测试 → 2. 运行测试（失败）→ 3. 写代码 → 4. 运行测试（通过）→ 5. 重构 → 6. 提交
```

### 8.2 Claude Code开发模板

**后端:**
```
请帮我实现[功能]，要求：
1. 先写单元测试，覆盖：正常流程、边界情况、错误处理
2. 再写实现代码
3. 确保 go test 通过
```

**PC端:**
```
请帮我实现[功能]，要求：
1. 先写单元测试，覆盖：正常流程、边界情况、错误处理
2. 再写实现代码
3. 确保 npm run test:run 通过
```

**APP端:**
```
请帮我实现[功能]，要求：
1. 先写单元测试，覆盖：正常流程、边界情况、错误处理
2. 再写实现代码
3. 确保 flutter test 通过
```

---

## 九、提交前检查清单

```bash
# 1. 后端测试
cd server && go test ./... -v

# 2. PC端测试
cd web && npm run test:run

# 3. APP端测试
cd mobileapp && flutter test

# 4. 全部通过后提交
git add . && git commit -m "feat: xxx"
```

---

## 十、常见问题

### Q: 测试文件放在哪里？
A:
- 后端：与源文件同目录，命名为 `xxx_test.go`
- PC端：`__tests__/` 子目录下
- APP端：`test/` 对应目录下

### Q: 如何Mock依赖？
A:
- 后端：定义接口 + 实现Mock结构体
- PC端：使用 `vi.mock()`
- APP端：使用 `mocktail` 包

### Q: 测试覆盖率不够怎么办？
A: 重点覆盖核心业务逻辑，边界情况和错误处理不能省略

### Q: 表驱动测试 vs 单独测试？
A: 推荐表驱动测试，代码更简洁，易于添加新用例
